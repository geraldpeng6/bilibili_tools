// ==UserScript==
// @name         Bilibili Tools
// @namespace    http://tampermonkey.net/
// @version      1.0.8
// @author       geraldpeng & claude 4.5 sonnet
// @description  å­—å¹•æå–ã€AIæ€»ç»“ã€Notioné›†æˆã€ç¬”è®°ä¿å­˜ã€æ’­æ”¾é€Ÿåº¦æ§åˆ¶ã€SponsorBlockå¹¿å‘Šè·³è¿‡ - å…­åˆä¸€å·¥å…·é›†
// @license      MIT
// @match        *://www.bilibili.com/*
// @match        *://search.bilibili.com/*
// @match        *://space.bilibili.com/*
// @match        *://*/*
// @require      https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js
// @connect      api.bilibili.com
// @connect      aisubtitle.hdslb.com
// @connect      api.notion.com
// @connect      openrouter.ai
// @connect      bsbsb.top
// @connect      *
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(function () {
	'use strict';

	const e=500,t=20,n=1500,o=500,i=500,s=2e3,r=2e3,a=500,l=12e4,c=2e3,d=1900,p=2e3,u=32,h="idle",g="loading",m="active",b="no-subtitle",f="error",y="subtitle:loaded",x="subtitle:failed",v="subtitle:requested",w="ai:summary:start",S="ai:summary:complete",k="ai:summary:failed",I="ai:summary:chunk",E="notion:send:start",C="notion:send:complete",A="notion:send:failed",M="ui:panel:toggle",T="ui:ball:status:change",L="video:changed",$="è¯·ç”¨ä¸­æ–‡æ€»ç»“ä»¥ä¸‹è§†é¢‘å­—å¹•å†…å®¹ï¼Œä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºã€‚\n\nè¦æ±‚ï¼š\n1. åœ¨å¼€å¤´æä¾›TL;DRçš„æ ¸å¿ƒæ‘˜è¦\n2. ä½¿ç”¨æ ‡é¢˜ã€åˆ—è¡¨ç­‰Markdownæ ¼å¼ç»„ç»‡å†…å®¹\n3. çªå‡ºå…³é”®ä¿¡æ¯å’Œè¦ç‚¹\n4. åˆ†æ®µè½è¯´æ˜æ¯ä¸€éƒ¨åˆ†çš„å†…å®¹\n5. ä¸è¦åœ¨æ€»ç»“ä¸­åŒ…å«ä»»ä½•æ—¶é—´æˆ³\n\nå­—å¹•å†…å®¹ï¼š\n",B='åˆ†æä»¥ä¸‹å¸¦æ—¶é—´æˆ³çš„å­—å¹•ï¼Œæå–5-8ä¸ªå…³é”®æ®µè½ã€‚\n\né‡è¦ï¼šä½ çš„å›å¤å¿…é¡»åªåŒ…å«JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–markdownæ ‡è®°ã€‚\nç›´æ¥ä»¥{å¼€å§‹ï¼Œä»¥}ç»“æŸã€‚\n\nJSONæ ¼å¼è¦æ±‚ï¼š\n{"segments":[\n  {"timestamp":"åˆ†é’Ÿ:ç§’","title":"æ ‡é¢˜(10å­—å†…)","summary":"å†…å®¹æ€»ç»“(30-50å­—)"}\n]}\n\nç¤ºä¾‹ï¼ˆä½ çš„å›å¤åº”è¯¥åƒè¿™æ ·ï¼‰ï¼š\n{"segments":[{"timestamp":"00:15","title":"å¼€åœºä»‹ç»","summary":"ä¸»æŒäººä»‹ç»ä»Šå¤©çš„ä¸»é¢˜å’Œå˜‰å®¾èƒŒæ™¯"},{"timestamp":"02:30","title":"æ ¸å¿ƒè§‚ç‚¹","summary":"è®¨è®ºæŠ€æœ¯å‘å±•è¶‹åŠ¿å’Œæœªæ¥å±•æœ›"}]}\n\nå­—å¹•å†…å®¹ï¼š\n',N={openrouter:"https://openrouter.ai/keys",openai:"https://platform.openai.com/api-keys",siliconflow:"https://cloud.siliconflow.cn/account/ak",deepseek:"https://platform.deepseek.com/api_keys",moonshot:"https://platform.moonshot.cn/console/api-keys",zhipu:"https://open.bigmodel.cn/usercenter/apikeys",yi:"https://platform.lingyiwanwu.com/apikeys",dashscope:"https://bailian.console.aliyun.com/",gemini:"https://aistudio.google.com/app/apikey"},P=[{id:"openrouter",name:"OpenRouter",url:"https://openrouter.ai/api/v1/chat/completions",apiKey:"",model:"alibaba/tongyi-deepresearch-30b-a3b:free",prompt1:$,prompt2:B,isOpenRouter:true},{id:"openai",name:"OpenAI",url:"https://api.openai.com/v1/chat/completions",apiKey:"",model:"gpt-3.5-turbo",prompt1:$,prompt2:B,isOpenRouter:false},{id:"siliconflow",name:"ç¡…åŸºæµåŠ¨",url:"https://api.siliconflow.cn/v1/chat/completions",apiKey:"",model:"Qwen/Qwen2.5-7B-Instruct",prompt1:$,prompt2:B,isOpenRouter:false},{id:"deepseek",name:"DeepSeek",url:"https://api.deepseek.com/v1/chat/completions",apiKey:"",model:"deepseek-chat",prompt1:$,prompt2:B,isOpenRouter:false},{id:"moonshot",name:"æœˆä¹‹æš—é¢ Kimi",url:"https://api.moonshot.cn/v1/chat/completions",apiKey:"",model:"moonshot-v1-8k",prompt1:$,prompt2:B,isOpenRouter:false},{id:"zhipu",name:"æ™ºè°±æ¸…è¨€",url:"https://open.bigmodel.cn/api/paas/v4/chat/completions",apiKey:"",model:"glm-4-flash",prompt1:$,prompt2:B,isOpenRouter:false},{id:"yi",name:"é›¶ä¸€ä¸‡ç‰©",url:"https://api.lingyiwanwu.com/v1/chat/completions",apiKey:"",model:"yi-large",prompt1:$,prompt2:B,isOpenRouter:false},{id:"dashscope",name:"é€šä¹‰åƒé—®",url:"https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",apiKey:"",model:"qwen-plus",prompt1:$,prompt2:B,isOpenRouter:false},{id:"gemini",name:"Google Gemini",url:"https://generativelanguage.googleapis.com/v1beta/openai/chat/completions",apiKey:"",model:"gemini-1.5-flash",prompt1:$,prompt2:B,isOpenRouter:false}],z="ai_configs",D="selected_ai_config_id",_="ai_auto_summary_enabled",q="notion_api_key",R="notion_parent_page_id",O="notion_database_id",F="notion_auto_send_enabled",H={BALL:2147483647,CONTAINER:2147483646,TOAST:2147483645,AI_MODAL:2147483643},j="2022-06-28",K="https://api.notion.com/v1",V=/\/video\/(BV[1-9A-Za-z]{10})/,U=/BV[1-9A-Za-z]{10}/,G=/([a-f0-9]{32}|[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/i,J="video",X=".bpx-player-container, #bilibili-player",Y=".bpx-player-ctrl-subtitle-result",W='.bpx-player-ctrl-subtitle-close-switch[data-action="close"]',Q="h1.video-title",Z={API_URL:"https://bsbsb.top/api/skipSegments",CACHE_EXPIRY:18e5,MIN_SCORE:.06,MIN_VIEWS:1e3,TAG_COLOR:"linear-gradient(135deg, #FF6B6B, #FF4D4D)",TAG_TEXT:"ğŸ”¥ ç²¾é€‰",TOP_TAG_COLOR:"linear-gradient(135deg, #FFD700, #FFA500)",TOP_TAG_TEXT:"ğŸ† é¡¶çº§",CATEGORIES:{sponsor:{name:"å¹¿å‘Š",color:"#00d400"},selfpromo:{name:"æ— å¿/è‡ªæˆ‘æ¨å¹¿",color:"#ffff00"},interaction:{name:"ä¸‰è¿/è®¢é˜…æé†’",color:"#cc00ff"},poi_highlight:{name:"ç²¾å½©æ—¶åˆ»/é‡ç‚¹",color:"#ff1684"},intro:{name:"è¿‡åœº/å¼€åœºåŠ¨ç”»",color:"#00ffff"},outro:{name:"é¸£è°¢/ç»“æŸç”»é¢",color:"#0202ed"},preview:{name:"å›é¡¾/æ¦‚è¦",color:"#008fd6"},filler:{name:"ç¦»é¢˜é—²èŠ/ç©ç¬‘",color:"#7300FF"},music_offtopic:{name:"éŸ³ä¹:ééŸ³ä¹éƒ¨åˆ†",color:"#ff9900"},exclusive_access:{name:"æŸ”æ€§æ¨å¹¿/å“ç‰Œåˆä½œ",color:"#008a5c"},mute:{name:"é™éŸ³ç‰‡æ®µ",color:"#B54D4B"}},DEFAULT_SETTINGS:{skipCategories:["sponsor"],showAdBadge:true,showQualityBadge:true,showProgressMarkers:true}},ee=`\n  /* ==================== å°çƒæ ·å¼ ==================== */\n  #subtitle-ball {\n    position: absolute;\n    right: -30px;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 20px;\n    height: 20px;\n    border-radius: 50%;\n    background-color: #999;\n    cursor: pointer;\n    z-index: ${H.BALL};\n    box-shadow: 0 2px 6px rgba(0,0,0,0.25);\n    transition: all 0.3s ease;\n    animation: breath-ball-normal 2s ease-in-out infinite;\n  }\n\n  #subtitle-ball:hover {\n    transform: translateY(-50%) scale(1.2);\n    box-shadow: 0 3px 10px rgba(0,0,0,0.35);\n  }\n\n  #subtitle-ball.active {\n    background-color: #feebea;\n    cursor: pointer;\n  }\n\n  #subtitle-ball.loading {\n    background-color: #3b82f6;\n    animation: breath-ball 1.2s ease-in-out infinite;\n  }\n\n  #subtitle-ball.ai-summarizing {\n    background-color: #feebea;\n    animation: breath-ball-ai 1s ease-in-out infinite;\n  }\n\n  #subtitle-ball.no-subtitle {\n    background-color: #999;\n    cursor: default;\n    opacity: 0.6;\n  }\n\n  #subtitle-ball.error {\n    background-color: #ff0000;\n    cursor: default;\n  }\n\n  @keyframes breath-ball-normal {\n    0%, 100% { transform: translateY(-50%) scale(1); }\n    50% { transform: translateY(-50%) scale(1.05); }\n  }\n\n  @keyframes breath-ball {\n    0%, 100% { transform: translateY(-50%) scale(1.1); opacity: 1; }\n    50% { transform: translateY(-50%) scale(1.4); opacity: 0.6; }\n  }\n\n  @keyframes breath-ball-ai {\n    0%, 100% { \n      transform: translateY(-50%) scale(1.3); \n      opacity: 1;\n      box-shadow: 0 0 20px rgba(254, 235, 234, 0.8);\n    }\n    50% { \n      transform: translateY(-50%) scale(1.8); \n      opacity: 0.7;\n      box-shadow: 0 0 40px rgba(254, 235, 234, 1);\n    }\n  }\n\n  /* ==================== å­—å¹•å®¹å™¨æ ·å¼ ==================== */\n  #subtitle-container {\n    position: absolute;\n    top: 10%;\n    left: 100%;\n    width: 500px;\n    min-width: 400px;\n    max-width: 800px;\n    height: 600px;\n    min-height: 400px;\n    max-height: 90vh;\n    background: rgba(0, 0, 0, 0.85);\n    backdrop-filter: blur(12px);\n    color: #fff;\n    border-radius: 12px;\n    font-size: 14px;\n    line-height: 1.8;\n    display: none;\n    flex-direction: column;\n    overflow: hidden;\n    box-shadow: -4px 0 24px rgba(0,0,0,0.5);\n    border: 1px solid rgba(254, 235, 234, 0.2);\n    transition: none;\n    z-index: ${H.CONTAINER};\n    margin-left: 10px;\n  }\n\n  #subtitle-container.show {\n    display: flex;\n  }\n  \n  /* è°ƒæ•´å¤§å°çš„è¾¹ç¼˜æ£€æµ‹åŒºåŸŸ */\n  #subtitle-container::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    pointer-events: none;\n  }\n  \n  /* é¼ æ ‡æ‚¬åœåœ¨è¾¹ç¼˜æ—¶çš„å…‰æ ‡æ ·å¼ */\n  #subtitle-container.resize-n { cursor: n-resize; }\n  #subtitle-container.resize-s { cursor: s-resize; }\n  #subtitle-container.resize-e { cursor: e-resize; }\n  #subtitle-container.resize-w { cursor: w-resize; }\n  #subtitle-container.resize-ne { cursor: ne-resize; }\n  #subtitle-container.resize-nw { cursor: nw-resize; }\n  #subtitle-container.resize-se { cursor: se-resize; }\n  #subtitle-container.resize-sw { cursor: sw-resize; }\n\n  /* ==================== å¤´éƒ¨æ ·å¼ ==================== */\n  .subtitle-header {\n    font-size: 14px;\n    font-weight: 500;\n    padding: 16px 20px;\n    border-bottom: 1px solid rgba(254, 235, 234, 0.15);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    cursor: move;\n    user-select: none;\n    flex-shrink: 0;\n    background: linear-gradient(135deg, rgba(254, 235, 234, 0.12), rgba(254, 235, 234, 0.06));\n    color: #fff;\n    border-radius: 12px 12px 0 0;\n    user-select: none;\n  }\n\n  .subtitle-header-left {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n  }\n\n  .subtitle-header-right {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    position: relative;\n    z-index: 10;\n  }\n\n  /* AIåŠ©æ‰‹å›¾æ ‡ - åˆ é™¤è¾¹æ¡†å’ŒèƒŒæ™¯ */\n\n  .subtitle-status-icon {\n    width: 20px;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .subtitle-status-text {\n    font-size: 13px;\n    font-weight: 500;\n    color: rgba(255, 255, 255, 0.9);\n  }\n\n  .subtitle-search-box {\n    position: relative;\n    flex: 1;\n    max-width: 300px;\n    margin: 0 8px; \n    color: rgba(255, 255, 255, 0.6);\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .subtitle-search-container {\n    position: relative;\n    display: flex;\n    align-items: center;\n    background: rgba(0, 0, 0, 0.2);\n    border-radius: 20px;\n    padding: 5px 12px;\n    border: 1px solid rgba(254, 235, 234, 0.15);\n    transition: all 0.2s;\n    width: 200px;\n  }\n\n  .subtitle-search-container:focus-within {\n    border-color: #feebea;\n    background: rgba(0, 0, 0, 0.4);\n    box-shadow: 0 0 0 2px rgba(254, 235, 234, 0.1);\n  }\n\n  .search-input {\n    flex: 1;\n    background: transparent;\n    border: none;\n    outline: none;\n    color: #fff;\n    font-size: 14px;\n    padding: 4px;\n    padding-right: 70px;\n  }\n\n  .search-input::placeholder {\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .search-controls {\n    position: absolute;\n    right: 8px;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .search-counter {\n    font-size: 11px;\n    color: rgba(255, 255, 255, 0.6);\n    min-width: 28px;\n    text-align: center;\n  }\n\n  .search-nav-btn {\n    background: transparent;\n    border: none;\n    color: rgba(255, 255, 255, 0.6);\n    cursor: pointer;\n    padding: 2px;\n    transition: all 0.2s;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 4px;\n  }\n\n  .search-nav-btn:hover {\n    color: #fff;\n    background: rgba(255, 255, 255, 0.1);\n  }\n\n  .search-nav-btn:active {\n    transform: scale(0.9);\n  }\n\n  .search-nav-btn:disabled {\n    opacity: 0.3;\n    cursor: not-allowed;\n  }\n  \n  .search-nav-btn svg {\n    display: block;\n  }\n\n  /* æœç´¢é«˜äº®æ ·å¼ */\n  .search-highlight {\n    background-color: rgba(255, 255, 0, 0.4);\n    color: #000;\n    padding: 2px 0;\n    border-radius: 2px;\n  }\n\n  .search-highlight-current {\n    background-color: rgba(255, 165, 0, 0.6);\n    color: #000;\n    padding: 2px 0;\n    border-radius: 2px;\n    box-shadow: 0 0 4px rgba(255, 165, 0, 0.8);\n  }\n\n  .subtitle-header-actions {\n    display: flex;\n    gap: 12px;\n    align-items: center;\n  }\n\n  .subtitle-close {\n    cursor: pointer;\n    font-size: 20px;\n    line-height: 1;\n    color: rgba(255, 255, 255, 0.5);\n    transition: all 0.2s;\n    padding: 4px;\n    border-radius: 4px;\n  }\n\n  .subtitle-close:hover {\n    color: rgba(255, 255, 255, 0.9);\n    background: rgba(255, 255, 255, 0.1);\n  }\n\n  /* ==================== æ ‡ç­¾é¡µæ ·å¼ ==================== */\n  .subtitle-tabs {\n    display: flex;\n    padding: 0 20px;\n    gap: 20px;\n    border-bottom: 1px solid rgba(254, 235, 234, 0.1);\n    background: rgba(0, 0, 0, 0.2);\n  }\n\n  .subtitle-tab {\n    position: relative;\n    padding: 12px 4px;\n    color: rgba(255, 255, 255, 0.6);\n    font-size: 14px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s;\n    user-select: none;\n  }\n\n  .subtitle-tab:hover {\n    color: rgba(255, 255, 255, 0.9);\n  }\n\n  .subtitle-tab.active {\n    color: #fff;\n  }\n\n  .subtitle-tab.active::after {\n    content: '';\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    height: 2px;\n    background: linear-gradient(90deg, #feebea, rgba(254, 235, 234, 0.6));\n    border-radius: 2px 2px 0 0;\n  }\n\n  /* ==================== å†…å®¹åŒºåŸŸæ ·å¼ ==================== */\n  .subtitle-content {\n    flex: 1;\n    overflow-y: auto;\n    overflow-x: hidden;\n    height: calc(100% - 120px);\n  }\n\n  .subtitle-panel {\n    padding: 20px;\n    height: 100%;\n    overflow-y: visible;\n  }\n\n  .subtitle-content::-webkit-scrollbar {\n    width: 6px;\n  }\n\n  .subtitle-content::-webkit-scrollbar-thumb {\n    background-color: rgba(254, 235, 234, 0.4);\n    border-radius: 3px;\n  }\n  \n  .subtitle-content::-webkit-scrollbar-thumb:hover {\n    background-color: rgba(254, 235, 234, 0.6);\n  }\n  \n  .subtitle-content::-webkit-scrollbar-track {\n    background-color: rgba(255, 255, 255, 0.05);\n  }\n\n  /* ==================== å­—å¹•åˆ—è¡¨æ ·å¼ ==================== */\n  .subtitle-toggle-btn {\n    padding: 8px 12px;\n    margin-bottom: 15px;\n    background: rgba(255, 255, 255, 0.1);\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 8px;\n    color: #fff;\n    cursor: pointer;\n    font-size: 16px;\n    transition: all 0.2s;\n    display: flex;\n    align-items: center;\n    justify-content: flex-start;\n    width: 100%;\n    height: auto;\n  }\n\n  .subtitle-toggle-btn:hover {\n    background: rgba(254, 235, 234, 0.2);\n    border-color: #feebea;\n    transform: scale(1.05);\n  }\n\n  .subtitle-toggle-icon {\n    transition: transform 0.3s ease;\n    display: inline-block;\n    font-size: 12px;\n  }\n\n  .subtitle-toggle-btn.expanded .subtitle-toggle-icon {\n    transform: rotate(90deg);\n  }\n\n  .subtitle-list-container {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n    height: auto;\n    overflow-y: visible;\n    padding: 16px;\n    position: relative;\n  }\n\n  .subtitle-item {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    margin-bottom: 2px;\n    padding: 6px 10px;\n    border-radius: 6px;\n    transition: all 0.2s;\n    cursor: pointer;\n    background: rgba(255, 255, 255, 0.05);\n    border: 1px solid rgba(254, 235, 234, 0.2);\n    position: relative;\n  }\n\n  .subtitle-item:hover {\n    background: rgba(254, 235, 234, 0.15);\n    border-color: #feebea;\n    transform: translateX(4px);\n    box-shadow: 0 2px 8px rgba(254, 235, 234, 0.2);\n  }\n\n  .subtitle-item.current {\n    background: rgba(254, 235, 234, 0.2) !important;\n    border-left: 3px solid #ff69b4;\n    padding-left: 9px;\n    box-shadow: 0 2px 8px rgba(255, 105, 180, 0.2);\n    animation: subtitleHighlight 1.5s ease infinite;\n  }\n  \n  @keyframes subtitleHighlight {\n    0%, 100% {\n      box-shadow: 0 2px 8px rgba(255, 105, 180, 0.2);\n    }\n    50% {\n      box-shadow: 0 2px 12px rgba(255, 105, 180, 0.4);\n    }\n  }\n\n  .subtitle-time {\n    color: rgba(255, 255, 255, 0.6);\n    font-size: 11px;\n    font-weight: 600;\n    flex-shrink: 0;\n    min-width: 42px;\n  }\n\n  .subtitle-text {\n    color: #e5e7eb;\n    font-size: 14px;\n    line-height: 1.5;\n    flex: 1;\n  }\n\n  /* ==================== AIå›¾æ ‡æ ·å¼ ==================== */\n  .ai-icon {\n    cursor: pointer;\n    width: 24px;\n    height: 24px;\n    opacity: 0.7;\n    transition: opacity 0.2s, transform 0.2s;\n  }\n\n  .ai-icon:hover {\n    opacity: 1;\n    transform: scale(1.1);\n  }\n\n  .ai-icon.loading {\n    animation: breath-ai 1.2s ease-in-out infinite;\n    pointer-events: none;\n  }\n\n  .ai-icon.disabled {\n    opacity: 0.3;\n    pointer-events: none;\n    cursor: not-allowed;\n  }\n\n  @keyframes breath-ai {\n    0%, 100% { transform: scale(1.05); opacity: 1; }\n    50% { transform: scale(1.35); opacity: 0.5; }\n  }\n\n  /* ==================== ä¸‹è½½å›¾æ ‡æ ·å¼ ==================== */\n  .download-icon {\n    cursor: pointer;\n    width: 20px;\n    height: 20px;\n    opacity: 0.7;\n    transition: opacity 0.2s, transform 0.2s;\n  }\n\n  .download-icon:hover {\n    opacity: 1;\n    transform: scale(1.1);\n  }\n\n  /* ==================== Notionå›¾æ ‡æ ·å¼ ==================== */\n  .notion-icon {\n    cursor: pointer;\n    width: 24px;\n    height: 24px;\n    opacity: 0.7;\n    transition: opacity 0.2s, transform 0.2s;\n  }\n\n  .notion-icon:hover {\n    opacity: 1;\n    transform: scale(1.1);\n  }\n\n  .notion-icon.loading {\n    animation: breath-notion 1.2s ease-in-out infinite;\n  }\n\n  @keyframes breath-notion {\n    0%, 100% { transform: scale(1.05); opacity: 1; }\n    50% { transform: scale(1.35); opacity: 0.5; }\n  }\n\n  /* ==================== Toastæç¤ºæ ·å¼ ==================== */\n  .notion-toast {\n    position: fixed;\n    top: 80px;\n    left: 50%;\n    transform: translateX(-50%);\n    background-color: rgba(0, 0, 0, 0.85);\n    color: white;\n    padding: 12px 24px;\n    border-radius: 8px;\n    font-size: 14px;\n    z-index: ${H.TOAST};\n    opacity: 0;\n    transition: opacity 0.3s;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n  }\n\n  .notion-toast.show {\n    opacity: 1;\n  }\n\n  /* ==================== AIæ€»ç»“æ ·å¼ ==================== */\n  .ai-summary-tips {\n    padding: 10px 16px;\n    background: rgba(254, 235, 234, 0.08);\n    border-radius: 8px;\n    color: rgba(255, 255, 255, 0.5);\n    font-size: 12px;\n    margin-bottom: 16px;\n  }\n\n  .ai-summary-main {\n    padding: 16px;\n    background: rgba(0, 0, 0, 0.2);\n    border-radius: 12px;\n    margin-bottom: 20px;\n    border: 1px solid rgba(255, 255, 255, 0.08);\n  }\n  \n  .summary-title {\n    font-size: 14px;\n    font-weight: bold;\n    color: rgba(255, 255, 255, 0.9);\n    margin-bottom: 12px;\n    padding-bottom: 8px;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n  \n  .summary-content {\n    font-size: 14px;\n    line-height: 1.8;\n    color: rgba(255, 255, 255, 0.85);\n    overflow-y: visible;\n    overflow-x: hidden;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    word-break: break-word;\n  }\n  \n  /* æ»šåŠ¨æ¡æ ·å¼å·²ç»Ÿä¸€ç”± .subtitle-content ç®¡ç† */\n  \n  /* Markdownæ ·å¼ - æ€»ç»“åŒºåŸŸ */\n  .summary-content h1,\n  .summary-content h2,\n  .summary-content h3,\n  .summary-content h4,\n  .summary-content h5,\n  .summary-content h6 {\n    color: rgba(255, 255, 255, 0.9) !important;\n    margin-top: 12px;\n    margin-bottom: 8px;\n    font-weight: 600;\n  }\n  \n  .summary-content h1 { font-size: 18px; }\n  .summary-content h2 { font-size: 16px; }\n  .summary-content h3 { font-size: 15px; }\n  .summary-content h4 { font-size: 14px; }\n  \n  .summary-content p {\n    margin: 8px 0;\n    color: rgba(255, 255, 255, 0.85);\n  }\n  \n  .summary-content ul,\n  .summary-content ol {\n    margin: 8px 0;\n    padding-left: 20px;\n    color: rgba(255, 255, 255, 0.85);\n  }\n  \n  .summary-content li {\n    margin: 4px 0;\n  }\n  \n  .summary-content strong {\n    color: rgba(255, 255, 255, 0.95);\n    font-weight: 600;\n  }\n  \n  .summary-content code {\n    background: rgba(255, 255, 255, 0.1);\n    color: #feebea;\n    padding: 2px 4px;\n    border-radius: 3px;\n    font-size: 13px;\n  }\n  \n  .summary-content blockquote {\n    border-left: 3px solid #feebea;\n    background: rgba(254, 235, 234, 0.05);\n    padding: 8px 12px;\n    margin: 8px 0;\n    color: rgba(255, 255, 255, 0.8);\n  }\n\n  .ai-summary-outline {\n    margin-bottom: 20px;\n  }\n\n  .progress-switch {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px 16px;\n    background: rgba(0, 0, 0, 0.15);\n    border-radius: 8px;\n    margin-bottom: 16px;\n    border: 1px solid rgba(254, 235, 234, 0.1);\n  }\n  \n  .progress-switch span {\n    font-size: 14px;\n    font-weight: 500;\n    color: rgba(255, 255, 255, 0.8);\n  }\n\n  .switch-btn {\n    width: 40px;\n    height: 22px;\n    background: rgba(255, 255, 255, 0.1);\n    border-radius: 11px;\n    position: relative;\n    cursor: pointer;\n    transition: all 0.3s;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .switch-btn.on {\n    background: rgba(254, 235, 234, 0.3);\n    border-color: #feebea;\n  }\n\n  .switch-block {\n    width: 16px;\n    height: 16px;\n    background: #fff;\n    border-radius: 50%;\n    position: absolute;\n    top: 2px;\n    left: 2px;\n    transition: all 0.3s;\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n  }\n\n  .switch-btn.on .switch-block {\n    transform: translateX(18px);\n  }\n\n  .ai-summary-sections {\n    padding: 0;\n  }\n\n  .summary-section {\n    margin-bottom: 20px;\n  }\n\n  .section-title {\n    font-size: 14px;\n    font-weight: 600;\n    color: #fff;\n    margin-bottom: 12px;\n    padding: 8px 12px;\n    background: rgba(254, 235, 234, 0.08);\n    border-radius: 8px;\n    border-left: 3px solid #feebea;\n  }\n\n  .section-items {\n    padding: 0;\n  }\n\n  .section-item {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 10px;\n    background: rgba(255, 255, 255, 0.03);\n    border-radius: 6px;\n    border: 1px solid rgba(254, 235, 234, 0.1);\n    margin-bottom: 8px;\n    transition: all 0.2s ease;\n    position: relative;\n    cursor: pointer; /* æ·»åŠ é¼ æ ‡æŒ‡é’ˆæ ·å¼ï¼Œè¡¨ç¤ºå¯ç‚¹å‡» */\n    user-select: none; /* ç¦æ­¢æ–‡å­—é€‰æ‹©ï¼Œé˜²æ­¢ä¸ç¬”è®°åŠŸèƒ½å†²çª */\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    -ms-user-select: none;\n  }\n  \n  .section-item:hover {\n    background: rgba(254, 235, 234, 0.15);\n    border-color: #feebea;\n    transform: translateX(4px);\n    box-shadow: 0 2px 8px rgba(254, 235, 234, 0.2); /* æ·»åŠ é˜´å½±æ•ˆæœ */\n  }\n  \n  .section-item:active {\n    transform: translateX(2px) scale(0.98); /* ç‚¹å‡»æ—¶çš„åé¦ˆ */\n  }\n  \n  .section-item.clicked {\n    animation: segmentClick 0.3s ease;\n  }\n  \n  @keyframes segmentClick {\n    0% {\n      transform: scale(1);\n      background: rgba(254, 235, 234, 0.05);\n    }\n    50% {\n      transform: scale(0.98);\n      background: rgba(254, 235, 234, 0.3);\n      box-shadow: 0 0 10px rgba(254, 235, 234, 0.5);\n    }\n    100% {\n      transform: scale(1);\n      background: rgba(254, 235, 234, 0.05);\n    }\n  }\n  \n  .ai-segments-section .section-item {\n    cursor: pointer;\n  }\n  \n  .ai-segments-section .section-item:hover {\n    background: rgba(254, 235, 234, 0.2);\n  }\n  \n  .segment-item {\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n  \n  .segment-item:hover {\n    background: rgba(254, 235, 234, 0.1);\n    transform: translateX(2px);\n  }\n\n  .time-btn {\n    padding: 2px 6px;\n    background: transparent;\n    border: none;\n    color: rgba(255, 255, 255, 0.6);\n    font-size: 11px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.2s;\n    flex-shrink: 0;\n    min-width: 42px;\n    text-align: left;\n  }\n\n  .time-btn:hover {\n    color: #feebea;\n  }\n\n  .item-content {\n    flex: 1;\n    color: #e5e7eb;\n    font-size: 14px;\n    line-height: 1.5;\n    display: flex;\n    flex-direction: column;\n    gap: 2px;\n  }\n\n  .item-title {\n    font-size: 14px;\n    font-weight: 500;\n    color: rgba(255, 255, 255, 0.9);\n  }\n\n  .item-desc {\n    font-size: 12px;\n    line-height: 1.5;\n    color: rgba(255, 255, 255, 0.65);\n  }\n  \n  .item-single {\n    font-size: 14px;\n    color: #e5e7eb;\n  }\n\n  .ai-segments-section,\n  .original-subtitles-section,\n  .ai-segments-in-summary {\n    margin-bottom: 12px;\n  }\n  \n  .summary-panel-container {\n    height: auto;\n    overflow-y: visible;\n    overflow-x: hidden;\n    padding: 12px;\n  }\n  \n  /* æ»šåŠ¨æ¡æ ·å¼å·²ç§»åˆ° .subtitle-content */\n  \n  .ai-segments-in-summary {\n    background: #2a2a2a;\n    border-radius: 8px;\n    padding: 8px;\n  }\n\n  .segments-header {\n    font-size: 13px;\n    font-weight: 600;\n    color: rgba(255, 255, 255, 0.7);\n    padding: 8px 12px;\n    margin-bottom: 8px;\n    background: rgba(0, 0, 0, 0.2);\n    border-radius: 8px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n\n  .segments-divider {\n    height: 1px;\n    background: rgba(255, 255, 255, 0.1);\n    margin: 16px 0;\n  }\n\n  .ai-summary-main {\n    padding-top: 8px;\n  }\n\n  .ai-summary-empty {\n    padding: 60px 20px;\n    text-align: center;\n    color: rgba(255, 255, 255, 0.4);\n    font-size: 14px;\n  }\n\n  .ai-summary-content {\n    color: #e5e7eb;\n    font-size: 14px;\n    line-height: 1.7;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    word-break: break-word;\n    white-space: normal;\n    max-width: 100%;\n  }\n\n  .ai-summary-loading {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    padding: 60px 20px;\n    color: rgba(255, 255, 255, 0.6);\n  }\n\n  .loading-spinner {\n    width: 40px;\n    height: 40px;\n    border: 3px solid rgba(254, 235, 234, 0.1);\n    border-top-color: #feebea;\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n    margin-bottom: 16px;\n  }\n\n  @keyframes spin {\n    to { transform: rotate(360deg); }\n  }\n\n  /* ==================== Markdownæ ·å¼ ==================== */\n  .ai-summary-content h1,\n  .ai-summary-content h2,\n  .ai-summary-content h3 {\n    color: #fff;\n    margin-top: 12px;\n    margin-bottom: 8px;\n    font-weight: 700;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n  }\n\n  .ai-summary-content h1 { font-size: 17px; }\n  .ai-summary-content h2 { font-size: 16px; }\n  .ai-summary-content h3 { font-size: 15px; }\n\n  .ai-summary-content ul,\n  .ai-summary-content ol {\n    margin: 8px 0;\n    padding-left: 20px;\n    max-width: 100%;\n  }\n\n  .ai-summary-content li {\n    margin: 4px 0;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    word-break: break-word;\n  }\n\n  .ai-summary-content p {\n    margin: 8px 0;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    word-break: break-word;\n    white-space: normal;\n  }\n\n  .ai-summary-content code {\n    background: rgba(255, 255, 255, 0.1);\n    color: #feebea;\n    padding: 3px 6px;\n    border-radius: 4px;\n    font-family: 'Courier New', monospace;\n    font-size: 13px;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .ai-summary-content pre {\n    background: rgba(0, 0, 0, 0.5);\n    padding: 12px;\n    border-radius: 8px;\n    overflow-x: auto;\n    margin: 10px 0;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    max-width: 100%;\n  }\n\n  .ai-summary-content pre code {\n    background-color: transparent;\n    padding: 0;\n    border: none;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n  }\n\n  .ai-summary-content blockquote {\n    border-left: 4px solid #feebea;\n    background: rgba(254, 235, 234, 0.1);\n    padding: 12px;\n    padding-left: 16px;\n    margin: 10px 0;\n    border-radius: 4px;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n  }\n\n  .ai-summary-content strong {\n    color: #fff;\n    font-weight: 700;\n  }\n\n  .ai-summary-content a {\n    color: #feebea;\n    text-decoration: underline;\n    font-weight: 600;\n  }\n  \n  .ai-summary-content a:hover {\n    color: #fff;\n  }\n\n  /* ==================== é…ç½®æ¨¡æ€æ¡†æ ·å¼ ==================== */\n  .config-modal {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(0, 0, 0, 0.7);\n    z-index: ${H.AI_MODAL};\n    display: none;\n    align-items: center;\n    justify-content: center;\n  }\n\n  .config-modal.show {\n    display: flex;\n  }\n  \n  /* é…ç½®æ¨¡æ€æ¡†overlayæ ·å¼ï¼ˆç”¨äºå¿«æ·é”®é…ç½®ç­‰ï¼‰ */\n  .config-modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(0, 0, 0, 0.7);\n    z-index: ${H.AI_MODAL};\n    display: none;\n    align-items: center;\n    justify-content: center;\n  }\n  \n  .config-modal-overlay.show {\n    display: flex;\n  }\n  \n  /* å¿«æ·é”®é…ç½®æ¨¡æ€æ¡† */\n  #shortcut-config-modal {\n    background: rgba(0, 0, 0, 0.85);\n    backdrop-filter: blur(12px);\n    border-radius: 16px;\n    padding: 0;\n    width: 600px;\n    max-width: 90%;\n    max-height: 85vh;\n    overflow: hidden;\n    box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n    color: #fff;\n    display: flex;\n    flex-direction: column;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .config-modal-content {\n    background: rgba(0, 0, 0, 0.85);\n    backdrop-filter: blur(12px);\n    border-radius: 16px;\n    padding: 0;\n    width: 700px;\n    max-width: 90%;\n    max-height: 85vh;\n    overflow: hidden;\n    box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n    color: #fff;\n    display: flex;\n    flex-direction: column;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .config-modal-header {\n    padding: 24px;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    background: rgba(254, 235, 234, 0.15);\n    border-bottom: 1px solid rgba(254, 235, 234, 0.2);\n    border-radius: 16px 16px 0 0;\n  }\n  \n  .config-modal-title {\n    font-size: 20px;\n    font-weight: 700;\n    color: white;\n  }\n  \n  .config-modal-close {\n    width: 32px;\n    height: 32px;\n    border-radius: 50%;\n    background: transparent;\n    border: none;\n    color: rgba(255, 255, 255, 0.7);\n    font-size: 24px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s;\n  }\n  \n  .config-modal-close:hover {\n    background: rgba(255, 255, 255, 0.1);\n    color: rgba(255, 255, 255, 0.9);\n  }\n  \n  .config-modal-body {\n    flex: 1;\n    overflow-y: auto;\n    padding: 30px;\n    background-color: transparent;\n  }\n\n  .config-field {\n    margin-bottom: 20px;\n  }\n\n  .config-field label {\n    display: block;\n    margin-bottom: 10px;\n    font-weight: 600;\n    color: #e5e7eb;\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    gap: 6px;\n  }\n  \n  .config-field label::before {\n    content: 'â€¢';\n    color: #feebea;\n    font-size: 18px;\n    font-weight: bold;\n  }\n\n  .config-field input,\n  .config-field textarea {\n    width: 100%;\n    padding: 12px 14px;\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 10px;\n    font-size: 14px;\n    box-sizing: border-box;\n    transition: all 0.2s;\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n  }\n\n  .config-field input:hover,\n  .config-field textarea:hover {\n    background: rgba(255, 255, 255, 0.12);\n    border-color: rgba(254, 235, 234, 0.5);\n  }\n\n  .config-field input:focus,\n  .config-field textarea:focus {\n    outline: none;\n    border-color: #feebea;\n    box-shadow: 0 0 0 3px rgba(254, 235, 234, 0.15);\n    background: rgba(255, 255, 255, 0.15);\n  }\n\n  .config-field input::placeholder,\n  .config-field textarea::placeholder {\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .config-field textarea {\n    font-family: inherit;\n    resize: vertical;\n    min-height: 120px;\n    line-height: 1.6;\n  }\n  \n  .config-field input[type="checkbox"] {\n    width: auto;\n    margin-right: 8px;\n    cursor: pointer;\n  }\n\n  .config-help {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.6);\n    margin-top: 5px;\n  }\n\n  .config-help a {\n    color: #feebea;\n    text-decoration: underline;\n  }\n\n  .config-help code {\n    background-color: rgba(255, 255, 255, 0.1);\n    padding: 2px 6px;\n    border-radius: 3px;\n    font-family: 'Courier New', monospace;\n    font-size: 11px;\n    color: #fff;\n  }\n\n  .config-help strong {\n    color: #feebea;\n  }\n\n  .config-footer {\n    display: flex;\n    gap: 12px;\n    justify-content: flex-end;\n    padding: 20px 30px;\n    background-color: rgba(0, 0, 0, 0.3);\n    border-top: 1px solid rgba(254, 235, 234, 0.2);\n    border-radius: 0 0 16px 16px;\n  }\n\n  .config-btn {\n    padding: 12px 24px;\n    border: none;\n    border-radius: 10px;\n    font-size: 14px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.2s;\n    position: relative;\n    overflow: hidden;\n  }\n\n  .config-btn::before {\n    content: '';\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    width: 0;\n    height: 0;\n    border-radius: 50%;\n    background: rgba(255, 255, 255, 0.3);\n    transform: translate(-50%, -50%);\n    transition: width 0.6s, height 0.6s;\n  }\n\n  .config-btn:hover::before {\n    width: 300px;\n    height: 300px;\n  }\n\n  .config-btn-primary {\n    background: linear-gradient(135deg, #feebea 0%, #2d2d2d 100%);\n    color: #fff;\n    box-shadow: 0 4px 12px rgba(254, 235, 234, 0.3);\n  }\n\n  .config-btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 6px 20px rgba(254, 235, 234, 0.4);\n  }\n\n  .config-btn-primary:active {\n    transform: translateY(0);\n  }\n\n  .config-btn-secondary {\n    background-color: #f3f4f6;\n    color: #6b7280;\n    border: 2px solid #e5e7eb;\n  }\n\n  .config-btn-secondary:hover {\n    background-color: #e5e7eb;\n    color: #374151;\n    border-color: #d1d5db;\n  }\n\n  .config-btn-danger {\n    background-color: #fee2e2;\n    color: #dc2626;\n    border: 2px solid #fecaca;\n  }\n\n  .config-btn-danger:hover {\n    background-color: #dc2626;\n    color: white;\n    border-color: #dc2626;\n  }\n\n  .config-status {\n    padding: 8px 12px;\n    border-radius: 6px;\n    font-size: 12px;\n    margin-top: 10px;\n  }\n\n  .config-status.success {\n    background-color: #d4edda;\n    color: #155724;\n  }\n\n  .config-status.error {\n    background-color: #f8d7da;\n    color: #721c24;\n  }\n\n  /* ==================== AIé…ç½®åˆ—è¡¨æ ·å¼ ==================== */\n  .ai-config-list {\n    margin-bottom: 25px;\n    display: grid;\n    grid-template-columns: repeat(2, 1fr);\n    gap: 10px;\n  }\n\n  .ai-config-item {\n    padding: 10px 14px;\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 10px;\n    margin-bottom: 0;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    cursor: pointer;\n    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    background: rgba(255, 255, 255, 0.05);\n    position: relative;\n    overflow: hidden;\n  }\n\n  .ai-config-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    height: 100%;\n    width: 4px;\n    background: linear-gradient(135deg, #feebea 0%, #ffdbdb 100%);\n    transform: scaleY(0);\n    transition: transform 0.3s ease;\n  }\n\n  .ai-config-item:hover {\n    background: rgba(254, 235, 234, 0.15);\n    border-color: #feebea;\n    transform: translateX(4px);\n    box-shadow: 0 4px 12px rgba(254, 235, 234, 0.2);\n  }\n\n  .ai-config-item:hover::before {\n    transform: scaleY(1);\n  }\n\n  .ai-config-item.selected {\n    border-color: #feebea;\n    background: rgba(254, 235, 234, 0.2);\n    box-shadow: 0 4px 16px rgba(254, 235, 234, 0.3);\n  }\n\n  .ai-config-item.selected::before {\n    transform: scaleY(1);\n    width: 4px;\n  }\n\n  .ai-config-item-name {\n    font-weight: 600;\n    font-size: 14px;\n    color: #e5e7eb;\n  }\n\n  .ai-config-item.selected .ai-config-item-name {\n    color: #fff;\n    font-weight: 700;\n  }\n\n  .ai-config-item-actions {\n    display: flex;\n    gap: 8px;\n    z-index: 1;\n  }\n\n  .ai-config-btn-small {\n    padding: 4px 12px;\n    font-size: 12px;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    transition: all 0.2s;\n    font-weight: 500;\n  }\n\n  .ai-config-btn-small:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n  }\n\n  .ai-config-btn-small.config-btn-primary {\n    background: linear-gradient(135deg, #feebea 0%, #2d2d2d 100%);\n    color: white;\n  }\n\n  .ai-config-btn-small.config-btn-secondary {\n    background-color: #f3f4f6;\n    color: #6b7280;\n  }\n\n  .ai-config-btn-small.config-btn-secondary:hover {\n    background-color: #fee2e2;\n    color: #dc2626;\n  }\n\n  .ai-config-form {\n    border-top: 1px solid rgba(254, 235, 234, 0.2);\n    padding-top: 25px;\n    margin-top: 10px;\n    background: rgba(0, 0, 0, 0.3);\n    padding: 25px;\n    border-radius: 12px;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .ai-config-form.hidden {\n    display: none;\n  }\n\n  .ai-config-form .config-field {\n    margin-bottom: 20px;\n  }\n\n  /* ==================== æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ ==================== */\n  .model-select-wrapper {\n    margin-top: 8px;\n    position: relative;\n  }\n\n  .model-search-input {\n    width: 100%;\n    padding: 10px;\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 6px;\n    font-size: 14px;\n    box-sizing: border-box;\n    margin-bottom: 8px;\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n  }\n\n  .model-search-input:focus {\n    outline: none;\n    border-color: #feebea;\n    box-shadow: 0 0 0 3px rgba(254, 235, 234, 0.15);\n    background: rgba(255, 255, 255, 0.15);\n  }\n\n  .model-search-input::placeholder {\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .model-select-wrapper select {\n    width: 100%;\n    padding: 10px;\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 6px;\n    font-size: 14px;\n    box-sizing: border-box;\n    max-height: 200px;\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n  }\n\n  .model-select-wrapper select option {\n    padding: 8px;\n    background: rgba(0, 0, 0, 0.9);\n    color: #fff;\n  }\n\n  .model-count-badge {\n    display: inline-block;\n    background: #feebea;\n    color: #1a1a1a;\n    padding: 2px 8px;\n    border-radius: 12px;\n    font-size: 12px;\n    margin-left: 8px;\n    font-weight: 600;\n  }\n\n  .model-field-with-button {\n    display: flex;\n    gap: 8px;\n    align-items: center;\n  }\n\n  .model-field-with-button input {\n    flex: 1;\n  }\n\n  .fetch-models-btn {\n    padding: 12px 20px;\n    font-size: 14px;\n    font-weight: 600;\n    border: none;\n    border-radius: 10px;\n    background: linear-gradient(135deg, #feebea 0%, #2d2d2d 100%);\n    color: white;\n    cursor: pointer;\n    white-space: nowrap;\n    transition: all 0.2s;\n    box-shadow: 0 2px 8px rgba(254, 235, 234, 0.3);\n  }\n\n  .fetch-models-btn:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 4px 12px rgba(254, 235, 234, 0.4);\n  }\n\n  .fetch-models-btn:active {\n    transform: translateY(0);\n  }\n\n  .fetch-models-btn:disabled {\n    opacity: 0.6;\n    cursor: not-allowed;\n    transform: none !important;\n    box-shadow: none;\n  }\n\n  /* ==================== é€Ÿåº¦æ§åˆ¶æ ·å¼ ==================== */\n  .speed-control-section {\n    padding: 12px;\n    margin-bottom: 15px;\n    background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);\n    border-radius: 12px;\n    border: 2px solid rgba(254, 235, 234, 0.5);\n  }\n\n  .speed-control-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 10px;\n    padding-bottom: 8px;\n    border-bottom: 2px solid rgba(254, 235, 234, 0.5);\n  }\n\n  .speed-control-title {\n    font-size: 14px;\n    font-weight: 700;\n    color: #2d2d2d;\n  }\n\n  .speed-control-display {\n    font-size: 16px;\n    font-weight: 700;\n    color: #1a1a1a;\n    font-family: monospace;\n  }\n\n  .speed-control-buttons {\n    display: flex;\n    gap: 8px;\n    margin-bottom: 10px;\n  }\n\n  .speed-btn {\n    flex: 1;\n    padding: 8px;\n    border: 2px solid #e5e7eb;\n    border-radius: 8px;\n    background: white;\n    color: #1a1a1a;\n    cursor: pointer;\n    font-size: 14px;\n    font-weight: 600;\n    transition: all 0.2s;\n  }\n\n  .speed-btn:hover {\n    background: #feebea;\n    border-color: #feebea;\n    transform: translateY(-1px);\n  }\n\n  .speed-btn-small {\n    flex: 0 0 40px;\n    font-size: 18px;\n  }\n\n  .speed-control-advanced {\n    margin-top: 8px;\n  }\n\n  .speed-toggle-volume-btn {\n    width: 100%;\n    padding: 8px;\n    border: 2px solid #e5e7eb;\n    border-radius: 8px;\n    background: white;\n    color: #6b7280;\n    cursor: pointer;\n    font-size: 12px;\n    transition: all 0.2s;\n  }\n\n  .speed-toggle-volume-btn:hover {\n    background: #fff5f5;\n    border-color: #ffe5e5;\n  }\n\n  /* ==================== å¿«æ·é”®é…ç½®é¢æ¿æ ·å¼ ==================== */\n\n  .shortcut-item {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px;\n    background: rgba(255, 255, 255, 0.05);\n    border-radius: 8px;\n    transition: all 0.2s;\n  }\n\n  .shortcut-item:hover {\n    background: rgba(255, 255, 255, 0.08);\n  }\n\n  .shortcut-description {\n    flex: 1;\n    font-size: 14px;\n    color: rgba(255, 255, 255, 0.9);\n  }\n\n  .shortcut-controls {\n    display: flex;\n    gap: 8px;\n    align-items: center;\n  }\n\n  .shortcut-input {\n    padding: 6px 12px;\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 6px;\n    font-size: 13px;\n    min-width: 180px;\n    text-align: center;\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .shortcut-input:hover {\n    background: rgba(255, 255, 255, 0.15);\n    border-color: rgba(254, 235, 234, 0.5);\n  }\n\n  .shortcut-input.recording,\n  .shortcut-input.capturing {\n    background: rgba(254, 235, 234, 0.2);\n    border-color: #feebea;\n    animation: pulse 1.5s infinite;\n  }\n\n  @keyframes pulse {\n    0% { box-shadow: 0 0 0 0 rgba(254, 235, 234, 0.4); }\n    50% { box-shadow: 0 0 0 8px rgba(254, 235, 234, 0); }\n    100% { box-shadow: 0 0 0 0 rgba(254, 235, 234, 0); }\n  }\n\n  .shortcut-reset-btn {\n    padding: 6px 12px;\n    background: rgba(255, 255, 255, 0.1);\n    color: rgba(255, 255, 255, 0.7);\n    border: 1px solid rgba(255, 255, 255, 0.2);\n    border-radius: 6px;\n    font-size: 12px;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .shortcut-reset-btn:hover {\n    background: rgba(255, 255, 255, 0.15);\n    color: rgba(255, 255, 255, 0.9);\n  }\n\n  .shortcut-config-footer {\n    margin-top: 16px;\n    padding-top: 16px;\n    border-top: 1px solid rgba(255, 255, 255, 0.1);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n  \n  .shortcut-tips {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.6);\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .shortcuts-icon {\n    cursor: pointer;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 4px;\n    transition: all 0.2s;\n  }\n\n  .shortcuts-icon:hover {\n    transform: rotate(45deg);\n    filter: drop-shadow(0 0 8px rgba(254, 235, 234, 0.5));\n  }\n\n  /* ==================== ç¬”è®°é¢æ¿æ ·å¼ ==================== */\n  .notes-panel {\n    position: fixed;\n    right: 20px;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 400px;\n    min-width: 350px;\n    max-width: 600px;\n    height: 600px;\n    min-height: 400px;\n    max-height: 80vh;\n    background: rgba(32, 32, 38, 0.95);\n    backdrop-filter: blur(20px) saturate(200%);\n    border-radius: 16px;\n    box-shadow: \n      0 20px 60px -8px rgba(255, 105, 180, 0.2),\n      0 8px 24px -4px rgba(0, 0, 0, 0.3),\n      inset 0 1px 0 rgba(255, 255, 255, 0.08),\n      inset 0 -1px 0 rgba(0, 0, 0, 0.2);\n    resize: both;\n    overflow: hidden;  /* æ”¹ä¸º hiddenï¼Œåªå…è®¸å†…éƒ¨ body æ»šåŠ¨ */\n    z-index: ${H.MODAL};\n    display: none;\n    flex-direction: column;\n  }\n\n  .notes-panel.show {\n    display: flex;\n  }\n\n  .notes-panel-content {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n  }\n\n  .notes-panel-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 20px;\n    border-bottom: 1px solid rgba(254, 235, 234, 0.2);\n    background: rgba(254, 235, 234, 0.15);\n  }\n\n  .notes-panel-header h2 {\n    margin: 0;\n    font-size: 20px;\n    font-weight: 600;\n    color: #fff;\n  }\n\n  .notes-panel-close {\n    background: none;\n    border: none;\n    font-size: 24px;\n    color: rgba(255, 255, 255, 0.6);\n    cursor: pointer;\n    padding: 0;\n    width: 30px;\n    height: 30px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    transition: all 0.2s;\n  }\n\n  .notes-panel-close:hover {\n    background: rgba(255,255,255,0.1);\n    color: #fff;\n  }\n\n  /* ç¬”è®°ç­›é€‰å™¨æ ·å¼ */\n  .notes-filters {\n    display: flex;\n    gap: 20px;\n    padding: 12px 20px;\n    background: rgba(0, 0, 0, 0.2);\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .filter-checkbox {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    cursor: pointer;\n    user-select: none;\n  }\n\n  .filter-checkbox input[type="checkbox"] {\n    width: 16px;\n    height: 16px;\n    cursor: pointer;\n    accent-color: #feebea;\n  }\n\n  .filter-checkbox span {\n    color: rgba(255, 255, 255, 0.8);\n    font-size: 14px;\n  }\n\n  .filter-checkbox:hover span {\n    color: rgba(255, 255, 255, 0.95);\n  }\n\n  .notes-panel-body {\n    flex: 1;\n    overflow-y: auto;\n    padding: 20px;\n  }\n\n  .notes-panel-body::-webkit-scrollbar {\n    width: 6px;\n  }\n\n  .notes-panel-body::-webkit-scrollbar-thumb {\n    background-color: rgba(254, 235, 234, 0.4);\n    border-radius: 3px;\n  }\n  \n  .notes-panel-body::-webkit-scrollbar-thumb:hover {\n    background-color: rgba(254, 235, 234, 0.6);\n  }\n  \n  .notes-panel-body::-webkit-scrollbar-track {\n    background-color: rgba(255, 255, 255, 0.05);\n  }\n\n  .notes-empty-state {\n    text-align: center;\n    padding: 60px 20px;\n    color: rgba(255, 255, 255, 0.6);\n  }\n\n  .notes-empty-icon {\n    font-size: 48px;\n    margin-bottom: 16px;\n  }\n\n  .notes-empty-hint {\n    font-size: 14px;\n    margin-top: 8px;\n  }\n\n  .note-group {\n    margin-bottom: 24px;\n  }\n\n  .note-group-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 12px;\n    padding-bottom: 8px;\n    border-bottom: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .note-group-title {\n    font-size: 14px;\n    font-weight: 600;\n    color: #e5e7eb;\n  }\n\n  .note-group-actions {\n    display: flex;\n    gap: 8px;\n  }\n\n  .note-group-copy-btn,\n  .note-group-delete-btn {\n    padding: 4px 12px;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 12px;\n    transition: all 0.2s;\n    border: 1px solid;\n  }\n\n  .note-group-copy-btn {\n    background: none;\n    border-color: #4A90E2;\n    color: #4A90E2;\n  }\n\n  .note-group-copy-btn:hover {\n    background: #4A90E2;\n    color: white;\n  }\n\n  .note-group-delete-btn {\n    background: none;\n    border-color: #e74c3c;\n    color: #e74c3c;\n  }\n\n  .note-group-delete-btn:hover {\n    background: #e74c3c;\n    color: white;\n  }\n\n  .note-item {\n    background: rgba(255, 255, 255, 0.05);\n    padding: 12px;\n    border-radius: 8px;\n    margin-bottom: 8px;\n    transition: background-color 0.2s;\n    border: 1px solid rgba(254, 235, 234, 0.1);\n  }\n\n  .note-item:hover {\n    background: rgba(255, 255, 255, 0.1);\n    border-color: rgba(254, 235, 234, 0.3);\n  }\n\n  .note-content {\n    color: #e5e7eb;\n    font-size: 14px;\n    line-height: 1.6;\n    margin-bottom: 8px;\n    word-break: break-word;\n    white-space: pre-wrap;\n  }\n\n  .note-footer {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n\n  .note-time {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.5);\n  }\n\n  .note-actions {\n    display: flex;\n    gap: 8px;\n  }\n\n  .note-copy-btn,\n  .note-delete-btn {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 12px;\n    padding: 4px 8px;\n    transition: color 0.2s;\n  }\n\n  .note-copy-btn {\n    color: #4A90E2;\n  }\n\n  .note-copy-btn:hover {\n    color: #357ABD;\n  }\n\n  .note-delete-btn {\n    color: #e74c3c;\n  }\n\n  .note-delete-btn:hover {\n    color: #c0392b;\n  }\n\n  /* ==================== ç¬”è®°é€‰æ‹©ä¿å­˜ç‚¹æ ·å¼ ==================== */\n  #note-saver-blue-dot {\n    position: absolute;\n    cursor: pointer;\n    z-index: 2147483647; /* Maximum z-index */\n    display: none;\n    transition: transform 0.2s, filter 0.2s;\n    pointer-events: auto !important;\n    width: 24px;\n    height: 24px;\n  }\n\n  #note-saver-blue-dot:hover {\n    transform: scale(1.15);\n    filter: drop-shadow(0 2px 4px rgba(254, 235, 234, 0.5));\n  }\n\n  /* ==================== å­—å¹•é¡¹ä¿å­˜æŒ‰é’®æ ·å¼ ==================== */\n  .save-subtitle-note-btn {\n    background: linear-gradient(135deg, #feebea 0%, #2d2d2d 100%);\n    color: white;\n    border: none;\n    padding: 2px 8px;\n    border-radius: 4px;\n    font-size: 11px;\n    cursor: pointer;\n    transition: all 0.2s;\n    opacity: 0;\n    flex-shrink: 0;\n    margin-left: auto;\n  }\n\n  .subtitle-item:hover .save-subtitle-note-btn {\n    opacity: 1;\n  }\n\n  .save-subtitle-note-btn:hover {\n    transform: scale(1.05);\n  }\n  \n  .subtitle-follow-btn {\n    position: absolute;\n    bottom: 10px;\n    left: 50%;\n    transform: translateX(-50%);\n    padding: 6px 12px;\n    background: rgba(255, 105, 180, 0.8);\n    color: white;\n    border: none;\n    border-radius: 16px;\n    font-size: 12px;\n    cursor: pointer;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);\n    transition: all 0.3s;\n    z-index: 10;\n  }\n\n  .subtitle-follow-btn:hover {\n    background: rgba(255, 105, 180, 1);\n    transform: translateX(-50%) translateY(-2px);\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n  }\n\n  /* ==================== å¿«æ·é”®é…ç½®æ ·å¼ ==================== */\n  .shortcut-list {\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n  }\n\n  .shortcut-item {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px;\n    background: rgba(255, 255, 255, 0.05);\n    border-radius: 8px;\n    border: 1px solid rgba(254, 235, 234, 0.2);\n  }\n\n  .shortcut-label {\n    font-size: 14px;\n    color: #e5e7eb;\n    font-weight: 500;\n  }\n\n  .shortcut-input-wrapper {\n    display: flex;\n    gap: 8px;\n    align-items: center;\n  }\n\n  .shortcut-input {\n    padding: 6px 12px;\n    border: 1px solid rgba(254, 235, 234, 0.3);\n    border-radius: 6px;\n    font-size: 13px;\n    min-width: 180px;\n    text-align: center;\n    background: rgba(255, 255, 255, 0.1);\n    color: #fff;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n\n  .shortcut-input:focus {\n    outline: none;\n    border-color: #feebea;\n    box-shadow: 0 0 0 3px rgba(254, 235, 234, 0.15);\n    background: rgba(255, 255, 255, 0.15);\n  }\n\n  .shortcut-input.capturing {\n    border-color: #feebea;\n    background: rgba(254, 235, 234, 0.2);\n    animation: pulse-border 1s infinite;\n  }\n\n  @keyframes pulse-border {\n    0%, 100% {\n      border-color: #feebea;\n      box-shadow: 0 0 0 3px rgba(254, 235, 234, 0.15);\n    }\n    50% {\n      border-color: #ffc9c9;\n      box-shadow: 0 0 0 3px rgba(254, 235, 234, 0.3);\n    }\n  }\n\n  .shortcut-clear-btn {\n    background: none;\n    border: none;\n    color: #999;\n    font-size: 18px;\n    cursor: pointer;\n    width: 24px;\n    height: 24px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 50%;\n    transition: all 0.2s;\n  }\n\n  .shortcut-clear-btn:hover {\n    background: #fee2e2;\n    color: #dc2626;\n  }\n\n  /* ==================== è°ƒæ•´å¤§å°æ‰‹æŸ„æ ·å¼ ==================== */\n  .subtitle-resize-handle {\n    position: absolute;\n    bottom: 0;\n    right: 0;\n    width: 20px;\n    height: 20px;\n    cursor: nwse-resize;\n    z-index: 10;\n  }\n\n  .subtitle-resize-handle::after {\n    content: '';\n    position: absolute;\n    bottom: 4px;\n    right: 4px;\n    width: 12px;\n    height: 12px;\n    border-right: 3px solid rgba(254, 235, 234, 0.6);\n    border-bottom: 3px solid rgba(254, 235, 234, 0.6);\n    border-radius: 0 0 4px 0;\n  }\n\n  .subtitle-resize-handle:hover::after {\n    border-color: #feebea;\n  }\n\n  .sponsor-switch {\n    position: relative;\n    width: 48px;\n    height: 24px;\n  }\n\n  .sponsor-switch input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n  }\n\n  .sponsor-switch-slider {\n    position: absolute;\n    cursor: pointer;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: #cbd5e1;\n    transition: 0.3s;\n    border-radius: 24px;\n  }\n\n  .sponsor-switch-slider:before {\n    position: absolute;\n    content: "";\n    height: 18px;\n    width: 18px;\n    left: 3px;\n    bottom: 3px;\n    background-color: white;\n    transition: 0.3s;\n    border-radius: 50%;\n  }\n\n  .sponsor-switch input:checked + .sponsor-switch-slider {\n    background-color: #feebea;\n  }\n\n  .sponsor-switch input:checked + .sponsor-switch-slider:before {\n    transform: translateX(24px);\n  }\n\n  /* ==================== SponsorBlock æ ‡ç­¾æ ·å¼ ==================== */\n  .bili-quality-tag, .bili-ad-tag {\n    display: inline-flex !important;\n    align-items: center;\n    color: white !important;\n    padding: 3px 10px !important;\n    border-radius: 15px !important;\n    margin-right: 6px !important;\n    font-size: 12px !important;\n    animation: badgeSlideIn 0.3s ease-out !important;\n    position: relative;\n    z-index: 2;\n    font-weight: 500;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n    white-space: nowrap;\n    flex-shrink: 0;\n  }\n  \n  /* åªæ˜¾ç¤ºemojiçš„æ ‡ç­¾æ ·å¼ */\n  .bili-quality-tag.emoji-only,\n  .bili-ad-tag.emoji-only {\n    padding: 3px 8px !important;\n    min-width: auto;\n  }\n\n  /* è§†é¢‘å¡ç‰‡æ ‡ç­¾ä½ç½® */\n  .video-page-card-small .bili-quality-tag,\n  .video-page-card-small .bili-ad-tag,\n  .bili-video-card__wrap .bili-quality-tag,\n  .bili-video-card__wrap .bili-ad-tag {\n    position: absolute;\n    left: 8px;\n    top: 8px;\n    transform: scale(0.9);\n  }\n\n  /* UPä¸»ä¸»é¡µè§†é¢‘å¡ç‰‡ */\n  .up-main-video-card .bili-quality-tag,\n  .up-main-video-card .bili-ad-tag,\n  .small-item .bili-quality-tag,\n  .small-item .bili-ad-tag {\n    position: absolute !important;\n    left: 8px !important;\n    top: 8px !important;\n    z-index: 10 !important;\n    transform: scale(0.9);\n  }\n\n  .up-main-video-card .cover-container,\n  .up-main-video-card .cover,\n  .small-item .cover {\n    position: relative !important;\n  }\n\n  /* å¤šæ ‡ç­¾å®¹å™¨ */\n  .bili-tags-container {\n    display: flex;\n    flex-wrap: nowrap;\n    gap: 4px;\n    overflow: visible;\n    align-items: center;\n  }\n\n  @keyframes badgeSlideIn {\n    0% { opacity: 0; transform: translateX(-15px) scale(0.9); }\n    100% { opacity: 1; transform: translateX(0) scale(0.9); }\n  }\n\n  /* è·³è¿‡æç¤ºToast - è§†é¢‘å³ä¸‹è§’ï¼Œç»¿è‰² */\n  .skip-toast {\n    position: absolute;\n    bottom: 60px;\n    right: 20px;\n    background: rgba(0, 212, 0, 0.15);\n    color: #00d400;\n    padding: 8px 16px;\n    border-radius: 4px;\n    font-size: 14px;\n    z-index: 10000;\n    animation: fadeIn 0.3s ease-out;\n    font-weight: 500;\n    backdrop-filter: blur(4px);\n    pointer-events: auto !important;\n    user-select: none;\n  }\n\n  .skip-toast.hiding {\n    animation: fadeOut 0.3s ease-out forwards;\n  }\n\n  /* æ‰‹åŠ¨è·³è¿‡æç¤º - è§†é¢‘å³ä¸‹è§’ */\n  .skip-prompt {\n    position: absolute;\n    bottom: 80px;\n    right: 20px;\n    background: rgba(0, 0, 0, 0.9);\n    color: white;\n    border-radius: 8px;\n    padding: 12px 16px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.4);\n    z-index: 10000;\n    min-width: 280px;\n    animation: fadeIn 0.3s ease-out;\n    pointer-events: auto !important;\n    user-select: none;\n  }\n\n  .skip-prompt-header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    margin-bottom: 10px;\n    font-size: 14px;\n    font-weight: 500;\n  }\n\n  .skip-prompt-icon {\n    width: 20px;\n    height: 20px;\n    flex-shrink: 0;\n  }\n\n  .skip-prompt-icon svg {\n    width: 100%;\n    height: 100%;\n  }\n\n  .skip-prompt-message {\n    flex: 1;\n  }\n\n  .skip-prompt-buttons {\n    display: flex;\n    gap: 8px;\n    justify-content: flex-end;\n  }\n\n  .skip-prompt-btn {\n    padding: 6px 14px;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 13px;\n    transition: all 0.2s;\n  }\n\n  .skip-prompt-btn-primary {\n    background: #00a1d6;\n    color: white;\n  }\n\n  .skip-prompt-btn-primary:hover {\n    background: #0087b3;\n  }\n\n  .skip-prompt-btn-secondary {\n    background: rgba(255, 255, 255, 0.1);\n    color: white;\n  }\n\n  .skip-prompt-btn-secondary:hover {\n    background: rgba(255, 255, 255, 0.2);\n  }\n\n  .skip-prompt-close {\n    background: none;\n    border: none;\n    color: #999;\n    cursor: pointer;\n    font-size: 18px;\n    padding: 0;\n    width: 20px;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin-left: 8px;\n  }\n\n  .skip-prompt-close:hover {\n    color: white;\n  }\n\n  .skip-prompt.hiding {\n    animation: fadeOut 0.3s ease-out forwards;\n  }\n\n  /* è¿›åº¦æ¡ç‰‡æ®µæ ‡è®° */\n  #sponsorblock-preview-bar {\n    overflow: hidden;\n    padding: 0;\n    margin: 0;\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    z-index: 1;\n    pointer-events: none;\n  }\n\n  .sponsorblock-segment {\n    display: inline-block;\n    height: 100%;\n    position: absolute;\n    min-width: 1px;\n    opacity: 0.7;\n    transition: all 0.2s ease;\n    pointer-events: auto;\n    cursor: pointer;\n  }\n\n  .sponsorblock-segment:hover {\n    opacity: 0.95;\n    transform: scaleY(1.5);\n    z-index: 100;\n  }\n\n  /* ç‰‡æ®µè¯¦æƒ…å¼¹çª— */\n  .segment-details-popup {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: rgba(0, 0, 0, 0.95);\n    color: white;\n    border-radius: 12px;\n    padding: 24px;\n    min-width: 350px;\n    max-width: 500px;\n    box-shadow: 0 8px 32px rgba(0,0,0,0.5);\n    z-index: 10002;\n    animation: popupFadeIn 0.2s ease-out;\n  }\n\n  @keyframes popupFadeIn {\n    from {\n      opacity: 0;\n      transform: translate(-50%, -45%);\n    }\n    to {\n      opacity: 1;\n      transform: translate(-50%, -50%);\n    }\n  }\n\n  .segment-details-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 16px;\n    padding-bottom: 12px;\n    border-bottom: 1px solid rgba(255,255,255,0.2);\n  }\n\n  .segment-details-title {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    font-size: 18px;\n    font-weight: 500;\n  }\n\n  .segment-details-close {\n    background: none;\n    border: none;\n    color: #999;\n    font-size: 24px;\n    cursor: pointer;\n    padding: 0;\n    width: 32px;\n    height: 32px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 4px;\n    transition: all 0.2s;\n  }\n\n  .segment-details-close:hover {\n    background: rgba(255,255,255,0.1);\n    color: white;\n  }\n\n  .segment-details-content {\n    margin-bottom: 16px;\n  }\n\n  .segment-details-row {\n    display: flex;\n    justify-content: space-between;\n    padding: 8px 0;\n    font-size: 14px;\n  }\n\n  .segment-details-label {\n    color: #999;\n  }\n\n  .segment-details-value {\n    color: white;\n    font-weight: 500;\n  }\n\n  .segment-details-actions {\n    display: flex;\n    gap: 12px;\n    justify-content: flex-end;\n  }\n\n  .segment-details-btn {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 14px;\n    transition: all 0.2s;\n  }\n\n  .segment-details-btn-primary {\n    background: #00a1d6;\n    color: white;\n  }\n\n  .segment-details-btn-primary:hover {\n    background: #0087b3;\n  }\n\n  .segment-details-btn-secondary {\n    background: rgba(255,255,255,0.1);\n    color: white;\n  }\n\n  .segment-details-btn-secondary:hover {\n    background: rgba(255,255,255,0.2);\n  }\n\n  .segment-details-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0,0,0,0.3);\n    z-index: 10001;\n  }\n\n  /* SponsorBlock è®¾ç½®é¢æ¿æ ·å¼ */\n  .sponsor-settings-section {\n    margin-bottom: 24px;\n  }\n\n  .sponsor-settings-section h3 {\n    font-size: 16px;\n    color: #e5e7eb;\n    margin: 0 0 12px 0;\n  }\n\n  .sponsor-checkbox-group {\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n  }\n\n  .sponsor-checkbox-item {\n    display: flex;\n    align-items: center;\n    padding: 8px;\n    border-radius: 6px;\n    transition: background 0.2s;\n  }\n\n  .sponsor-checkbox-item:hover {\n    background: rgba(255, 255, 255, 0.05);\n  }\n\n  .sponsor-checkbox-item input[type="checkbox"] {\n    margin-right: 10px;\n    cursor: pointer;\n    width: 18px;\n    height: 18px;\n  }\n\n  .sponsor-checkbox-item label {\n    cursor: pointer;\n    flex: 1;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    color: #e5e7eb;\n  }\n\n  .category-color-dot {\n    width: 12px;\n    height: 12px;\n    border-radius: 50%;\n    display: inline-block;\n  }\n\n  .sponsor-switch-item {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px;\n    border-radius: 6px;\n    background: rgba(255, 255, 255, 0.05);\n    border: 1px solid rgba(254, 235, 234, 0.2);\n    margin-bottom: 8px;\n    color: #e5e7eb;\n  }\n`;const te='<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M3 21L12 12L12.2 6.2L11 5M15 4V2M15 16V14M8 9H10M20 9H22M17.8 11.8L19 13M17.8 6.2L19 5" stroke="#feebea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n    <circle cx="12" cy="12" r="1.5" fill="#feebea"/>\n    <path d="M17 7L12 12L7 7" stroke="#feebea" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"/>\n  </svg>',ne='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <g opacity="0.8">\n      <circle cx="12" cy="15" r="6" fill="#feebea" opacity="0.3"/>\n      <path d="M12 5C7.5 5 4 8 4 12c0 3.5 2.5 6.5 6 7.5" stroke="#feebea" stroke-width="1.5" stroke-linecap="round"/>\n      <path d="M12 5C16.5 5 20 8 20 12c0 3.5-2.5 6.5-6 7.5" stroke="#feebea" stroke-width="1.5" stroke-linecap="round"/>\n      <circle cx="8" cy="10" r="1" fill="#feebea"/>\n      <circle cx="16" cy="10" r="1" fill="#feebea"/>\n      <path d="M8 14c1 1 2 1.5 4 1.5s3-0.5 4-1.5" stroke="#feebea" stroke-width="1.5" stroke-linecap="round"/>\n      <path d="M7 3L9 5" stroke="#feebea" stroke-width="1.5" stroke-linecap="round"/>\n      <path d="M17 3L15 5" stroke="#feebea" stroke-width="1.5" stroke-linecap="round"/>\n    </g>\n  </svg>',oe='<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M12 3V16M12 16L7 11M12 16L17 11" stroke="#feebea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n    <path d="M3 17V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V17" stroke="#feebea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n  </svg>',ie='<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M6.017 4.313l55.333 -4.087c6.797 -0.583 8.543 -0.19 12.817 2.917l17.663 12.443c2.913 2.14 3.883 2.723 3.883 5.053v68.243c0 4.277 -1.553 6.807 -6.99 7.193L24.467 99.967c-4.08 0.193 -6.023 -0.39 -8.16 -3.113L3.3 79.94c-2.333 -3.113 -3.3 -5.443 -3.3 -8.167V11.113c0 -3.497 1.553 -6.413 6.017 -6.8z" fill="#fff"/>\n    <path fill-rule="evenodd" clip-rule="evenodd" d="M61.35 0.227l-55.333 4.087C1.553 4.7 0 7.617 0 11.113v60.66c0 2.724 0.967 5.053 3.3 8.167l13.007 16.913c2.137 2.723 4.08 3.307 8.16 3.113l64.257 -3.89c5.433 -0.387 6.99 -2.917 6.99 -7.193V20.64c0 -2.21 -0.873 -2.847 -3.443 -4.733L74.167 3.143c-4.273 -3.107 -6.02 -3.5 -12.817 -2.917zM25.92 19.523c-5.247 0.353 -6.437 0.433 -9.417 -1.99L8.927 11.507c-0.77 -0.78 -0.383 -1.753 1.557 -1.947l53.193 -3.887c4.467 -0.39 6.793 1.167 8.54 2.527l9.123 6.61c0.39 0.197 1.36 1.36 0.193 1.36l-54.933 3.307 -0.68 0.047zM19.803 88.3V30.367c0 -2.53 0.777 -3.697 3.103 -3.893L86 22.78c2.14 -0.193 3.107 1.167 3.107 3.693v57.547c0 2.53 -0.39 4.67 -3.883 4.863l-60.377 3.5c-3.493 0.193 -5.043 -0.97 -5.043 -4.083zm59.6 -54.827c0.387 1.75 0 3.5 -1.75 3.7l-2.91 0.577v42.773c-2.527 1.36 -4.853 2.137 -6.797 2.137 -3.107 0 -3.883 -0.973 -6.21 -3.887l-19.03 -29.94v28.967l6.02 1.363s0 3.5 -4.857 3.5l-13.39 0.777c-0.39 -0.78 0 -2.723 1.357 -3.11l3.497 -0.97v-38.3L30.48 40.667c-0.39 -1.75 0.58 -4.277 3.3 -4.473l14.367 -0.967 19.8 30.327v-26.83l-5.047 -0.58c-0.39 -2.143 1.163 -3.7 3.103 -3.89l13.4 -0.78z" fill="#000"/>\n  </svg>';function se(e){if(!e||"string"!=typeof e)return {valid:false,error:"URLä¸èƒ½ä¸ºç©º"};if(!e.startsWith("http://")&&!e.startsWith("https://"))return {valid:false,error:"URLå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´"};try{return new URL(e),{valid:!0,error:null}}catch(t){return {valid:false,error:"URLæ ¼å¼æ— æ•ˆ"}}}function re(e){return e&&"string"==typeof e?0===e.trim().length?{valid:false,error:"API Keyä¸èƒ½ä¸ºç©º"}:e.length<10?{valid:false,error:"API Keyé•¿åº¦è¿‡çŸ­ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæ•´"}:{valid:true,error:null}:{valid:false,error:"API Keyä¸èƒ½ä¸ºç©º"}}function ae(e){return e?e.bvid&&e.bvid.match(/^BV[1-9A-Za-z]{10}$/)?e.cid?{valid:true,error:null}:{valid:false,error:"CIDä¸ºç©º"}:{valid:false,error:"BVå·æ ¼å¼é”™è¯¯"}:{valid:false,error:"è§†é¢‘ä¿¡æ¯ä¸ºç©º"}}const le=new class{constructor(){this.events=new Map,this.modules=new Map,this.subscriptionId=0;}on(e,t,n=null){return this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t),n&&(this.modules.has(n)||this.modules.set(n,new Set),this.modules.get(n).add({event:e,handler:t})),()=>this.off(e,t)}once(e,t){const n=(...o)=>{t(...o),this.off(e,n);};this.on(e,n);}off(e,t){if(!this.events.has(e))return;const n=this.events.get(e),o=n.indexOf(t);o>-1&&n.splice(o,1),0===n.length&&this.events.delete(e);}emit(e,...t){if(!this.events.has(e))return;const n=[...this.events.get(e)];for(const i of n)try{i(...t);}catch(o){console.error(`[EventBus] äº‹ä»¶ "${e}" å¤„ç†å‡ºé”™:`,o);}}clear(){this.events.clear(),this.modules.clear();}clearModule(e){const t=this.modules.get(e);t&&(t.forEach(({event:e,handler:t})=>{this.off(e,t);}),this.modules.delete(e));}listenerCount(e){return this.events.has(e)?this.events.get(e).length:0}getModuleStats(){const e={};return this.modules.forEach((t,n)=>{e[n]=t.size;}),e}};const ce=new class{constructor(){this.reset();}reset(){this.subtitle={data:null,cache:{},capturedUrl:null},this.request={isRequesting:false,currentRequestKey:null,requestPromise:null,abortController:null},this.ai={isSummarizing:false,currentSummary:null,summaryPromise:null,abortController:null},this.notion={isSending:false,sendPromise:null,pageIds:{}},this.ui={ballStatus:h,panelVisible:false,isDragging:false,dragStart:{x:0,y:0},panelStart:{x:0,y:0}},this.video={bvid:null,cid:null,aid:null};}setVideoInfo(e){return !!ae(e).valid&&(this.video.bvid=e.bvid,this.video.cid=e.cid,this.video.aid=e.aid,true)}getVideoInfo(){return {...this.video}}getVideoKey(){return ae(e=this.video).valid?`${e.bvid}-${e.cid}`:null;var e;}setSubtitleData(e){this.subtitle.data=e;const t=this.getVideoKey();t&&(this.subtitle.cache[t]=e),e&&e.length>0&&le.emit(y,e,t);}getSubtitleData(e=null){const t=e||this.getVideoKey();return t?this.subtitle.cache[t]?this.subtitle.cache[t]:t===this.getVideoKey()?this.subtitle.data:null:this.subtitle.data}startRequest(){const e=this.getVideoKey();return e?this.request.isRequesting&&this.request.currentRequestKey===e?{success:false,reason:"å·²æœ‰ç›¸åŒè§†é¢‘çš„è¯·æ±‚åœ¨è¿›è¡Œä¸­"}:this.subtitle.cache[e]?{success:false,reason:"å·²æœ‰ç¼“å­˜"}:(this.request.isRequesting&&this.cancelRequest(),this.request.isRequesting=true,this.request.currentRequestKey=e,{success:true,reason:null}):{success:false,reason:"è§†é¢‘ä¿¡æ¯æ— æ•ˆ"}}finishRequest(){this.request.isRequesting=false,this.request.currentRequestKey=null,this.request.requestPromise=null,this.request.abortController=null;}cancelRequest(){this.request.abortController&&this.request.abortController.abort(),this.finishRequest();}startAISummary(){return !this.ai.isSummarizing&&(this.ai.isSummarizing=true,this.ai.abortController=new AbortController,le.emit(w),true)}finishAISummary(e){this.ai.isSummarizing=false,this.ai.currentSummary=e,this.ai.summaryPromise=null,this.ai.abortController=null;const t=this.getVideoKey();if(t&&e){const n="object"==typeof e?JSON.stringify(e):e;sessionStorage.setItem(`ai-summary-${t}`,n);}le.emit(S,e,t);}cancelAISummary(){this.ai.abortController&&this.ai.abortController.abort(),this.ai.isSummarizing=false,this.ai.summaryPromise=null,this.ai.abortController=null;}getAISummary(e=null){const t=e||this.getVideoKey();if(!t)return this.ai.currentSummary;const n=sessionStorage.getItem(`ai-summary-${t}`);if(n)try{return JSON.parse(n)}catch(o){return n}return null}setBallStatus(e){this.ui.ballStatus!==e&&(this.ui.ballStatus=e,le.emit(T,e));}getBallStatus(){return this.ui.ballStatus}togglePanel(){this.ui.panelVisible=!this.ui.panelVisible,le.emit(M,this.ui.panelVisible);}setNotionPageId(e,t){e&&t&&(this.notion.pageIds[e]=t);}getNotionPageId(e){return this.notion.pageIds[e]||null}setPanelVisible(e){this.ui.panelVisible!==e&&(this.ui.panelVisible=e,le.emit(M,e));}};const de=new class{constructor(){this.debugMode=GM_getValue("debug_mode",false),this.prefix="[BilibiliTools]";}toggleDebugMode(){return this.debugMode=!this.debugMode,GM_setValue("debug_mode",this.debugMode),console.log(`${this.prefix} è°ƒè¯•æ¨¡å¼: ${this.debugMode?"å¼€å¯":"å…³é—­"}`),this.debugMode}isDebugMode(){return this.debugMode}debug(e,...t){this.debugMode&&console.log(`[${e}]`,...t);}info(e,...t){this.debugMode&&console.log(`[${e}]`,...t);}warn(e,...t){console.warn(`[${e}]`,...t);}error(e,...t){console.error(`[${e}]`,...t);}group(e,t){this.debugMode&&console.group(`[${e}] ${t}`);}groupEnd(){this.debugMode&&console.groupEnd();}table(e,t){this.debugMode&&(console.log(`[${e}] æ•°æ®è¡¨æ ¼:`),console.table(t));}time(e){this.debugMode&&console.time(e);}timeEnd(e){this.debugMode&&console.timeEnd(e);}};const pe=new class{getAIConfigs(){const e=GM_getValue(z,[]);if(0===e.length)return [...P];const t=e.map(e=>!e.prompt||e.prompt1&&e.prompt2?e:{...e,prompt1:e.prompt,prompt2:this._getDefaultPrompt2(),prompt:void 0});return t.some(t=>void 0===t.prompt&&e.some(e=>e.prompt))&&this.saveAIConfigs(t),t}saveAIConfigs(e){GM_setValue(z,e);}getSelectedAIConfigId(){return GM_getValue(D,"openrouter")}setSelectedAIConfigId(e){GM_setValue(D,e);}getSelectedAIConfig(){const e=this.getAIConfigs(),t=this.getSelectedAIConfigId();return e.find(e=>e.id===t)||e[0]||null}addAIConfig(e){if(!(e.name&&e.url&&e.apiKey&&e.model))return {success:false,error:"æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…å¡«çš„"};const t=se(e.url);if(!t.valid)return {success:false,error:t.error};const n=re(e.apiKey);if(!n.valid)return {success:false,error:n.error};const o=this.getAIConfigs(),i={id:Date.now().toString(),name:e.name.trim(),url:e.url.trim(),apiKey:e.apiKey.trim(),model:e.model.trim(),prompt1:e.prompt1||"",prompt2:e.prompt2||"",isOpenRouter:e.isOpenRouter||false};return o.push(i),this.saveAIConfigs(o),this.setSelectedAIConfigId(i.id),{success:true,error:null,config:i}}updateAIConfig(e,t){const n=this.getAIConfigs(),o=n.findIndex(t=>t.id===e);if(-1===o)return {success:false,error:"é…ç½®ä¸å­˜åœ¨"};if(void 0!==t.apiKey){const e=re(t.apiKey,n[o].isOpenRouter);if(!e.valid)return {success:false,error:e.error}}if(void 0!==t.url){const e=se(t.url);if(!e.valid)return {success:false,error:e.error}}return !t.prompt||t.prompt1&&t.prompt2||(t.prompt1=t.prompt,t.prompt2=this._getDefaultPrompt2(),delete t.prompt),n[o]={...n[o],...t},this.saveAIConfigs(n),{success:true,error:null}}deleteAIConfig(e){if("openrouter"===e||"openai"===e)return {success:false,error:"é¢„è®¾é…ç½®ä¸èƒ½åˆ é™¤"};let t=this.getAIConfigs();return t=t.filter(t=>t.id!==e),this.saveAIConfigs(t),this.getSelectedAIConfigId()===e&&this.setSelectedAIConfigId("openrouter"),{success:true,error:null}}getAIAutoSummaryEnabled(){return GM_getValue(_,true)}setAIAutoSummaryEnabled(e){GM_setValue(_,e);}getNotionConfig(){return {apiKey:GM_getValue(q,""),parentPageId:GM_getValue(R,""),databaseId:GM_getValue(O,"")}}saveNotionConfig(e){if(e.apiKey){const t=re(e.apiKey);if(!t.valid)return {success:false,error:t.error};GM_setValue(q,e.apiKey.trim());}if(e.parentPageId){const t=function(e){if(!e||"string"!=typeof e)return {valid:false,cleaned:null,error:"Page IDä¸èƒ½ä¸ºç©º"};let t=e.split("?")[0].split("#")[0];const n=t.match(G);return n?(t=n[1].replace(/-/g,""),t.length!==u?{valid:false,cleaned:null,error:`Page IDé•¿åº¦é”™è¯¯ï¼Œéœ€è¦${u}ä½å­—ç¬¦`}:{valid:true,cleaned:t,error:null}):{valid:false,cleaned:null,error:"Page IDæ ¼å¼é”™è¯¯ï¼Œåº”ä¸º32ä½åå…­è¿›åˆ¶å­—ç¬¦"}}(e.parentPageId);if(!t.valid)return {success:false,error:t.error};GM_setValue(R,t.cleaned);}return void 0!==e.databaseId&&GM_setValue(O,e.databaseId),{success:true,error:null}}getNotionAutoSendEnabled(){return GM_getValue(F,false)}setNotionAutoSendEnabled(e){GM_setValue(F,e);}fixExistingConfigPrompts(){const e=this.getAIConfigs();let t=false;const n=e.map(e=>e.prompt1&&e.prompt2&&(e.prompt1===e.prompt2||e.prompt2.includes("TL;DR"))?(t=true,{...e,prompt2:this._getDefaultPrompt2()}):e);return t&&(this.saveAIConfigs(n),de.debug("ConfigManager","å·²ä¿®å¤é…ç½®ä¸­çš„prompt2ä¸ºJSONæ ¼å¼")),t}_getDefaultPrompt2(){return 'åˆ†æä»¥ä¸‹å¸¦æ—¶é—´æˆ³çš„å­—å¹•ï¼Œæå–5-8ä¸ªå…³é”®æ®µè½ã€‚\n\né‡è¦ï¼šä½ çš„å›å¤å¿…é¡»åªåŒ…å«JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–markdownæ ‡è®°ã€‚\nç›´æ¥ä»¥{å¼€å§‹ï¼Œä»¥}ç»“æŸã€‚\n\nJSONæ ¼å¼è¦æ±‚ï¼š\n{"segments":[\n  {"timestamp":"åˆ†é’Ÿ:ç§’","title":"æ ‡é¢˜(10å­—å†…)","summary":"å†…å®¹æ€»ç»“(30-50å­—)"}\n]}\n\nç¤ºä¾‹ï¼ˆä½ çš„å›å¤åº”è¯¥åƒè¿™æ ·ï¼‰ï¼š\n{"segments":[{"timestamp":"00:15","title":"å¼€åœºä»‹ç»","summary":"ä¸»æŒäººä»‹ç»ä»Šå¤©çš„ä¸»é¢˜å’Œå˜‰å®¾èƒŒæ™¯"},{"timestamp":"02:30","title":"æ ¸å¿ƒè§‚ç‚¹","summary":"è®¨è®ºæŠ€æœ¯å‘å±•è¶‹åŠ¿å’Œæœªæ¥å±•æœ›"}]}\n\nå­—å¹•å†…å®¹ï¼š\n'}},ue="bilibili_shortcuts_config",he={toggleSubtitlePanel:{key:"b",ctrl:true,alt:false,shift:false,description:"åˆ‡æ¢å­—å¹•é¢æ¿"},toggleNotesPanel:{key:"KeyL",ctrl:true,alt:false,shift:false,description:"åˆ‡æ¢ç¬”è®°é¢æ¿"},takeScreenshot:{key:"Slash",ctrl:false,alt:false,shift:false,doubleClick:true,description:"æˆªå›¾å¹¶ä¿å­˜åˆ°ç¬”è®°"},speedIncrease:{key:"Period",ctrl:false,alt:false,shift:false,description:"å¢åŠ æ’­æ”¾é€Ÿåº¦"},speedDecrease:{key:"Comma",ctrl:false,alt:false,shift:false,description:"å‡å°‘æ’­æ”¾é€Ÿåº¦"},speedReset:{key:"Comma",ctrl:false,alt:false,shift:false,doubleClick:true,description:"é‡ç½®æ’­æ”¾é€Ÿåº¦(åŒå‡»)"},speedDouble:{key:"Period",ctrl:false,alt:false,shift:false,doubleClick:true,description:"2å€é€Ÿ(åŒå‡»)"}};const ge=new class{constructor(){this.shortcuts=this.loadShortcuts(),this.handlers=new Map,this.isListening=false,this.pressedKeys=new Set,this.setupKeyTracking();}static get DEFAULT_SHORTCUTS(){return he}loadShortcuts(){try{const e=GM_getValue(ue,null);if(!e)return {...he};const t=JSON.parse(e);for(const[n,o]of Object.entries(t))o.key&&"(åŒå‡»)"!==o.key&&""!==o.key||(de.warn("ShortcutManager",`ä¿®å¤æŸåçš„å¿«æ·é”®é…ç½®: ${n}`),he[n]?t[n]={...he[n]}:delete t[n]);return t}catch(e){return console.error("åŠ è½½å¿«æ·é”®é…ç½®å¤±è´¥:",e),{...he}}}saveShortcuts(e){try{return this.shortcuts=e,GM_setValue(ue,JSON.stringify(e)),{success:!0,error:null}}catch(t){return console.error("ä¿å­˜å¿«æ·é”®é…ç½®å¤±è´¥:",t),{success:false,error:t.message}}}resetToDefaults(){return this.shortcuts={...he},this.saveShortcuts(this.shortcuts)}getAllShortcuts(){return {...this.shortcuts}}updateShortcut(e,t){if(!this.shortcuts[e])return {success:false,error:"å¿«æ·é”®ä¸å­˜åœ¨"};const n=this.checkConflict(e,t);return n?{success:false,error:`ä¸"${n}"å†²çª`}:(this.shortcuts[e]={...this.shortcuts[e],...t},this.saveShortcuts(this.shortcuts))}checkConflict(e,t){for(const[n,o]of Object.entries(this.shortcuts))if(n!==e&&o.key===t.key&&o.ctrl===t.ctrl&&o.alt===t.alt&&o.shift===t.shift&&o.doubleClick===t.doubleClick)return o.description;return null}register(e,t){this.handlers.set(e,t);}setupKeyTracking(){document.addEventListener("keydown",e=>{this.pressedKeys.add(e.code);},true),document.addEventListener("keyup",e=>{this.pressedKeys.delete(e.code);},true),window.addEventListener("blur",()=>{this.pressedKeys.clear();});}matches(e,t){if(t.keys&&Array.isArray(t.keys)){const n=t.keys.every(e=>this.pressedKeys.has(e)),o=!(e.ctrlKey||e.metaKey||e.altKey||e.shiftKey);return n&&o}const n=e.ctrlKey||e.metaKey;return e.code===t.key&&n===(t.ctrl||false)&&e.altKey===(t.alt||false)&&e.shiftKey===(t.shift||false)}startListening(){this.isListening||(document.addEventListener("keydown",e=>this.handleKeyDown(e),true),this.isListening=true);}handleKeyDown(e){const t="INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable;for(const[n,o]of Object.entries(this.shortcuts)){if(o.doubleClick){"takeScreenshot"===n&&this.handleDoubleClick(e,n,o);continue}const i=o.ctrl||o.alt;if(this.matches(e,o)){if(t&&!i)continue;const o=this.handlers.get(n);o&&(e.preventDefault(),o(e));}}}handleDoubleClick(e,t,n){if(e.code!==n.key)return;const o=Date.now();this.lastKeyPressTime||(this.lastKeyPressTime={});if(o-(this.lastKeyPressTime[n.key]||0)<300){const o=this.handlers.get(t);o&&(e.preventDefault(),o(e),this.lastKeyPressTime[n.key]=0);}else this.lastKeyPressTime[n.key]=o;}formatShortcut(e){if(e.keys&&Array.isArray(e.keys)){return e.keys.map(e=>"Period"===e?".":"Comma"===e?",":1===e.length?e.toUpperCase():e).join(" + ")}const t=[];e.ctrl&&t.push(navigator.platform.includes("Mac")?"Cmd":"Ctrl"),e.alt&&t.push("Alt"),e.shift&&t.push("Shift");let n=e.key;return "Period"===n&&(n="."),"Comma"===n&&(n=","),"Slash"===n&&(n="/"),n.startsWith("Key")&&(n=n.substring(3)),1===n.length&&(n=n.toUpperCase()),t.push(n),e.doubleClick&&t.push("(åŒå‡»)"),t.join(" + ")}validateConfig(e){return e.key&&"string"==typeof e.key?"boolean"!=typeof e.ctrl||"boolean"!=typeof e.alt||"boolean"!=typeof e.shift?{valid:false,error:"ä¿®é¥°é”®é…ç½®é”™è¯¯"}:{valid:true,error:null}:{valid:false,error:"æŒ‰é”®ä¸èƒ½ä¸ºç©º"}}};const me=new class{constructor(){this.enabled=true;}measure(e,t){if(!this.enabled)return t();const n=performance.now();let o,i;try{o=t();}catch(r){i=r;}const s=performance.now()-n;if(de.debug("è®¡æ—¶",`${e}: ${s.toFixed(2)}ms`),i)throw i;return o}async measureAsync(e,t){if(!this.enabled)return await t();const n=performance.now();let o,i;try{o=await t();}catch(r){i=r;}const s=performance.now()-n;if(de.debug("è®¡æ—¶",`${e}: ${s.toFixed(2)}ms`),i)throw i;return o}destroy(){}};function be(e){const t=Math.floor(e/60),n=Math.floor(e%60);return `${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function fe(){let e=null,t=null,n=null;e=function(e=window.location.href){const t=e.match(V);if(t)return t[1];const n=e.match(U);return n?n[0]:null}();try{const o=unsafeWindow.__INITIAL_STATE__;o&&o.videoData&&(e=e||o.videoData.bvid,t=o.videoData.cid||o.videoData.pages?.[0]?.cid,n=o.videoData.aid);}catch(o){}return {bvid:e,cid:t,aid:n}}function ye(){let e="";try{const t=unsafeWindow.__INITIAL_STATE__;t&&t.videoData&&t.videoData.title&&(e=t.videoData.title);}catch(t){}if(!e){const t=document.querySelector(Q);t&&(e=t.textContent.trim());}return e||(e=document.title.replace(/_å“”å“©å“”å“©.*$/,"").replace(/_bilibili.*$/i,"").trim()),e||"æœªçŸ¥è§†é¢‘"}function xe(e){return new Promise(t=>setTimeout(t,e))}function ve(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...o);},t);}}const we=new class{constructor(){this.capturedSubtitleUrl=null,this.setupInterceptor();}setupInterceptor(){const e=unsafeWindow.XMLHttpRequest.prototype.open,t=unsafeWindow.XMLHttpRequest.prototype.send;unsafeWindow.XMLHttpRequest.prototype.open=function(t,n){return this._url=n,e.apply(this,arguments)},unsafeWindow.XMLHttpRequest.prototype.send=function(){return this._url&&this._url.includes("aisubtitle.hdslb.com")&&(we.capturedSubtitleUrl=this._url,ce.subtitle.capturedUrl=this._url,setTimeout(()=>{we.downloadCapturedSubtitle();},o)),t.apply(this,arguments)};}async downloadCapturedSubtitle(){this.capturedSubtitleUrl&&await me.measureAsync("å­—å¹•ä¸‹è½½",async()=>{const e=fe();ce.setVideoInfo(e);const t=ce.startRequest();if(t.success){ce.setBallStatus(g),le.emit(v,e);try{const t=await this._fetchSubtitle(this.capturedSubtitleUrl,e),n=function(e){if(!Array.isArray(e))return {valid:!1,error:"å­—å¹•æ•°æ®æ ¼å¼é”™è¯¯ï¼šéæ•°ç»„ç±»å‹",details:{actualType:typeof e,value:e}};if(0===e.length)return {valid:!1,error:"å­—å¹•æ•°æ®ä¸ºç©º",details:{length:0}};const t=e[0],n=[];return void 0!==t.from&&null!==t.from||n.push("from"),void 0!==t.to&&null!==t.to||n.push("to"),t.content||n.push("content"),n.length>0?{valid:!1,error:`å­—å¹•æ•°æ®æ ¼å¼ä¸å®Œæ•´ï¼Œç¼ºå°‘å­—æ®µ: ${n.join(", ")}`,details:{missingFields:n,firstItem:t,itemKeys:Object.keys(t||{})}}:{valid:!0,error:null,details:null}}(t);if(!n.valid)throw de.error("SubtitleService","å­—å¹•éªŒè¯å¤±è´¥:",n.error),n.details&&de.error("SubtitleService","éªŒè¯è¯¦æƒ…:",n.details),new Error(n.error);ce.setSubtitleData(t),ce.setBallStatus(m);}catch(n){de.error("SubtitleService","å­—å¹•è·å–å¤±è´¥:",n),ce.setBallStatus(f),le.emit(x,n.message);}finally{ce.finishRequest();}}else if("å·²æœ‰ç¼“å­˜"===t.reason){const e=ce.getSubtitleData();e&&(ce.setBallStatus(m),le.emit(y,e,ce.getVideoKey()));}});}_fetchSubtitle(e,t){return new Promise((n,o)=>{GM_xmlhttpRequest({method:"GET",url:e,headers:{Accept:"application/json, text/plain, */*","Accept-Encoding":"gzip, deflate, br","Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8","Cache-Control":"no-cache",Origin:"https://www.bilibili.com",Referer:`https://www.bilibili.com/video/${t.bvid}/`,"Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"cross-site","User-Agent":navigator.userAgent},anonymous:false,onload:e=>{const i=fe();if(i.bvid===t.bvid&&i.cid===t.cid)if(200===e.status)if(e.responseText.trim().startsWith("<!DOCTYPE")||e.responseText.trim().startsWith("<html"))o(new Error("æœåŠ¡å™¨è¿”å›HTMLè€ŒéJSONï¼Œå¯èƒ½è¢«é‡å®šå‘"));else try{const t=JSON.parse(e.responseText);t.body&&t.body.length>0?n(t.body):o(new Error("å­—å¹•å†…å®¹ä¸ºç©º"));}catch(s){o(new Error("è§£æå­—å¹•æ•°æ®å¤±è´¥"));}else o(new Error(`è¯·æ±‚å¤±è´¥: ${e.status}`));else o(new Error("è§†é¢‘å·²åˆ‡æ¢"));},onerror:()=>{o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"));}});})}async checkSubtitleButton(){let n=0;return new Promise(o=>{const i=setInterval(()=>{n++;document.querySelector(Y)?(clearInterval(i),this.tryActivateSubtitle(),o(true)):n>=t&&(clearInterval(i),ce.setBallStatus(b),o(false));},e);})}async tryActivateSubtitle(){await xe(n),this.capturedSubtitleUrl?this.downloadCapturedSubtitle():this.triggerSubtitleSelection();}async triggerSubtitleSelection(){const e=document.querySelector(Y);if(!e)return void ce.setBallStatus(b);e.click(),await xe(i);let t=document.querySelector('.bpx-player-ctrl-subtitle-language-item[data-lan="ai-zh"]');if(t||(t=document.querySelector('.bpx-player-ctrl-subtitle-language-item[data-lan*="zh"]')),!t){const e=document.querySelectorAll(".bpx-player-ctrl-subtitle-language-item");for(let n of e){const e=n.querySelector(".bpx-player-ctrl-subtitle-language-item-text");if(e&&e.textContent.includes("ä¸­æ–‡")){t=n;break}}}if(t){t.click(),await xe(s);const e=document.querySelector(W);e&&e.click(),await xe(n),this.capturedSubtitleUrl?this.downloadCapturedSubtitle():ce.setBallStatus(f);}else {const t=document.querySelector(".bpx-player-ctrl-subtitle-language-item");if(t){t.click(),await xe(s);const e=document.querySelector(W);e&&e.click(),await xe(n),this.capturedSubtitleUrl?this.downloadCapturedSubtitle():ce.setBallStatus(f);}else e.click(),ce.setBallStatus(b);}}downloadSubtitleFile(){const e=ce.getSubtitleData();if(!e||0===e.length)throw new Error("æ²¡æœ‰å­—å¹•æ•°æ®å¯ä¸‹è½½");const t=ce.getVideoInfo(),n=ye();!function(e,t,n="text/plain;charset=utf-8"){const o=new Blob([e],{type:n}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i);}(e.map(e=>e.content).join("\n"),`${n}_${t.bvid}_å­—å¹•.txt`);}reset(){this.capturedSubtitleUrl=null,ce.subtitle.capturedUrl=null;}};const Se=new class{async sendSubtitle(e,t=false){const n=pe.getNotionConfig();if(!n.apiKey)throw new Error("è¯·å…ˆé…ç½® Notion API Key");if(!e||0===e.length)throw new Error("æ²¡æœ‰å­—å¹•æ•°æ®å¯å‘é€");ce.notion.isSending=true,le.emit(E);try{const t=ce.getVideoInfo(),o=ye(),i=window.location.href.split("?")[0],s=function(){try{const e=unsafeWindow.__INITIAL_STATE__;if(e&&e.videoData&&e.videoData.owner)return e.videoData.owner.name}catch(e){}return "æœªçŸ¥"}(),r=this._buildPageContent(t,o,i,e);let a=n.databaseId;if(!a){if(!n.parentPageId)throw new Error("è¯·å…ˆé…ç½®ç›®æ ‡ä½ç½®ï¼ˆPage ID æˆ– Database IDï¼‰");a=n.parentPageId;}const l=await this._getDatabaseSchema(n.apiKey,a),c=this._buildProperties(l,t,o,i,s,e),d=await this._createPage(n.apiKey,a,c,r);d&&ce.setNotionPageId(t.bvid,d),n.databaseId||pe.saveNotionConfig({databaseId:a}),ce.notion.isSending=!1,le.emit(C);}catch(o){throw ce.notion.isSending=false,le.emit(A,o.message),o}}async queryVideoPage(e,t,n){if(!e||!t||!n)return null;const o={filter:{property:"BVå·",rich_text:{contains:n}},sorts:[{timestamp:"created_time",direction:"descending"}],page_size:1};return new Promise(n=>{GM_xmlhttpRequest({method:"POST",url:`${K}/databases/${t}/query`,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","Notion-Version":j},data:JSON.stringify(o),onload:e=>{if(200===e.status){const t=JSON.parse(e.responseText);t.results&&t.results.length>0?n(t.results[0].id):n(null);}else n(null);},onerror:()=>{n(null);}});})}async createDatabase(e,t){const n={parent:{type:"page_id",page_id:t},title:[{type:"text",text:{content:"ğŸ“º Bilibili å­—å¹•æ”¶è—"}}],properties:{"æ ‡é¢˜":{title:{}},"BVå·":{rich_text:{}},"åˆ›ä½œè€…":{rich_text:{}},"è§†é¢‘é“¾æ¥":{url:{}},"æ”¶è—æ—¶é—´":{date:{}},"å­—å¹•æ¡æ•°":{number:{}},"çŠ¶æ€":{select:{options:[{name:"æœªæ€»ç»“",color:"gray"},{name:"å·²æ€»ç»“",color:"green"}]}},"æ€»ç»“":{rich_text:{}}}};return new Promise((t,o)=>{GM_xmlhttpRequest({method:"POST",url:`${K}/databases`,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","Notion-Version":j},data:JSON.stringify(n),onload:e=>{if(200===e.status){const n=JSON.parse(e.responseText);t(n.id);}else {const t=this._parseNotionError(e);o(t);}},onerror:e=>{o(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"));}});})}_getDatabaseSchema(e,t){return new Promise((n,o)=>{GM_xmlhttpRequest({method:"GET",url:`${K}/databases/${t}`,headers:{Authorization:`Bearer ${e}`,"Notion-Version":j},onload:e=>{if(200===e.status){const t=JSON.parse(e.responseText);n(t.properties);}else {const t=this._parseNotionError(e);o(t);}},onerror:()=>{o(new Error("è·å–æ•°æ®åº“ç»“æ„å¤±è´¥"));}});})}_createPage(e,t,n,o){const i={parent:{database_id:t},properties:n,children:o};return new Promise((t,n)=>{GM_xmlhttpRequest({method:"POST",url:`${K}/pages`,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","Notion-Version":j},data:JSON.stringify(i),onload:e=>{if(200===e.status){const n=JSON.parse(e.responseText);t(n.id);}else {const t=this._parseNotionError(e);n(t);}},onerror:()=>{n(new Error("åˆ›å»ºé¡µé¢å¤±è´¥"));}});})}async appendToPage(e,t,n){return new Promise((o,i)=>{GM_xmlhttpRequest({method:"PATCH",url:`${K}/blocks/${t}/children`,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","Notion-Version":j},data:JSON.stringify({children:n}),onload:e=>{if(200===e.status)o();else {const t=this._parseNotionError(e);i(t);}},onerror:()=>{i(new Error("è¿½åŠ å†…å®¹å¤±è´¥"));}});})}async sendAISummary(e){const t=pe.getNotionConfig(),n=ce.getVideoInfo(),o=n?.bvid;if(!o)throw new Error("æ— æ•ˆçš„è§†é¢‘ä¿¡æ¯");let i=ce.getNotionPageId(o);if(!i&&t.databaseId&&(i=await this.queryVideoPage(t.apiKey,t.databaseId,o),i&&ce.setNotionPageId(o,i)),!i)throw new Error("è¯·å…ˆå‘é€å­—å¹•åˆ°Notionä»¥åˆ›å»ºè§†é¢‘é¡µé¢");const s=this._buildAISummaryBlocks(e);await this.appendToPage(t.apiKey,i,s);}_buildAISummaryBlocks(e){const t=[];if(t.push({object:"block",type:"divider",divider:{}}),t.push({object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:"ğŸ¤– AIæ€»ç»“"}}]}}),e.markdown){e.markdown.split("\n").forEach(e=>{e.trim()&&t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:e}}]}});});}return e.segments&&e.segments.length>0&&(t.push({object:"block",type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:"â±ï¸ æ—¶é—´æˆ³æ®µè½"}}]}}),e.segments.forEach(e=>{t.push({object:"block",type:"bulleted_list_item",bulleted_list_item:{rich_text:[{type:"text",text:{content:`${e.timestamp} - ${e.title}: ${e.summary||""}`}}]}});})),t}_buildPageContent(e,t,n,o){const i=[{object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:"ğŸ“¹ è§†é¢‘ä¿¡æ¯"}}]}},{object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`è§†é¢‘æ ‡é¢˜ï¼š${t}`}}]}},{object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`BVå·ï¼š${e.bvid}`}}]}},{object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`è§†é¢‘é“¾æ¥ï¼š${n}`}}]}},{object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`å­—å¹•æ€»æ•°ï¼š${o.length} æ¡`}}]}},{object:"block",type:"divider",divider:{}},{object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:"ğŸ“ å­—å¹•å†…å®¹"}}]}}],s=[];let r="";const a=d;for(let l of o){const e=`${l.content}\n`;r.length+e.length>a?(r&&s.push({type:"text",text:{content:r}}),r=e):r+=e;}return r&&s.push({type:"text",text:{content:r}}),i.push({object:"block",type:"code",code:{rich_text:s,language:"plain text"}}),i}_buildProperties(e,t,n,o,i,s){const r={},a=Object.keys(e).find(t=>"title"===e[t].type);return a&&(r[a]={title:[{text:{content:n}}]}),Object.keys(e).forEach(n=>{const a=e[n].type,l=n.toLowerCase().replace(/\s+/g,"");if(!l.includes("bv")||"rich_text"!==a&&"text"!==a||(r[n]={rich_text:[{text:{content:t.bvid||""}}]}),!(l.includes("åˆ›ä½œ")||l.includes("ä½œè€…")||l.includes("creator")||l.includes("upä¸»"))||"rich_text"!==a&&"text"!==a||(r[n]={rich_text:[{text:{content:i}}]}),l.includes("é“¾æ¥")&&"url"===a&&(r[n]={url:o}),"date"===a&&("æ—¥æœŸ"===l||l.includes("æ”¶è—")||l.includes("æ·»åŠ ")||l.includes("åˆ›å»º"))&&(r[n]={date:{start:(new Date).toISOString()}}),(l.includes("æ¡æ•°")||l.includes("æ•°é‡"))&&"number"===a&&(r[n]={number:s.length}),"çŠ¶æ€"===l||"status"===l){const e=ce.getVideoKey(),t=e?ce.getAISummary(e):null;"select"===a||"status"===a?r[n]={[a]:{name:t?"å·²æ€»ç»“":"æœªæ€»ç»“"}}:"rich_text"===a&&(r[n]={rich_text:[{text:{content:t?"å·²æ€»ç»“":"æœªæ€»ç»“"}}]});}if("æ€»ç»“"===l||"summary"===l){const e=ce.getVideoKey(),t=e?ce.getAISummary(e):null;if("rich_text"===a&&t){let e="";"string"==typeof t?e=t:t&&t.markdown&&(e=t.markdown),e&&(r[n]={rich_text:[{text:{content:e.substring(0,p)}}]});}}}),r}_parseNotionError(e){try{const t=JSON.parse(e.responseText);return "object_not_found"===t.code||t.message?.includes("Could not find")?new Error("æ‰¾ä¸åˆ°æŒ‡å®šçš„Notioné¡µé¢æˆ–æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥ï¼š\n1. IDæ˜¯å¦æ­£ç¡®\n2. æ˜¯å¦å·²åœ¨Notionä¸­æˆæƒè¯¥Integration"):new Error(t.message||"æœªçŸ¥é”™è¯¯")}catch(t){return new Error(`è¯·æ±‚å¤±è´¥: ${e.status}`)}}};const ke=new class{async fetchOpenRouterModels(e,t){const n=t.replace("/chat/completions","/models"),o=await fetch(n,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok)throw new Error(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${o.status}`);return (await o.json()).data||[]}async summarize(e,t=false){if(!ce.startAISummary())throw new Error("å·²æœ‰æ€»ç»“ä»»åŠ¡åœ¨è¿›è¡Œä¸­");return await me.measureAsync("AIæ€»ç»“",async()=>{try{const n=pe.getSelectedAIConfig();if(!n)throw new Error("æœªæ‰¾åˆ°AIé…ç½®ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ é…ç½®");if(!n.apiKey||""===n.apiKey.trim())throw new Error('è¯·å…ˆé…ç½® AI API Key\n\nè¯·ç‚¹å‡»å³ä¸Šè§’è®¾ç½®æŒ‰é’®ï¼Œé€‰æ‹©"AIé…ç½®"ï¼Œç„¶åä¸ºæ‰€é€‰çš„AIæœåŠ¡å•†é…ç½®API Key');if(!n.url||!n.url.startsWith("http"))throw new Error("API URLæ ¼å¼é”™è¯¯ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ£€æŸ¥é…ç½®");if(!n.model||""===n.model.trim())throw new Error("æœªé…ç½®æ¨¡å‹ï¼Œè¯·åœ¨è®¾ç½®ä¸­é€‰æ‹©AIæ¨¡å‹");const o=e.map(e=>e.content).join("\n"),i=e.map(e=>{const t=Math.floor(e.from/60),n=Math.floor(e.from%60);return `${`[${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}]`} ${e.content}`}).join("\n"),s={"Content-Type":"application/json",Authorization:`Bearer ${n.apiKey}`};n.isOpenRouter&&(s["HTTP-Referer"]=window.location.origin,s["X-Title"]="Bilibili Subtitle Extractor");const[r,a]=await Promise.all([this._makeAIRequest(n,s,o,n.prompt1||this._getDefaultPrompt1(),"markdown"),this._makeAIRequest(n,s,i,n.prompt2||this._getDefaultPrompt2(),"json")]),l={markdown:r,segments:a};de.debug("AIService","æ€»ç»“å®Œæˆï¼Œæ®µè½æ•°é‡:",a?.length||0),a&&0!==a.length||de.warn("AIService","æ²¡æœ‰ç”Ÿæˆæ®µè½æ€»ç»“ï¼Œè¯·æ£€æŸ¥AIè¿”å›å†…å®¹"),ce.finishAISummary(l);try{const e=pe.getNotionConfig(),t=ce.getVideoInfo(),n=t?.bvid;if(e.apiKey&&n){ce.getNotionPageId(n)&&Se.sendAISummary(l).catch(e=>{console.error("[AIService] å‘é€AIæ€»ç»“åˆ°Notionå¤±è´¥:",e);});}}catch(t){console.error("[AIService] æ£€æŸ¥Notioné…ç½®å¤±è´¥:",t);}return l}catch(t){throw ce.cancelAISummary(),le.emit(k,t.message),t}})}async _makeAIRequest(e,t,n,o,i){const s={model:e.model,messages:[{role:"user",content:o+n}],stream:"markdown"===i};if("markdown"===i){const n=this._streamingRequest(e.url,t,s),o=await function(e,t,n="æ“ä½œè¶…æ—¶"){return Promise.race([e,new Promise((e,o)=>setTimeout(()=>o(new Error(n)),t))])}(n,l,"Markdownæ€»ç»“è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");return this._cleanMarkdownContent(o)}{const n=await fetch(e.url,{method:"POST",headers:t,body:JSON.stringify(s),signal:ce.ai.abortController?.signal});if(!n.ok){const e=await n.text();throw console.error("[AIService] JSON APIé”™è¯¯å“åº”:",e),new Error(`JSONè¯·æ±‚å¤±è´¥: ${n.status} ${n.statusText}`)}const o=await n.json(),i=o.choices?.[0]?.message?.content||"";return this._parseJSONResponse(i)}}_parseJSONResponse(e){de.debug("AIService","å°è¯•è§£æJSONå“åº”ï¼ŒåŸå§‹å†…å®¹é•¿åº¦:",e?.length||0);try{let t=e.trim();if(t.includes("```json")){const e=t.match(/```json\s*([\s\S]*?)```/);e&&(t=e[1].trim());}else if(t.includes("```")){const e=t.match(/```\s*([\s\S]*?)```/);e&&(t=e[1].trim());}const n=t.match(/\{[\s\S]*\}/);if(n){de.debug("AIService","æ‰¾åˆ°JSONåŒ¹é…:",n[0].substring(0,100)+"...");const e=JSON.parse(n[0]),t=Array.isArray(e.segments)?e.segments:Array.isArray(e)?e:[];if(t.length>0)return de.debug("AIService","æˆåŠŸè§£ææ®µè½æ•°é‡:",t.length),t.map(e=>({timestamp:this._normalizeTimestamp(e.timestamp),title:e.title||"",summary:e.summary||""}));de.warn("AIService","JSONä¸­æ²¡æœ‰æ‰¾åˆ°segmentsæ•°ç»„ï¼Œjsonå†…å®¹:",e);}else de.warn("AIService","å“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°JSONæ ¼å¼å†…å®¹ï¼ŒåŸå§‹å†…å®¹å‰200å­—ç¬¦:",t.substring(0,200));}catch(t){console.error("[AIService] JSONè§£æå¤±è´¥:",t,"\nåŸå§‹å†…å®¹å‰200å­—ç¬¦:",e?.substring(0,200));}return []}_cleanMarkdownContent(e){if(!e)return "";let t=e.trim();for(;t.includes("```markdown");){const e=t.match(/```markdown\s*([\s\S]*?)```/);if(!e)break;t=t.replace(/```markdown\s*[\s\S]*?```/,e[1].trim()),de.debug("AIService","ä»markdownä»£ç å—ä¸­æå–å†…å®¹");}if(t.startsWith("```")&&t.endsWith("```")){t=t.slice(3,-3).trim();const e=t.split("\n");e[0]&&!e[0].includes(" ")&&e[0].length<20&&(t=e.slice(1).join("\n").trim()),de.debug("AIService","ä»ä»£ç å—ä¸­æå–å†…å®¹");}return t=t.replace(/```\s*\n?(#{1,3}\s+[\s\S]*?)```/g,"$1"),t}_normalizeTimestamp(e){if(!e)return "[00:00]";const t=e.replace(/[\[\]]/g,""),n=t.split(":");if(2===n.length){const[e,t]=n;return `[${e.padStart(2,"0")}:${t.padStart(2,"0")}]`}if(3===n.length){const[e,t,o]=n;return `[${(60*parseInt(e)+parseInt(t)).toString().padStart(2,"0")}:${o.padStart(2,"0")}]`}return `[${t}]`}async _streamingRequest(e,t,n){const o=await fetch(e,{method:"POST",headers:t,body:JSON.stringify(n),signal:ce.ai.abortController?.signal});if(!o.ok){const e=await o.text();throw console.error("[AIService] APIé”™è¯¯å“åº”:",e),new Error(`APIè¯·æ±‚å¤±è´¥: ${o.status} ${o.statusText}`)}const i=o.body.getReader(),s=new TextDecoder;let r="";try{for(;;){const{done:e,value:t}=await i.read();if(e)break;const n=s.decode(t).split("\n");for(const o of n)if(o.startsWith("data: ")){const e=o.slice(6);if("[DONE]"===e)continue;try{const t=JSON.parse(e),n=t.choices[0]?.delta?.content;n&&(r+=n,le.emit(I,r));}catch(a){}}}return r}finally{i.releaseLock();}}_getDefaultPrompt1(){return "è¯·ç”¨ä¸­æ–‡æ€»ç»“ä»¥ä¸‹è§†é¢‘å­—å¹•å†…å®¹ï¼Œä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºã€‚\n\nè¦æ±‚ï¼š\n1. ç¬¬ä¸€è¡Œä½¿ç”¨ # æ ‡é¢˜ï¼Œç®€æ´æ¦‚æ‹¬è§†é¢‘ä¸»é¢˜\n2. ç¬¬äºŒéƒ¨åˆ†ä½¿ç”¨ ## TL;DR ä½œä¸ºæ ‡é¢˜ï¼Œæä¾›2-3å¥è¯çš„æ ¸å¿ƒæ‘˜è¦\n3. ç¬¬ä¸‰éƒ¨åˆ†ä½¿ç”¨ --- åˆ†éš”çº¿\n4. åç»­å†…å®¹æŒ‰ä¸»é¢˜ä½¿ç”¨ ### ä¸‰çº§æ ‡é¢˜åˆ†æ®µ\n5. ä½¿ç”¨é¡¹ç›®ç¬¦å· - åˆ—å‡ºè¦ç‚¹\n6. ä¸è¦åœ¨æ€»ç»“ä¸­åŒ…å«ä»»ä½•æ—¶é—´æˆ³\n7. ç›´æ¥è¾“å‡ºMarkdownå†…å®¹ï¼Œä¸è¦ä½¿ç”¨ä»£ç å—åŒ…è£¹ï¼ˆä¸è¦ä½¿ç”¨```ï¼‰\n\nå­—å¹•å†…å®¹ï¼š\n"}_getDefaultPrompt2(){return 'åˆ†æä»¥ä¸‹å¸¦æ—¶é—´æˆ³çš„å­—å¹•ï¼Œæå–5-8ä¸ªå…³é”®æ®µè½ã€‚\n\né‡è¦ï¼šä½ çš„å›å¤å¿…é¡»åªåŒ…å«JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–markdownæ ‡è®°ã€‚\nç›´æ¥ä»¥{å¼€å§‹ï¼Œä»¥}ç»“æŸã€‚\n\nJSONæ ¼å¼è¦æ±‚ï¼š\n{"segments":[\n  {"timestamp":"åˆ†é’Ÿ:ç§’","title":"æ ‡é¢˜(10å­—å†…)","summary":"å†…å®¹æ€»ç»“(30-50å­—)"}\n]}\n\nç¤ºä¾‹ï¼ˆä½ çš„å›å¤åº”è¯¥åƒè¿™æ ·ï¼‰ï¼š\n{"segments":[{"timestamp":"00:15","title":"å¼€åœºä»‹ç»","summary":"ä¸»æŒäººä»‹ç»ä»Šå¤©çš„ä¸»é¢˜å’Œå˜‰å®¾èƒŒæ™¯"},{"timestamp":"02:30","title":"æ ¸å¿ƒè§‚ç‚¹","summary":"è®¨è®ºæŠ€æœ¯å‘å±•è¶‹åŠ¿å’Œæœªæ¥å±•æœ›"}]}\n\nå­—å¹•å†…å®¹ï¼š\n'}cancelCurrentSummary(){ce.cancelAISummary();}},Ie="bilibili_subtitle_notes",Ee=5e3,Ce=10,Ae=100,Me=4718592;const Te=new class{constructor(){this.blueDot=null,this.blueDotHideTimeout=null,this.savedSelectionText="",this.selectionTimeout=null;}init(){de.debug("NotesService","åˆå§‹åŒ–ç¬”è®°æœåŠ¡...");try{this.createBlueDot(),this.initSelectionListener(),de.debug("NotesService","âœ“ ç¬”è®°æœåŠ¡åˆå§‹åŒ–æˆåŠŸ");}catch(e){de.error("NotesService","âœ— åˆå§‹åŒ–å¤±è´¥:",e);}}getAllNotes(){try{const e=localStorage.getItem(Ie);return e?JSON.parse(e):[]}catch(e){return console.error("è¯»å–ç¬”è®°æ•°æ®å¤±è´¥:",e),[]}}saveNotes(e){try{const n=JSON.stringify(e);new Blob([n]).size>Me&&(de.warn("NotesService","ç¬”è®°å­˜å‚¨ç©ºé—´è¿‡å¤§ï¼Œæ‰§è¡Œè‡ªåŠ¨æ¸…ç†"),e=this.cleanupNotes(e));try{localStorage.setItem(Ie,JSON.stringify(e));}catch(t){console.error("å­˜å‚¨é…é¢è¶…é™ï¼Œå¼ºåˆ¶æ¸…ç†æ—§æ•°æ®"),e=this.forceCleanupNotes(e),localStorage.setItem(Ie,JSON.stringify(e));}}catch(n){if(console.error("ä¿å­˜ç¬”è®°æ•°æ®å¤±è´¥:",n),"QuotaExceededError"===n.name){console.error("å­˜å‚¨é…é¢å·²æ»¡ï¼Œæ¸…ç†æ—§æ•°æ®åé‡è¯•");const t=this.forceCleanupNotes(e);try{localStorage.setItem(Ie,JSON.stringify(t)),de.debug("NotesService","æ¸…ç†åä¿å­˜æˆåŠŸ");}catch(o){throw console.error("æ¸…ç†åä»ç„¶å¤±è´¥:",o),o}}throw n}}cleanupNotes(e){const t=e.filter(e=>"screenshot"===e.type),n=e.filter(e=>"screenshot"!==e.type),o=t.slice(0,Ce),i=n.slice(0,Ae);return de.debug("NotesService",`æ¸…ç†ç¬”è®°: ä¿ç•™ ${o.length}/${t.length} ä¸ªæˆªå›¾, ${i.length}/${n.length} æ¡æ–‡æœ¬`),[...o,...i].sort((e,t)=>t.timestamp-e.timestamp)}forceCleanupNotes(e){const t=e.filter(e=>"screenshot"===e.type),n=e.filter(e=>"screenshot"!==e.type),o=t.slice(0,5),i=n.slice(0,50);return de.warn("NotesService",`å¼ºåˆ¶æ¸…ç†: ä¿ç•™ ${o.length}/${t.length} ä¸ªæˆªå›¾, ${i.length}/${n.length} æ¡æ–‡æœ¬`),[...o,...i].sort((e,t)=>t.timestamp-e.timestamp)}addNote(e,t){try{let n;if("object"==typeof e){const t=e;n={id:Date.now()+Math.random().toString(36).substr(2,9),content:t.content.trim(),url:t.url||window.location.href,createdAt:Date.now(),type:t.type||"text",...t},n.timestamp||(n.timestamp=n.createdAt),de.info("NotesService",`æ·»åŠ æ–°ç¬”è®°(${n.type})ï¼Œå†…å®¹: ${t.content}`);}else n={id:Date.now()+Math.random().toString(36).substr(2,9),content:e.trim(),url:t,timestamp:Date.now(),type:"text"},de.info("NotesService",`æ·»åŠ æ–°ç¬”è®°ï¼Œå†…å®¹é•¿åº¦: ${e.length}`);let o=this.getAllNotes();if("screenshot"===n.type){const e=o.filter(e=>"screenshot"===e.type);if(e.length>=Ce){de.warn("NotesService",`æˆªå›¾æ•°é‡è¶…è¿‡é™åˆ¶(${Ce})ï¼Œåˆ é™¤æœ€æ—§çš„æˆªå›¾`);const t=e[e.length-1];o=o.filter(e=>e.id!==t.id);}}return o.unshift(n),this.saveNotes(o),de.info("NotesService",`âœ“ ç¬”è®°å·²ä¿å­˜ï¼Œå½“å‰æ€»æ•°: ${o.length}`),n}catch(n){throw de.error("NotesService","âœ— æ·»åŠ ç¬”è®°å¤±è´¥:",n),("QuotaExceededError"===n.name||n.message?.includes("exceeded"))&&(console.error("[NotesService] å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†éƒ¨åˆ†ç¬”è®°"),window.notification&&window.notification.error("å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå·²è‡ªåŠ¨æ¸…ç†éƒ¨åˆ†æ—§ç¬”è®°")),n}}deleteNote(e){const t=this.getAllNotes().filter(t=>t.id!==e);this.saveNotes(t);}deleteNotes(e){const t=this.getAllNotes().filter(t=>!e.includes(t.id));this.saveNotes(t);}getGroupedNotes(){const e=this.getAllNotes(),t={};return e.forEach(e=>{const n=e.createdAt||e.timestamp,o=this.formatDate(n);t[o]||(t[o]=[]),t[o].push(e);}),Object.keys(t).sort((e,n)=>{const o=t[e][0].createdAt||t[e][0].timestamp;return (t[n][0].createdAt||t[n][0].timestamp)-o}).map(e=>({date:e,notes:t[e]}))}formatDate(e){const t=new Date(e),n=new Date,o=new Date(n);if(o.setDate(o.getDate()-1),t.toDateString()===n.toDateString())return "ä»Šå¤©";if(t.toDateString()===o.toDateString())return "æ˜¨å¤©";return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}formatTime(e){const t=new Date(e);return `${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}createBlueDot(){if(de.debug("NotesService","åˆ›å»ºç¬”è®°ä¿å­˜ç‚¹å…ƒç´ ..."),this.blueDot)return de.debug("NotesService","ç¬”è®°ä¿å­˜ç‚¹å…ƒç´ å·²å­˜åœ¨"),this.blueDot;try{return this.blueDot=document.createElement("div"),this.blueDot.id="note-saver-blue-dot",this.blueDot.innerHTML='\n        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">\n          <path d="M20.7 5.2c.4.4.4 1.1 0 1.6l-1 1-3.3-3.3 1-1c.4-.4 1.1-.4 1.6 0l1.7 1.7zm-3.3 2.3L6.7 18.2c-.2.2-.4.3-.7.3H3c-.6 0-1-.4-1-1v-3c0-.3.1-.5.3-.7L13 3.1l3.3 3.3z" stroke="#feebea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="rgba(0,0,0,0.7)"/>\n        </svg>\n      ',this.blueDot.style.cssText="\n        position: absolute;\n        cursor: pointer;\n        z-index: 2147483647;\n        display: none;\n        transition: transform 0.2s, filter 0.2s;\n        pointer-events: auto;\n      ",this.blueDot.addEventListener("mouseenter",()=>{de.debug("NotesService","é¼ æ ‡è¿›å…¥ä¿å­˜ç‚¹"),this.blueDot.style.transform="scale(1.15)",this.blueDot.style.filter="drop-shadow(0 2px 4px rgba(254, 235, 234, 0.5))";}),this.blueDot.addEventListener("mouseleave",()=>{de.debug("NotesService","é¼ æ ‡ç¦»å¼€ä¿å­˜ç‚¹"),this.blueDot.style.transform="scale(1)",this.blueDot.style.filter="none";}),this.blueDot.addEventListener("click",e=>this.handleBlueDotClick(e)),document.body.appendChild(this.blueDot),de.debug("NotesService","âœ“ ç¬”è®°ä¿å­˜ç‚¹å…ƒç´ å·²åˆ›å»ºå¹¶æ·»åŠ åˆ°body"),this.blueDot}catch(e){return de.error("NotesService","âœ— åˆ›å»ºç¬”è®°ä¿å­˜ç‚¹å…ƒç´ å¤±è´¥:",e),null}}showBlueDot(e,t){de.debug("NotesService",`æ˜¾ç¤ºä¿å­˜ç‚¹åœ¨ä½ç½® (${e}, ${t})`);try{const n=this.createBlueDot();if(!n)return void de.error("NotesService","âœ— æ— æ³•è·å–ä¿å­˜ç‚¹å…ƒç´ ");n.style.left=`${e}px`,n.style.top=`${t}px`,n.style.display="block",this.blueDotHideTimeout&&clearTimeout(this.blueDotHideTimeout),this.blueDotHideTimeout=setTimeout(()=>{this.hideBlueDot(),this.savedSelectionText="";},Ee);}catch(n){de.error("NotesService","âœ— æ˜¾ç¤ºä¿å­˜ç‚¹å¤±è´¥:",n);}}hideBlueDot(){try{this.blueDot&&(this.blueDot.style.display="none"),this.blueDotHideTimeout&&(clearTimeout(this.blueDotHideTimeout),this.blueDotHideTimeout=null);}catch(e){de.error("NotesService","âœ— éšè—ä¿å­˜ç‚¹å¤±è´¥:",e);}}handleBlueDotClick(e){de.info("NotesService","ä¿å­˜ç‚¹è¢«ç‚¹å‡» - ä¿å­˜ç¬”è®°");try{if(e&&(e.preventDefault(),e.stopPropagation()),this.savedSelectionText){this.addNote(this.savedSelectionText,window.location.href);this.savedSelectionText="";const e=window.getSelection();e.rangeCount>0&&e.removeAllRanges();}else de.warn("NotesService","âš  æ²¡æœ‰ä¿å­˜çš„é€‰ä¸­æ–‡æœ¬");this.hideBlueDot();}catch(t){de.error("NotesService","âœ— å¤„ç†ä¿å­˜ç‚¹ç‚¹å‡»å¤±è´¥:",t);}}initSelectionListener(){de.debug("NotesService","åˆå§‹åŒ–æ–‡æœ¬é€‰æ‹©ç›‘å¬å™¨...");try{document.addEventListener("mouseup",e=>{const t=e.target.closest(".section-item"),n=e.target.closest(".time-btn, .segment-item, .ai-segments-section");if(t||n)return de.debug("NotesService","ç‚¹å‡»çš„æ˜¯æ—¶é—´æˆ³æ®µè½ï¼Œå¿½ç•¥æ–‡å­—é€‰æ‹©"),void this.hideBlueDot();this.selectionTimeout&&clearTimeout(this.selectionTimeout);const o=e.clientX,i=e.clientY;this.selectionTimeout=setTimeout(()=>{try{const e=window.getSelection(),t=e.toString().trim();if(t&&e.rangeCount>0){de.debug("NotesService",`æ£€æµ‹åˆ°æ–‡æœ¬é€‰æ‹©: "${t.substring(0,30)}${t.length>30?"...":""}"`),this.savedSelectionText=t;const e=o+window.scrollX+10,n=i+window.scrollY+10;this.showBlueDot(e,n);}else this.savedSelectionText="",this.hideBlueDot();}catch(e){de.error("NotesService","âœ— å¤„ç†æ–‡æœ¬é€‰æ‹©å¤±è´¥:",e);}},100);}),document.addEventListener("mousedown",e=>{const t=e.target.closest(".section-item"),n=e.target.closest(".time-btn, .segment-item, .ai-segments-section");t||n?de.debug("NotesService","mousedown åœ¨æ®µè½å…ƒç´ ä¸Šï¼Œå¿½ç•¥"):this.blueDot&&(e.target===this.blueDot||this.blueDot.contains(e.target))||(this.savedSelectionText="",this.hideBlueDot());}),de.debug("NotesService","âœ“ æ–‡æœ¬é€‰æ‹©ç›‘å¬å™¨å·²åˆå§‹åŒ–");}catch(e){de.error("NotesService","âœ— åˆå§‹åŒ–æ–‡æœ¬é€‰æ‹©ç›‘å¬å™¨å¤±è´¥:",e);}}saveSubtitleNote(e){return this.addNote(e,window.location.href)}};const Le=new class{constructor(){this.cache=new Map,this.cacheTimeout=5e3;}get(e,t=false){const n=this.cache.get(e);if(!t&&n&&n.timestamp>Date.now()-this.cacheTimeout&&n.element&&document.contains(n.element))return n.element;const o=document.querySelector(e);return o&&this.cache.set(e,{element:o,timestamp:Date.now()}),o}getAll(e,t=false){const n=`all:${e}`,o=this.cache.get(n);if(!t&&o&&o.timestamp>Date.now()-this.cacheTimeout)return o.elements;const i=Array.from(document.querySelectorAll(e));return this.cache.set(n,{elements:i,timestamp:Date.now()}),i}clear(e){e?(this.cache.delete(e),this.cache.delete(`all:${e}`)):this.cache.clear();}clearExpired(){const e=Date.now();for(const[t,n]of this.cache.entries())n.timestamp<=e-this.cacheTimeout&&this.cache.delete(t);}preload(e){e.forEach(e=>{this.get(e,true);});}},$e=.1,Be=1.5,Ne=200,Pe=1e3,ze=10;const De=new class{constructor(){this.state={baseSpeed:1,isRightOptionPressed:false,isTempBoosted:false,lastKeyPressTime:{comma:0,period:0},lastOptionPressTime:0,optionDoubleClickTimer:null},this.observer=null;}init(){this.bindKeyboardEvents(),this.observeMediaElements(),this.applySpeedToExistingMedia();}getMediaElements(){return Le.getAll("video, audio",false)}applySpeed(e){this.getMediaElements().forEach(t=>{t.playbackRate=e,this.showSpeedIndicator(t,e);});const t=new CustomEvent("speed-changed",{detail:{speed:e,baseSpeed:this.state.baseSpeed}});document.dispatchEvent(t);}showSpeedIndicator(e,t){const n=e.parentElement?.querySelector(".speed-indicator");n&&n.remove();const o=document.createElement("div");if(o.className="speed-indicator",o.textContent=`${t.toFixed(2)}x`,o.style.cssText="\n      position: absolute;\n      top: 10px;\n      left: 10px;\n      background: rgba(0, 0, 0, 0.7);\n      color: white;\n      padding: 4px 8px;\n      border-radius: 4px;\n      font-size: 14px;\n      font-family: monospace;\n      z-index: 999999;\n      pointer-events: none;\n      transition: opacity 0.3s;\n    ",e.parentElement){"static"===window.getComputedStyle(e.parentElement).position&&(e.parentElement.style.position="relative"),e.parentElement.appendChild(o),setTimeout(()=>{o.style.opacity="0",setTimeout(()=>{o.remove();},300);},Pe);}}adjustBaseSpeed(e){this.state.baseSpeed=Math.max(.1,Math.min(ze,this.state.baseSpeed+e)),this.applySpeed(this.calculateFinalSpeed());}setBaseSpeed(e){this.state.baseSpeed=Math.max(.1,Math.min(ze,e)),this.applySpeed(this.calculateFinalSpeed());}applyTemporaryBoost(){this.state.isTempBoosted=true,this.applySpeed(this.calculateFinalSpeed());}removeTemporaryBoost(){this.state.isTempBoosted=false,this.applySpeed(this.calculateFinalSpeed());}applyPermanentBoost(){this.state.baseSpeed=Math.min(ze,this.state.baseSpeed*Be),this.applySpeed(this.calculateFinalSpeed());}resetToNormalSpeed(){this.state.baseSpeed=1,this.applySpeed(this.calculateFinalSpeed());}setToDoubleSpeed(){this.state.baseSpeed=2,this.applySpeed(this.calculateFinalSpeed());}detectDoubleClick(e){const t=Date.now(),n=this.state.lastKeyPressTime[e];return this.state.lastKeyPressTime[e]=t,t-n<Ne}calculateFinalSpeed(){let e=this.state.baseSpeed;return this.state.isTempBoosted&&(e*=Be),Math.min(ze,e)}bindKeyboardEvents(){document.addEventListener("keydown",e=>this.handleKeyDown(e),true),document.addEventListener("keyup",e=>this.handleKeyUp(e),true);}handleKeyDown(e){if("AltRight"!==e.code||2!==e.location){if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&!e.target.isContentEditable)return "Period"===e.code?(e.preventDefault(),void(this.detectDoubleClick("period")?this.setToDoubleSpeed():this.adjustBaseSpeed($e))):"Comma"===e.code?(e.preventDefault(),void(this.detectDoubleClick("comma")?this.resetToNormalSpeed():this.adjustBaseSpeed(-0.1))):void 0}else if(!this.state.isRightOptionPressed){this.state.isRightOptionPressed=true;const e=Date.now();e-this.state.lastOptionPressTime<Ne?(this.applyPermanentBoost(),this.state.optionDoubleClickTimer&&(clearTimeout(this.state.optionDoubleClickTimer),this.state.optionDoubleClickTimer=null)):this.applyTemporaryBoost(),this.state.lastOptionPressTime=e;}}handleKeyUp(e){"AltRight"!==e.code||2!==e.location||this.state.isRightOptionPressed&&(this.state.isRightOptionPressed=false,this.state.optionDoubleClickTimer=setTimeout(()=>{!this.state.isRightOptionPressed&&this.state.isTempBoosted&&this.removeTemporaryBoost();},Ne));}observeMediaElements(){this.observer=new MutationObserver(()=>{this.getMediaElements().forEach(e=>{const t=this.calculateFinalSpeed();Math.abs(e.playbackRate-t)>.01&&(e.playbackRate=t);});}),this.observer.observe(document.body,{childList:true,subtree:true});}applySpeedToExistingMedia(){this.getMediaElements().forEach(e=>{e.playbackRate=this.state.baseSpeed;});}getCurrentSpeed(){return this.calculateFinalSpeed()}getState(){return {baseSpeed:this.state.baseSpeed,finalSpeed:this.calculateFinalSpeed(),isTempBoosted:this.state.isTempBoosted}}destroy(){de.debug("SpeedControl","å¼€å§‹æ¸…ç†èµ„æº"),this.observer&&(this.observer.disconnect(),this.observer=null),de.debug("SpeedControl","èµ„æºæ¸…ç†å®Œæˆ");}},_e="sponsorblock_settings";const qe=new class{constructor(){this.settings=this.loadSettings();}loadSettings(){const e=GM_getValue(_e,null);return e?JSON.parse(e):{...Z.DEFAULT_SETTINGS}}saveSettings(e){this.settings=e,GM_setValue(_e,JSON.stringify(e));}get(e){return this.settings[e]}set(e,t){this.settings[e]=t,this.saveSettings(this.settings);}getAll(){return {...this.settings}}setAll(e){this.saveSettings(e);}resetToDefaults(){this.saveSettings({...Z.DEFAULT_SETTINGS});}};class Re{constructor(){this.cache=new Map,this.pendingRequests=new Map;}async fetchSegments(e){const t=this.cache.get(e);if(t&&Date.now()-t.timestamp<Z.CACHE_EXPIRY)return t.data;if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const n=new Promise((t,n)=>{GM_xmlhttpRequest({method:"GET",url:`${Z.API_URL}?videoID=${e}`,headers:{origin:"userscript-bilibili-sponsor-skip","x-ext-version":"1.0.0"},timeout:5e3,onload:o=>{try{if(404===o.status){const n=[];this.cache.set(e,{data:n,timestamp:Date.now()}),t(n);}else if(200===o.status){const n=JSON.parse(o.responseText);this.cache.set(e,{data:n,timestamp:Date.now()}),t(n);}else 400===o.status?(console.error("[SponsorBlock] å‚æ•°é”™è¯¯ (400)"),n(new Error("Bad request"))):429===o.status?(console.error("[SponsorBlock] è¯·æ±‚é¢‘ç¹ (429)"),n(new Error("Rate limited"))):n(new Error(`HTTP ${o.status}`));}catch(i){n(i);}},onerror:n,ontimeout:()=>n(new Error("Timeout"))});});return this.pendingRequests.set(e,n),n.finally(()=>{this.pendingRequests.delete(e);}),n}hasSegments(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<Z.CACHE_EXPIRY?t.data.length>0:null}clearCache(){this.cache.clear();}}class Oe{constructor(e,t){this.api=e,this.config=t,this.video=null,this.segments=[],this.currentBVID=null,this.lastSkipTime=0,this.checkInterval=null,this.rafId=null,this.currentPrompt=null,this.promptedSegments=new Set,this.ignoredSegments=new Set,this.progressBar=null,this.markerContainer=null,this.playerObserver=null;}async init(){if(location.pathname.includes("/video/")&&(this.currentBVID=location.pathname.match(/video\/(BV\w+)/)?.[1],this.currentBVID)){await this.waitForVideo();try{this.segments=await this.api.fetchSegments(this.currentBVID),this.segments.length>0&&this.renderProgressMarkers();}catch(e){console.error("[SponsorBlock] è·å–ç‰‡æ®µå¤±è´¥:",e),this.segments=[];}this.startMonitoring(),this.setupPlayerObserver();}}setupPlayerObserver(){const e=document.querySelector(".bpx-player-video-wrap")||document.querySelector(".bpx-player-container");e&&(this.playerObserver=new MutationObserver(()=>{this.segments.length>0&&!document.querySelector("#sponsorblock-preview-bar")&&this.renderProgressMarkers();}),this.playerObserver.observe(e,{childList:true,subtree:true}));}async waitForVideo(){return new Promise(e=>{const t=()=>{this.video=document.querySelector(J),this.video?e():setTimeout(t,500);};t();})}renderProgressMarkers(){if(!this.config.get("showProgressMarkers"))return;const e=(t=0)=>{const n=document.querySelector(".bpx-player-progress-schedule");n?(this.progressBar=n,document.querySelectorAll("#sponsorblock-preview-bar").forEach(e=>e.remove()),this.markerContainer=document.createElement("ul"),this.markerContainer.id="sponsorblock-preview-bar",n.prepend(this.markerContainer),this.video.duration&&this.video.duration>0?this.createSegmentMarkers():this.video.addEventListener("loadedmetadata",()=>{this.createSegmentMarkers();},{once:true})):t<10&&setTimeout(()=>e(t+1),1e3);};e();}createSegmentMarkers(){if(!this.markerContainer||!this.video.duration||this.video.duration<=0)return;this.markerContainer.innerHTML="";const e=this.video.duration;[...this.segments].sort((e,t)=>t.segment[1]-t.segment[0]-(e.segment[1]-e.segment[0])).forEach((t,n)=>{const o=Math.min(e,t.segment[0]),i=Math.min(e,t.segment[1]),s=o/e*100,r=100*(1-i/e),a=document.createElement("li");a.className="sponsorblock-segment",a.dataset.segmentIndex=n.toString();const l=Z.CATEGORIES[t.category]||{name:t.category,color:"#999"};a.style.position="absolute",a.style.left=`${s}%`,a.style.right=`${r}%`,a.style.backgroundColor=l.color;const c=i-o;a.title=`${l.name}\n${o.toFixed(1)}s - ${i.toFixed(1)}s (${c.toFixed(1)}s)`,a.addEventListener("click",e=>{e.stopPropagation(),this.showSegmentDetails(t);}),this.markerContainer.appendChild(a);});}showSegmentDetails(e){const t=document.querySelector(".segment-details-popup");t&&(t.remove(),document.querySelector(".segment-details-overlay")?.remove());const n=Z.CATEGORIES[e.category]||{name:e.category,color:"#999"},o=e.segment[1]-e.segment[0],i=be(e.segment[0]),s=be(e.segment[1]),r=document.createElement("div");r.className="segment-details-overlay",r.onclick=()=>this.closeSegmentDetails();const a=document.createElement("div");a.className="segment-details-popup",a.onclick=e=>e.stopPropagation(),a.innerHTML=`\n      <div class="segment-details-header">\n        <div class="segment-details-title">\n          <div style="width: 16px; height: 16px; background: ${n.color}; border-radius: 3px;"></div>\n          <span>${n.name}</span>\n        </div>\n        <button class="segment-details-close">Ã—</button>\n      </div>\n      <div class="segment-details-content">\n        <div class="segment-details-row">\n          <span class="segment-details-label">å¼€å§‹æ—¶é—´</span>\n          <span class="segment-details-value">${i}</span>\n        </div>\n        <div class="segment-details-row">\n          <span class="segment-details-label">ç»“æŸæ—¶é—´</span>\n          <span class="segment-details-value">${s}</span>\n        </div>\n        <div class="segment-details-row">\n          <span class="segment-details-label">æ—¶é•¿</span>\n          <span class="segment-details-value">${o.toFixed(1)} ç§’</span>\n        </div>\n        <div class="segment-details-row">\n          <span class="segment-details-label">æŠ•ç¥¨æ•°</span>\n          <span class="segment-details-value">${e.votes}</span>\n        </div>\n        <div class="segment-details-row">\n          <span class="segment-details-label">UUID</span>\n          <span class="segment-details-value" style="font-size: 11px; font-family: monospace;">${e.UUID.substring(0,20)}...</span>\n        </div>\n      </div>\n      <div class="segment-details-actions">\n        <button class="segment-details-btn segment-details-btn-secondary" data-action="close">\n          å…³é—­\n        </button>\n        <button class="segment-details-btn segment-details-btn-primary" data-action="jump">\n          è·³è½¬åˆ°æ­¤ç‰‡æ®µ\n        </button>\n      </div>\n    `,document.body.appendChild(r),document.body.appendChild(a),a.querySelector(".segment-details-close").onclick=()=>this.closeSegmentDetails(),a.querySelector('[data-action="close"]').onclick=()=>this.closeSegmentDetails(),a.querySelector('[data-action="jump"]').onclick=()=>{this.video&&(this.video.currentTime=e.segment[0]),this.closeSegmentDetails();};const l=e=>{"Escape"===e.key&&(this.closeSegmentDetails(),document.removeEventListener("keydown",l));};document.addEventListener("keydown",l);}closeSegmentDetails(){document.querySelector(".segment-details-popup")?.remove(),document.querySelector(".segment-details-overlay")?.remove();}startMonitoring(){if(!this.video)return;const e=()=>{this.checkAndSkip(),this.rafId=requestAnimationFrame(e);};this.rafId=requestAnimationFrame(e),de.debug("SponsorBlock","å¼€å§‹ç›‘æ§ï¼ˆä½¿ç”¨RAFï¼‰");}checkAndSkip(){if(!this.video||this.video.paused)return;const e=this.video.currentTime,t=this.config.get("skipCategories")||[];for(const n of this.segments)if(e>=n.segment[0]&&e<n.segment[1]){const e=`${n.UUID}`;if(this.ignoredSegments.has(e))continue;if(t.includes(n.category)){if(Date.now()-this.lastSkipTime<1e3)continue;const e=n.segment[1];this.video.currentTime=e,this.lastSkipTime=Date.now(),this.showSkipToast(n);break}this.promptedSegments.has(e)||(this.showSkipPrompt(n),this.promptedSegments.add(e));continue}}showSkipToast(e){const t=Z.CATEGORIES[e.category]||{name:e.category},n=document.createElement("div");n.className="skip-toast",n.textContent=`å·²è·³è¿‡ ${t.name}`,n.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault();}),n.addEventListener("mousedown",e=>{e.stopPropagation(),e.preventDefault();});(document.querySelector(".bpx-player-video-wrap")||document.querySelector(".bpx-player-container")||document.body).appendChild(n),setTimeout(()=>{n.classList.add("hiding"),setTimeout(()=>{n.remove();},300);},3e3);}showSkipPrompt(e){this.closePrompt();const t=Z.CATEGORIES[e.category]||{name:e.category,color:"#999"},n=document.createElement("div");n.className="skip-prompt";const o=e.segment[1]-e.segment[0],i=be(e.segment[0]),s=be(e.segment[1]);n.innerHTML=`\n      <div class="skip-prompt-header">\n        <div class="skip-prompt-icon">\n          <svg viewBox="0 0 24 24" fill="${t.color}">\n            <path d="M8 5v14l11-7z"/>\n          </svg>\n        </div>\n        <div class="skip-prompt-message">\n          è·³è¿‡${t.name}ï¼Ÿ<br>\n          <small style="color: #999; font-size: 11px;">${i} - ${s}</small>\n        </div>\n        <button class="skip-prompt-close" title="å…³é—­">Ã—</button>\n      </div>\n      <div class="skip-prompt-buttons">\n        <button class="skip-prompt-btn skip-prompt-btn-secondary" data-action="ignore">\n          ä¸è·³è¿‡\n        </button>\n        <button class="skip-prompt-btn skip-prompt-btn-primary" data-action="skip">\n          è·³è¿‡ (${o.toFixed(0)}ç§’)\n        </button>\n      </div>\n    `,n.addEventListener("click",e=>{e.stopPropagation();}),n.addEventListener("mousedown",e=>{e.stopPropagation();});(document.querySelector(".bpx-player-video-wrap")||document.querySelector(".bpx-player-container")||document.body).appendChild(n),this.currentPrompt=n;const r=n.querySelector('[data-action="skip"]'),a=n.querySelector('[data-action="ignore"]'),l=n.querySelector(".skip-prompt-close"),c=()=>{this.video.currentTime=e.segment[1],this.lastSkipTime=Date.now(),this.closePrompt();},d=()=>{this.closePrompt();};r.onclick=c,a.onclick=()=>{const t=`${e.UUID}`;this.ignoredSegments.add(t),this.closePrompt();},l.onclick=d;const p=e=>{"Enter"===e.key?(c(),document.removeEventListener("keydown",p)):"Escape"===e.key&&(d(),document.removeEventListener("keydown",p));};document.addEventListener("keydown",p);const u=setInterval(()=>{this.video&&this.video.currentTime>=e.segment[1]&&(this.closePrompt(),clearInterval(u));},500),h=setTimeout(()=>{this.currentPrompt===n&&this.closePrompt();},5e3);n._cleanup=()=>{clearInterval(u),clearTimeout(h),document.removeEventListener("keydown",p);};}closePrompt(){this.currentPrompt&&(this.currentPrompt._cleanup&&this.currentPrompt._cleanup(),this.currentPrompt.classList.add("hiding"),setTimeout(()=>{this.currentPrompt&&(this.currentPrompt.remove(),this.currentPrompt=null);},300));}destroy(){de.debug("SponsorBlock","é”€æ¯æ’­æ”¾å™¨æ§åˆ¶å™¨"),this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.closePrompt(),this.closeSegmentDetails(),this.markerContainer&&(this.markerContainer.remove(),this.markerContainer=null),this.playerObserver&&(this.playerObserver.disconnect(),this.playerObserver=null),this.promptedSegments.clear(),this.ignoredSegments.clear(),this.segments=[],this.video=null;}}const Fe=new class{constructor(){this.api=new Re,this.playerController=null,this.currentURL=location.href;}async init(){location.pathname.includes("/video/")&&(this.playerController=new Oe(this.api,qe),await this.playerController.init()),this.setupURLMonitor();}setupURLMonitor(){window.addEventListener("popstate",()=>{this.handleURLChange();});const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.handleURLChange();},history.replaceState=(...e)=>{t.apply(history,e),this.handleURLChange();};}handleURLChange(){const e=location.href;e!==this.currentURL&&(this.currentURL=e,this.playerController?.destroy(),this.playerController=null,location.pathname.includes("/video/")&&setTimeout(async()=>{this.playerController=new Oe(this.api,qe),await this.playerController.init();},1e3));}getAPI(){return this.api}};const He=new class{constructor(){this.toastElement=null,this.init();}init(){this.toastElement=document.createElement("div"),this.toastElement.className="notion-toast";}showToast(e,t=c){this.toastElement.textContent=e,document.body.appendChild(this.toastElement),setTimeout(()=>this.toastElement.classList.add("show"),10),setTimeout(()=>{this.toastElement.classList.remove("show"),setTimeout(()=>{this.toastElement.parentNode&&document.body.removeChild(this.toastElement);},300);},t);}success(e){this.showToast(e);}warning(e){this.showToast(e);}error(e,t=false){this.showToast(e,3e3),t&&alert(e);}info(e){this.showToast(e);}handleError(e,t="",n=false,o=false){const i=e instanceof Error?e.message:String(e);console.error(`[Error] ${t}:`,e),n||this.error(i,o);}confirm(e){return window.confirm(e)}};const je=new class{constructor(){this.isProcessing=false;}async captureVideoFrame(){const e=document.querySelector("video");if(!e)throw new Error("æœªæ‰¾åˆ°è§†é¢‘å…ƒç´ ");if(e.readyState<2)throw new Error("è§†é¢‘å°šæœªåŠ è½½");try{const t=800;let n=e.videoWidth,o=e.videoHeight;if(n>t){const i=t/n;n=t,o=Math.floor(e.videoHeight*i);}const i=new OffscreenCanvas(n,o);i.getContext("2d").drawImage(e,0,0,n,o);const s=await i.convertToBlob({type:"image/jpeg",quality:.7}),r=e.currentTime,a=be(r);return de.debug("[Screenshot] æˆªå›¾æˆåŠŸ",{originalSize:`${e.videoWidth}x${e.videoHeight}`,compressedSize:`${n}x${o}`,timestamp:a,blobSize:`${(s.size/1024).toFixed(2)}KB`}),{blob:s,timestamp:r,timeString:a}}catch(t){throw de.error("[Screenshot] æˆªå›¾å¤±è´¥:",t),t}}async captureAndSave(e=false){if(this.isProcessing)He.warning("æˆªå›¾å¤„ç†ä¸­ï¼Œè¯·ç¨å€™");else {this.isProcessing=true;try{const{blob:t,timestamp:n,timeString:o}=await this.captureVideoFrame(),i=await this.blobToBase64(t),s=fe(),r=ye()||"æœªçŸ¥è§†é¢‘",a=s?.bvid||"",l=`[æˆªå›¾] ${o}`,c=Te.addNote({content:l,type:"screenshot",videoTimestamp:n,timeString:o,imageData:i,videoTitle:r,videoBvid:a});return He.success(`æˆªå›¾å·²ä¿å­˜ (${o})`),e&&pe.isNotionConfigured()&&await this.sendToNotion(t,n,o,r),c}catch(t){throw de.error("[Screenshot] æˆªå›¾ä¿å­˜å¤±è´¥:",t),He.error(`æˆªå›¾å¤±è´¥: ${t.message}`),t}finally{this.isProcessing=false;}}}async sendToNotion(e,t,n,o){try{const t=pe.getNotionConfig();if(!t||!t.apiKey||!t.parentPageId)throw new Error("Notionæœªé…ç½®");He.info("æ­£åœ¨ä¸Šä¼ æˆªå›¾åˆ°Notion...");const i=await this.uploadImageToNotion(e,t),s=await this.getOrCreateNotionPage(o,t);await this.appendScreenshotBlock(s,i,n,t),He.success("æˆªå›¾å·²å‘é€åˆ°Notion");}catch(i){de.error("[Screenshot] å‘é€åˆ°Notionå¤±è´¥:",i),He.error(`Notionä¸Šä¼ å¤±è´¥: ${i.message}`);}}async uploadImageToNotion(e,t){const n=await this.blobToBase64(e);return e.size>1048576&&He.warning("æˆªå›¾è¾ƒå¤§ï¼ŒNotionå±•ç¤ºå¯èƒ½å—é™"),n}async getOrCreateNotionPage(e,t){const n=ce.getVideoInfo(),o=n?.bvid;if(!o)throw new Error("æ— æ•ˆçš„è§†é¢‘ä¿¡æ¯");let i=ce.getNotionPageId(o);if(i)return de.debug("[Screenshot] ä½¿ç”¨ç¼“å­˜çš„Notioné¡µé¢ID:",i),i;const s=t.databaseId||t.parentPageId;if(s)try{if(i=await Se.queryVideoPage(t.apiKey,s,o),i)return de.debug("[Screenshot] ä»Notionæ•°æ®åº“æ‰¾åˆ°é¡µé¢:",i),ce.setNotionPageId(o,i),i}catch(r){de.error("[Screenshot] æŸ¥è¯¢Notioné¡µé¢å¤±è´¥:",r);}throw new Error("è¯·å…ˆå‘é€å­—å¹•å’ŒAIæ€»ç»“åˆ°Notionï¼Œä»¥åˆ›å»ºè§†é¢‘é¡µé¢")}async appendScreenshotBlock(e,t,n,o){const i=`https://api.notion.com/v1/blocks/${e}/children`,s={children:[{object:"block",type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:`ğŸ“¸ æˆªå›¾ - ${n}`}}]}},{object:"block",type:"image",image:{type:"external",external:{url:t}}}]};return new Promise((e,t)=>{GM_xmlhttpRequest({method:"PATCH",url:i,headers:{Authorization:`Bearer ${o.apiKey}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"},data:JSON.stringify(s),timeout:3e4,onload:n=>{200===n.status?e(JSON.parse(n.responseText)):t(new Error(`Notion APIé”™è¯¯: ${n.status}`));},onerror:e=>t(e),ontimeout:()=>t(new Error("è¯·æ±‚è¶…æ—¶"))});})}async blobToBase64(e){return new Promise((t,n)=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.onerror=n,o.readAsDataURL(e);})}async downloadScreenshot(){try{const{blob:e,timeString:t}=await this.captureVideoFrame(),n=ce.getVideoInfo(),o=`${(n?.title||"video").replace(/[<>:"/\\|?*]/g,"_")}_${t.replace(/:/g,"-")}.png`,i=URL.createObjectURL(e),s=document.createElement("a");s.href=i,s.download=o,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),He.success("æˆªå›¾å·²ä¸‹è½½");}catch(e){de.error("[Screenshot] ä¸‹è½½å¤±è´¥:",e),He.error(`ä¸‹è½½å¤±è´¥: ${e.message}`);}}};class Ke{constructor(e){this.sponsorAPI=e,this.observer=null,this.statsCache=new Map,this.pendingRequests=new Map,this.abortController=new AbortController,this.processQueue=new Set,this.isProcessing=false;}start(){setTimeout(()=>{this.initScrollHandler(),this.initObserver(),this.checkNewCards();},800);}initScrollHandler(){let e;window.addEventListener("scroll",()=>{clearTimeout(e),e=setTimeout(()=>this.checkNewCards(),200);},{signal:this.abortController.signal});}checkNewCards(){if("hidden"===document.visibilityState)return;document.querySelectorAll("\n      .bili-video-card:not([data-quality-checked]),\n      .video-page-card-small:not([data-quality-checked]),\n      .video-page-card:not([data-quality-checked]),\n      .up-main-video-card:not([data-quality-checked]),\n      .small-item:not([data-quality-checked])\n    ").forEach(e=>{e.dataset.qualityChecked||this.processQueue.add(e);}),this.processNextBatch();}async processNextBatch(){if(this.isProcessing||0===this.processQueue.size)return;this.isProcessing=true;const e=Array.from(this.processQueue).slice(0,5);try{await Promise.all(e.map(e=>this.processCard(e)));}catch(t){}e.forEach(e=>this.processQueue.delete(e)),this.isProcessing=false,this.processQueue.size>0&&setTimeout(()=>this.processNextBatch(),100);}async processCard(e){if("true"===e.dataset.qualityChecked)return;if(!document.body.contains(e))return;e.dataset.qualityChecked="processing";const t=e.querySelector('a[href*="/video/BV"]');if(!t)return void(e.dataset.qualityChecked="true");const n=this.extractBVID(t.href);if(!n)return void(e.dataset.qualityChecked="true");const o=this.findBadgeContainer(e);if(o)try{const[t,i]=await Promise.all([this.fetchVideoStats(n).catch(()=>null),this.sponsorAPI.fetchSegments(n).catch(()=>[])]);if(!document.body.contains(e))return;const s=o.querySelector(".bili-tags-container");s&&s.remove();const r=document.createElement("div");r.className="bili-tags-container";const a=[];if(qe.get("showQualityBadge")&&t&&this.isHighQuality(t)&&a.push(this.createQualityBadge(t)),qe.get("showAdBadge")&&i&&i.length>0){const e=this.createSegmentBadges(i);a.push(...e);}const l=a.length>=3;a.forEach(e=>{l&&e.dataset.emoji&&e.dataset.text&&(e.textContent=e.dataset.emoji,e.classList.add("emoji-only")),r.appendChild(e);}),r.children.length>0&&(o.firstChild?o.insertBefore(r,o.firstChild):o.appendChild(r));}catch(i){}finally{document.body.contains(e)&&(e.dataset.qualityChecked="true");}else e.dataset.qualityChecked="true";}findBadgeContainer(e){return e.classList.contains("up-main-video-card")||e.classList.contains("small-item")?e.querySelector(".cover-container, .cover, .pic-box")||e:e.classList.contains("video-page-card-small")?e.querySelector(".pic-box"):e.classList.contains("video-page-card")?e.querySelector(".pic"):e.querySelector(".bili-video-card__cover, .cover, .pic, .bili-video-card__info")||e.closest(".bili-video-card")?.querySelector(".bili-video-card__cover")}isHighQuality(e){return e?.view>=Z.MIN_VIEWS&&e.like/e.view>=Z.MIN_SCORE}isTopQuality(e){return e?.coin>=e?.like}createQualityBadge(e){const t=document.createElement("span");return t.className="bili-quality-tag",this.isTopQuality(e)?(t.style.background=Z.TOP_TAG_COLOR,t.textContent=Z.TOP_TAG_TEXT,t.dataset.emoji="ğŸ†",t.dataset.text="é¡¶çº§",t.title="é¡¶çº§ä¼˜è´¨è§†é¢‘"):(t.style.background=Z.TAG_COLOR,t.textContent=Z.TAG_TEXT,t.dataset.emoji="ğŸ”¥",t.dataset.text="ç²¾é€‰",t.title="ç²¾é€‰ä¼˜è´¨è§†é¢‘"),t}createSegmentBadges(e){const t={};e.forEach(e=>{t[e.category]=(t[e.category]||0)+1;});const n=[],o={sponsor:{icon:"âš ï¸",text:"å¹¿å‘Š",color:"linear-gradient(135deg, #FF8C00, #FF6347)"},selfpromo:{icon:"ğŸ“¢",text:"æ¨å¹¿",color:"linear-gradient(135deg, #FFD700, #FFA500)"},interaction:{icon:"ğŸ‘†",text:"ä¸‰è¿",color:"linear-gradient(135deg, #9C27B0, #E91E63)"},poi_highlight:{icon:"â­",text:"é«˜å…‰",color:"linear-gradient(135deg, #FF1493, #FF69B4)"},intro:{icon:"â–¶ï¸",text:"å¼€åœº",color:"linear-gradient(135deg, #00CED1, #00BFFF)"},outro:{icon:"ğŸ¬",text:"ç»“å°¾",color:"linear-gradient(135deg, #1E90FF, #4169E1)"},preview:{icon:"ğŸ”„",text:"å›é¡¾",color:"linear-gradient(135deg, #00A1D6, #0087B3)"},filler:{icon:"ğŸ’¬",text:"é—²èŠ",color:"linear-gradient(135deg, #9370DB, #8A2BE2)"},music_offtopic:{icon:"ğŸµ",text:"ééŸ³ä¹",color:"linear-gradient(135deg, #FF8C00, #FF7F50)"},exclusive_access:{icon:"ğŸ¤",text:"åˆä½œ",color:"linear-gradient(135deg, #2E8B57, #3CB371)"},mute:{icon:"ğŸ”‡",text:"é™éŸ³",color:"linear-gradient(135deg, #DC143C, #C71585)"}};return Object.entries(t).forEach(([e,t])=>{const i=o[e]||{icon:"ğŸ“",text:e,color:"linear-gradient(135deg, #888, #666)"},s=document.createElement("span");s.className="bili-ad-tag",s.style.background=i.color,s.dataset.emoji=t>1?`${i.icon}Ã—${t}`:i.icon,s.dataset.text=i.text,s.textContent=`${i.icon} ${i.text}`,t>1&&(s.textContent+=` (${t})`),s.title=`åŒ…å« ${t} ä¸ª${i.text}ç‰‡æ®µ`,n.push(s);}),n}extractBVID(e){try{return new URL(e).pathname.match(/video\/(BV\w+)/)?.[1]}catch{return null}}async fetchVideoStats(e){if(this.statsCache.has(e))return this.statsCache.get(e);if(this.pendingRequests.has(e))return this.pendingRequests.get(e);const t=new Promise((t,n)=>{GM_xmlhttpRequest({method:"GET",url:`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,timeout:5e3,onload:o=>{try{const i=JSON.parse(o.responseText);0===i?.code&&i?.data?.stat?(this.statsCache.set(e,i.data.stat),t(i.data.stat)):n(new Error("Invalid API response"));}catch(i){n(i);}},onerror:n,ontimeout:()=>n(new Error("Timeout"))});});return this.pendingRequests.set(e,t),t.finally(()=>{this.pendingRequests.delete(e);})}initObserver(){this.observer=new MutationObserver(e=>{let t=false;for(const n of e)if(n.addedNodes.length>0){t=true;break}t&&this.checkNewCards();}),this.observer.observe(document.body,{childList:true,subtree:true});}destroy(){this.observer?.disconnect(),this.abortController.abort(),this.processQueue.clear(),this.pendingRequests.clear(),this.statsCache.clear();}}let Ve=null;const Ue=new class{constructor(){this.markedConfigured=false;}renderSubtitlePanel(e){const t=ce.getVideoKey(),n=t?ce.getAISummary(t):null;let o=`\n      <div class="subtitle-header">\n        <div class="subtitle-header-left">\n          <span class="subtitle-status-icon" title="AIåŠ©æ‰‹">${ne}</span>\n        </div>\n        <div class="subtitle-header-right">\n          <div class="subtitle-search-container">\n            <input type="text" class="search-input" placeholder="æœç´¢..." id="subtitle-search-input">\n            <div class="search-controls" id="search-controls" style="display: none;">\n              <span class="search-counter" id="search-counter">0/0</span>\n              <button class="search-nav-btn search-prev" id="search-prev" title="ä¸Šä¸€ä¸ª">\n                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">\n                  <path d="M9 7.5L6 4.5L3 7.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n              </button>\n              <button class="search-nav-btn search-next" id="search-next" title="ä¸‹ä¸€ä¸ª">\n                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5">\n                  <path d="M3 4.5L6 7.5L9 4.5" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n              </button>\n            </div>\n          </div>\n          <div class="subtitle-header-actions">\n            <span class="ai-icon" title="AIé…ç½®">\n              ${te}\n            </span>\n            <span class="download-icon" title="ä¸‹è½½å­—å¹•">\n              ${oe}\n            </span>\n            <span class="notion-icon ${ce.notion.isSending?"loading":""}" title="Notion">\n              ${ie}\n            </span>\n            <span class="subtitle-close">Ã—</span>\n          </div>\n        </div>\n      </div>\n      <div class="subtitle-tabs">\n        <div class="subtitle-tab active" data-tab="summary">è§†é¢‘æ€»ç»“</div>\n        <div class="subtitle-tab" data-tab="subtitles">å­—å¹•åˆ—è¡¨</div>\n      </div>\n      <div class="subtitle-content">\n        <div class="subtitle-panel" id="summary-panel" style="display: block;">\n          ${this.renderAISummaryPanel(n)}\n        </div>\n        <div class="subtitle-panel" id="subtitles-panel" style="display: none;">\n          <div class="subtitle-list-container" id="subtitle-list-container">\n            <div class="original-subtitles-section">\n              <div class="segments-header">å­—å¹•åˆ—è¡¨</div>\n    `;return e.forEach((e,t)=>{const n=be(e.from);o+=`\n        <div class="subtitle-item" data-index="${t}" data-from="${e.from}" data-to="${e.to}">\n          <span class="subtitle-time">${n}</span>\n          <span class="subtitle-text">${e.content}</span>\n          <button class="save-subtitle-note-btn" data-content="${this.escapeHtml(e.content)}" title="ä¿å­˜ä¸ºç¬”è®°">ä¿å­˜</button>\n        </div>\n      `;}),o+='\n              </div>\n            </div>\n            <button class="subtitle-follow-btn" id="subtitle-follow-btn" style="display: none;" title="å›åˆ°å½“å‰æ’­æ”¾ä½ç½®">\n              æ¢å¤æ»šåŠ¨\n            </button>\n          </div>\n        </div>\n      </div>\n    ',o}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}_escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,e=>t[e])}parseMarkdown(e){if(!e)return "";let t=e.trim();if(t=t.replace(/```[a-zA-Z0-9]*\s*```/g,""),t=t.replace(/```\s*\n\s*```/g,""),"undefined"!=typeof marked&&"function"==typeof marked.parse)try{"function"==typeof marked.use&&marked.use({renderer:{link:(e,t,n)=>`<a href="${e}" target="_blank" rel="noopener noreferrer" ${t?`title="${t}"`:""}>${n}</a>`}}),this.markedConfigured||"function"!=typeof marked.setOptions||(marked.setOptions({breaks:!0,gfm:!0}),this.markedConfigured=!0);let e=marked.parse(t);return e=e.replace(/<pre><code[^>]*>\s*<\/code><\/pre>/g,""),e}catch(o){de.warn("UIRenderer","Markedè§£æå¤±è´¥:",o);}let n=t;return n=n.replace(/```([a-zA-Z0-9]*)?\n([\s\S]*?)```/g,(e,t,n)=>{if(!n.trim())return "";return `<pre><code${t?` class="language-${t}"`:""}>${this._escapeHtml(n)}</code></pre>`}),n=n.replace(/^### (.*$)/gim,"<h3>$1</h3>"),n=n.replace(/^## (.*$)/gim,"<h2>$1</h2>"),n=n.replace(/^# (.*$)/gim,"<h1>$1</h1>"),n=n.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),n=n.replace(/(?<!\*)\*(?!\*)([^*]+?)(?<!\*)\*(?!\*)/g,"<em>$1</em>"),n=n.replace(/`([^`]+)`/g,"<code>$1</code>"),n=n.replace(/^\* (.*$)/gim,"<li>$1</li>"),n=n.replace(/^- (.*$)/gim,"<li>$1</li>"),n=n.replace(/^\d+\. (.*$)/gim,"<li>$1</li>"),n=n.replace(/(<li>.*<\/li>(?:\s*<li>.*<\/li>)*)/g,"<ul>$1</ul>"),n=n.replace(/<ul>((?:<li>.*<\/li>\s*)+)<\/ul>/g,(e,n)=>t.split("\n").some(e=>/^\d+\.\s+/.test(e))?`<ol>${n}</ol>`:e),n=n.replace(/\n/g,"<br>"),n}normalizeMarkdown(e){if(!e)return "";let t=String(e).replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim();const n=t.match(/^```[a-zA-Z0-9+_-]*\s*\n([\s\S]*?)\s*```$/);n&&(t=n[1]);const o=t.split("\n"),i=o.filter(e=>e.trim().length>0);if(i.length>0){const e=Math.min(...i.map(e=>e.match(/^ */)[0].length));e>0&&(t=o.map(t=>t.startsWith(" ".repeat(e))?t.slice(e):t).join("\n"));}return t.trim()}renderAISummaryPanel(e=null,t=false){let n="";if(e){let t="",o=[];if("object"==typeof e&&e.markdown)t=this.parseMarkdown(e.markdown),o=e.segments||[];else if("string"==typeof e){t=this.parseAISummary(e).mainSummary;}n='<div class="summary-panel-container">',o&&o.length>0&&(n+=`\n          <div class="ai-segments-in-summary">\n            <div class="segments-header">AIæ—¶é—´æˆ³æ®µè½</div>\n            ${this.renderAISegments(o)}\n            <div class="segments-divider"></div>\n          </div>\n        `),n+=t.trim()?`\n        <div class="ai-summary-main">\n          <div class="summary-content">${t}</div>\n        </div>\n      `:'<div class="ai-summary-empty">æš‚æ— æ€»ç»“å†…å®¹</div>',n+="</div>";}else n='\n        <div class="ai-summary-empty">\n          <p>ç‚¹å‡»ä¸Šæ–¹AIå›¾æ ‡ç”Ÿæˆè§†é¢‘æ€»ç»“</p>\n        </div>\n      ';return n}parseAISummary(e){let t="",n=[];const o=e.match(/\[æ€»ç»“\]([\s\S]*?)(?=\[æ®µè½\]|$)/i),i=e.match(/\[æ®µè½\]([\s\S]*)/i);if(o&&o[1]){const e=o[1].trim();t=this.parseMarkdown(e);}if(i&&i[1]){const e=i[1],t=/\[(\d{1,2}:\d{2}(?::\d{2})?)\]\s*([^\n]+?)(?:\n\s+([^\[]+?))?(?=\[|$)/g;let o;for(;null!==(o=t.exec(e));){const[e,t,i,s]=o;let r=t;const a=t.split(":");if(2===a.length)r=`[${a[0].padStart(2,"0")}:${a[1].padStart(2,"0")}]`;else if(3===a.length){r=`[${(60*parseInt(a[0])+parseInt(a[1])).toString().padStart(2,"0")}:${a[2].padStart(2,"0")}]`;}const l=i.trim(),c=s?s.trim():"";n.push({title:l,time:r,content:c});}}if(!t&&0===n.length){const o=e.split("\n");let i=[],s=false;for(const e of o){const t=e.trim();if(t.match(/^\[\d{1,2}:\d{2}(?::\d{2})?\]/)){s=true;const e=t.match(/^\[(\d{1,2}:\d{2}(?::\d{2})?)\]\s*(.*)/);if(e){const[t,o,i]=e;let s=o;const r=o.split(":");if(2===r.length)s=`[${r[0].padStart(2,"0")}:${r[1].padStart(2,"0")}]`;else if(3===r.length){s=`[${(60*parseInt(r[0])+parseInt(r[1])).toString().padStart(2,"0")}:${r[2].padStart(2,"0")}]`;}n.push({title:i.trim(),time:s,content:""});}}else s?n.length>0&&e.startsWith("  ")&&(n[n.length-1].content+=(n[n.length-1].content?" ":"")+t):i.push(e);}i.length>0&&(t=this.parseMarkdown(i.join("\n").trim()));}if(!t&&0===n.length){const o=e.split(/##\s*è¦ç‚¹/i);if(o.length>=2){const e=o[0].replace(/##\s*æ€»ç»“/i,"").trim();t=this.parseMarkdown(e);const i=o[1].matchAll(/###\s*\[?([^\]\n]+)\]?[\s\S]*?-\s*æ—¶é—´[ï¼š:]\s*\[(\d{1,2}):(\d{2})\][\s\S]*?-\s*å†…å®¹[ï¼š:]\s*([^\n]+)/gi);for(const t of i){const[e,o,i,s,r]=t;n.push({title:o.trim(),time:`[${i.padStart(2,"0")}:${s.padStart(2,"0")}]`,content:r.trim()});}}}return t||0!==n.length||(t=this.parseMarkdown(e)),{mainSummary:t,keyPoints:n}}renderAISummarySection(e=null,t=false){const n=document.createElement("div");return n.className="ai-summary-section",n.innerHTML=this.renderAISummaryPanel(e,t),n}updateAISummary(e,t){if(e||(e=document.getElementById("subtitle-container")),!e)return;const n=e.querySelector("#summary-panel");n&&(n.innerHTML=this.renderAISummaryPanel(t,false));}renderAISegments(e){return e.map((e,t)=>{const n=(e.timestamp||"[00:00]").replace(/[\[\]]/g,"");return `\n        <div class="section-item" data-time="${e.timestamp||"[00:00]"}" data-index="${t}">\n          <button class="time-btn">${n}</button>\n          <div class="item-content">\n            ${e.summary?`<span class="item-title">${e.title||""}</span>\n               <span class="item-desc">${e.summary}</span>`:`<span class="item-single">${e.title||""}</span>`}\n          </div>\n        </div>\n      `}).join("")}createNotification(e){const t=document.createElement("div");return t.className="notion-toast show",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove();},3e3),t}createNotionConfigModal(){const e=document.createElement("div");return e.id="notion-config-modal",e.className="config-modal",e.innerHTML='\n      <div class="config-modal-content">\n        <div class="config-modal-header">\n          <span>Notion é›†æˆé…ç½®</span>\n        </div>\n        <div class="config-modal-body">\n          <div class="config-field">\n            <label>1ï¸âƒ£ Notion API Key</label>\n            <input type="password" id="notion-api-key" placeholder="è¾“å…¥ä½ çš„ Integration Token">\n            <div class="config-help">\n              è®¿é—® <a href="https://www.notion.so/my-integrations" target="_blank">Notion Integrations</a> åˆ›å»º Integration å¹¶å¤åˆ¶ Token\n            </div>\n          </div>\n          <div class="config-field">\n            <label>2ï¸âƒ£ ç›®æ ‡ä½ç½®ï¼ˆäºŒé€‰ä¸€ï¼‰</label>\n            <input type="text" id="notion-parent-page-id" placeholder="Page ID æˆ– Database ID">\n            <div class="config-help">\n              <strong>æ–¹å¼A - ä½¿ç”¨å·²æœ‰æ•°æ®åº“ï¼š</strong><br>\n              ä»æ•°æ®åº“ URL ä¸­è·å–ï¼š<code>notion.so/<strong>abc123...</strong>?v=...</code><br>\n              è„šæœ¬ä¼šç›´æ¥å‘è¯¥æ•°æ®åº“æ·»åŠ è®°å½•\n            </div>\n            <div class="config-help" style="margin-top: 8px;">\n              <strong>æ–¹å¼B - è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼š</strong><br>\n              ä»é¡µé¢ URL ä¸­è·å–ï¼š<code>notion.so/My-Page-<strong>abc123...</strong></code><br>\n              é¦–æ¬¡ä½¿ç”¨ä¼šåœ¨æ­¤é¡µé¢ä¸‹åˆ›å»ºæ•°æ®åº“\n            </div>\n            <div class="config-help" style="margin-top: 8px; color: #f59e0b;">\n              âš ï¸ é‡è¦ï¼šéœ€è¦åœ¨ã€ŒShareã€ä¸­é‚€è¯·ä½ çš„ Integration\n            </div>\n          </div>\n        <div class="config-field">\n          <label>\n            <input type="checkbox" id="notion-auto-send-enabled">\n            è‡ªåŠ¨å‘é€ï¼ˆè·å–å­—å¹•åè‡ªåŠ¨å‘é€åˆ°Notionï¼‰\n          </label>\n        </div>\n          <div id="notion-status-message"></div>\n        </div>\n        <div class="config-footer">\n          <button class="config-btn config-btn-secondary" id="notion-cancel-btn">å–æ¶ˆ</button>\n          <button class="config-btn config-btn-primary" id="notion-save-btn">ä¿å­˜é…ç½®</button>\n        </div>\n      </div>\n    ',e}createAIConfigModal(){const e=document.createElement("div");return e.id="ai-config-modal",e.className="config-modal",e.innerHTML='\n      <div class="config-modal-content">\n        <div class="config-modal-header">\n          <span>AI é…ç½®ç®¡ç†</span>\n        </div>\n        <div class="config-modal-body">\n          <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(255, 77, 77, 0.15)); border-radius: 10px; border-left: 4px solid #ff6b6b;">\n            <div style="font-size: 14px; color: #fff; font-weight: 600; margin-bottom: 8px;">âš ï¸ é¦–æ¬¡ä½¿ç”¨å¿…è¯»</div>\n            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.9); line-height: 1.6; margin-bottom: 8px;">\n              â€¢ ä½¿ç”¨AIæ€»ç»“åŠŸèƒ½å‰ï¼Œéœ€è¦å…ˆé…ç½®API Key<br>\n              â€¢ é€‰æ‹©ä¸€ä¸ªAIæœåŠ¡å•†ï¼Œç‚¹å‡»æŸ¥çœ‹å…¶é…ç½®ï¼Œå¡«å†™API Keyåä¿å­˜<br>\n              â€¢ æ¨èä½¿ç”¨ <strong>OpenRouter</strong>ã€<strong>DeepSeek</strong> æˆ– <strong>ç¡…åŸºæµåŠ¨</strong>ï¼ˆæä¾›å…è´¹é¢åº¦ï¼‰\n            </div>\n            <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-top: 8px;">\n              ğŸ’¡ æç¤ºï¼šç‚¹å‡»é…ç½®å¡ç‰‡å¯æŸ¥çœ‹è¯¦æƒ…å’Œè·å–API Keyçš„æ•™ç¨‹é“¾æ¥\n            </div>\n          </div>\n          <div class="ai-config-list" id="ai-config-list"></div>\n          <div style="margin-bottom: 15px; text-align: center; display: flex; gap: 10px; justify-content: center;">\n            <button class="config-btn config-btn-primary" id="ai-start-summary-btn" style="padding: 8px 20px; font-size: 14px; font-weight: 600;">ğŸš€ å¼€å§‹æ€»ç»“</button>\n            <button class="config-btn config-btn-secondary" id="ai-new-config-btn" style="padding: 8px 16px; font-size: 13px;">æ–°å»ºé…ç½®</button>\n          </div>\n          <div class="ai-config-form hidden">\n          <div class="config-field">\n            <label>é…ç½®åç§°</label>\n            <input type="text" id="ai-config-name" placeholder="ä¾‹å¦‚ï¼šOpenAI GPT-4">\n          </div>\n          <div class="config-field">\n            <label>API URL</label>\n            <input type="text" id="ai-config-url" placeholder="https://api.openai.com/v1/chat/completions">\n          </div>\n          <div class="config-field">\n            <label>API Key <span id="api-key-help-link" style="font-size: 11px; margin-left: 8px;"></span></label>\n            <input type="password" id="ai-config-apikey" placeholder="sk-...">\n          </div>\n          <div class="config-field">\n            <label>æ¨¡å‹</label>\n            <div class="model-field-with-button">\n              <input type="text" id="ai-config-model" placeholder="æ‰‹åŠ¨è¾“å…¥æˆ–ç‚¹å‡»è·å–æ¨¡å‹">\n              <button class="fetch-models-btn" id="fetch-models-btn">è·å–æ¨¡å‹</button>\n            </div>\n            <div class="model-select-wrapper" id="model-select-wrapper" style="display:none;">\n              <input type="text" id="model-search-input" class="model-search-input" placeholder="ğŸ” æœç´¢æ¨¡å‹...">\n              <select id="model-select" size="8"></select>\n            </div>\n          </div>\n          <div class="config-field">\n            <label>\n              <input type="checkbox" id="ai-config-is-openrouter">\n              ä½¿ç”¨OpenRouter (æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨)\n            </label>\n          </div>\n          <div class="config-field">\n            <label>æ€»ç»“æç¤ºè¯ (Markdownæ€»ç»“)</label>\n            <textarea id="ai-config-prompt1" placeholder="è¯·ç”¨ä¸­æ–‡æ€»ç»“ä»¥ä¸‹è§†é¢‘å­—å¹•å†…å®¹ï¼Œä½¿ç”¨Markdownæ ¼å¼è¾“å‡º..."></textarea>\n          </div>\n          <div class="config-field">\n            <label>æ®µè½æç¤ºè¯ (JSONæ—¶é—´æ®µè½)</label>\n            <textarea id="ai-config-prompt2" placeholder="è¯·æ ¹æ®ä»¥ä¸‹å¸¦æ—¶é—´æˆ³çš„è§†é¢‘å­—å¹•å†…å®¹ï¼Œæå–å…³é”®æ—¶é—´ç‚¹æ®µè½..."></textarea>\n          </div>\n          <div class="config-field">\n            <label>\n              <input type="checkbox" id="ai-auto-summary-enabled">\n              è‡ªåŠ¨æ€»ç»“ï¼ˆè·å–å­—å¹•åè‡ªåŠ¨è§¦å‘AIæ€»ç»“ï¼‰\n            </label>\n          </div>\n          </div>\n        </div>\n        <div class="config-footer">\n          <button class="config-btn config-btn-danger" id="ai-delete-current-btn" style="display:none;">åˆ é™¤æ­¤é…ç½®</button>\n          <div style="flex: 1;"></div>\n          <button class="config-btn config-btn-secondary" id="ai-cancel-btn">å–æ¶ˆ</button>\n          <button class="config-btn config-btn-primary" id="ai-save-new-btn">æ·»åŠ æ–°é…ç½®</button>\n          <button class="config-btn config-btn-primary" id="ai-update-btn" style="display:none;">æ›´æ–°é…ç½®</button>\n        </div>\n      </div>\n    ',e}renderAIConfigList(e){const t=pe.getAIConfigs(),n=pe.getSelectedAIConfigId();e.innerHTML=t.map(e=>{const t=e.apiKey&&""!==e.apiKey.trim(),o=t?"âœ…":"âš ï¸",i=t?"å·²é…ç½®":"æœªé…ç½®",s=t?"#4ade80":"#fbbf24";return `\n        <div class="ai-config-item ${e.id===n?"selected":""}" data-id="${e.id}">\n          <div class="ai-config-item-name">\n            ${e.name}\n            <span style="font-size: 11px; color: ${s}; margin-left: 8px;" title="API Key ${i}">\n              ${o} ${i}\n            </span>\n          </div>\n          <div class="ai-config-item-actions">\n            <button class="ai-config-btn-small config-btn-primary ai-edit-btn" data-id="${e.id}">æŸ¥çœ‹</button>\n          </div>\n        </div>\n      `}).join("");}showNotionStatus(e,t=false){const n=document.getElementById("notion-status-message");n&&(n.className="config-status "+(t?"error":"success"),n.textContent=e);}renderShortcutConfigModal(){if(de.debug("UIRenderer","renderShortcutConfigModal å¼€å§‹"),!ge)return console.error("[UIRenderer] shortcutManager æœªå®šä¹‰"),null;let e;try{e=ge.getAllShortcuts(),de.debug("UIRenderer","è·å–åˆ°å¿«æ·é”®:",e);}catch(t){return console.error("[UIRenderer] è·å–å¿«æ·é”®å¤±è´¥:",t),null}return e&&"object"==typeof e?`\n      <div class="config-modal" id="shortcut-config-modal">\n        <div class="config-modal-content">\n          <div class="config-modal-header">\n            <span class="config-modal-title">å¿«æ·é”®è®¾ç½®</span>\n            <button class="config-modal-close">Ã—</button>\n          </div>\n          <div class="config-modal-body">\n            <div style="margin-bottom: 20px; padding: 15px; background: rgba(254, 235, 234, 0.1); border-radius: 10px; border-left: 4px solid #feebea;">\n              <div style="font-size: 13px; color: #fff; font-weight: 600; margin-bottom: 4px;">ä½¿ç”¨è¯´æ˜</div>\n              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); line-height: 1.5;">\n                ç‚¹å‡»è¾“å…¥æ¡†åæŒ‰ä¸‹æƒ³è¦çš„ç»„åˆé”®å³å¯è®¾ç½®ã€‚ç‰¹æ®Šç»„åˆé”®ï¼š<br/>\n                â€¢ æˆªå›¾ï¼šè¿æŒ‰ä¸¤ä¸‹ / é”®<br/>\n                â€¢ åŒå‡»æ“ä½œï¼šå¿«é€Ÿè¿ç»­æŒ‰ä¸¤æ¬¡åŒä¸€ä¸ªé”®\n              </div>\n            </div>\n            \n            <div style="display: flex; flex-direction: column; gap: 12px;">\n              ${Object.entries(e).map(([e,t])=>`\n                <div class="shortcut-item" data-key="${e}">\n                  <div class="shortcut-description">${t.description}</div>\n                  <div class="shortcut-controls">\n                    <input \n                      type="text" \n                      class="shortcut-input" \n                      value="${ge.formatShortcut(t)}" \n                      readonly \n                      placeholder="ç‚¹å‡»è®¾ç½®"\n                      data-key="${e}"\n                    >\n                    <button class="shortcut-reset-btn" data-key="${e}">é‡ç½®</button>\n                  </div>\n                </div>\n              `).join("")}\n            </div>\n            \n            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">\n              <button class="config-btn config-btn-secondary" id="reset-all-shortcuts">\n                é‡ç½®æ‰€æœ‰å¿«æ·é”®\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `:(console.error("[UIRenderer] å¿«æ·é”®é…ç½®æ— æ•ˆ:",e),null)}};const Ge=new class{constructor(){this.stack=[],this.escHandler=null,this.init();}init(){this.escHandler=e=>{if("Escape"===e.key&&this.stack.length>0){const e=this.stack[this.stack.length-1];e&&"function"==typeof e.hide&&e.hide();}},document.addEventListener("keydown",this.escHandler);}push(e){if(!e||"function"!=typeof e.hide)return void de.warn("ModalManager","æ¨¡æ€æ¡†å®ä¾‹å¿…é¡»æœ‰hideæ–¹æ³•");-1===this.stack.indexOf(e)&&this.stack.push(e);}pop(e){const t=this.stack.indexOf(e);t>-1&&this.stack.splice(t,1);}closeAll(){for(;this.stack.length>0;){const e=this.stack.pop();e&&"function"==typeof e.hide&&e.hide();}}getStackSize(){return this.stack.length}isInStack(e){return this.stack.includes(e)}destroy(){this.escHandler&&(document.removeEventListener("keydown",this.escHandler),this.escHandler=null),this.stack=[];}};const Je=new class{constructor(){this.panel=null,this.isPanelVisible=false,this.filters={showText:true,showScreenshot:true};}createPanel(){return this.panel||(this.panel=document.createElement("div"),this.panel.id="notes-panel",this.panel.className="notes-panel",document.body.appendChild(this.panel)),this.panel}showPanel(){const e=this.createPanel();this.renderPanel(),e.classList.add("show"),this.isPanelVisible=true,Ge.push(this);}hidePanel(){this.panel&&this.panel.classList.remove("show"),this.isPanelVisible=false,Ge.pop(this);}hide(){this.hidePanel();}togglePanel(){this.isPanelVisible?this.hidePanel():this.showPanel();}renderPanel(){const e=this.createPanel(),t=this.getFilteredGroupedNotes(),n=Te.getAllNotes(),o=n.filter(e=>"screenshot"!==e.type).length,i=n.filter(e=>"screenshot"===e.type).length,s=`\n      <div class="notes-panel-content">\n        <div class="notes-panel-header">\n          <h2>æˆ‘çš„ç¬”è®°</h2>\n          <button class="notes-panel-close">Ã—</button>\n        </div>\n        <div class="notes-filters">\n          <label class="filter-checkbox">\n            <input type="checkbox" id="filter-text-notes" ${this.filters.showText?"checked":""}>\n            <span>æ–‡å­—ç¬”è®° (${o})</span>\n          </label>\n          <label class="filter-checkbox">\n            <input type="checkbox" id="filter-screenshot-notes" ${this.filters.showScreenshot?"checked":""}>\n            <span>æˆªå›¾ç¬”è®° (${i})</span>\n          </label>\n        </div>\n        <div class="notes-panel-body">\n          ${0===t.length?this.renderEmptyState():t.map(e=>this.renderGroup(e)).join("")}\n        </div>\n      </div>\n    `;e.innerHTML=s,this.bindPanelEvents();}getFilteredGroupedNotes(){const e=Te.getAllNotes().filter(e=>"screenshot"===e.type?this.filters.showScreenshot:this.filters.showText),t={};return e.forEach(e=>{const n=e.createdAt||e.timestamp,o=Te.formatDate(n);t[o]||(t[o]=[]),t[o].push(e);}),Object.keys(t).sort((e,n)=>{const o=t[e][0].createdAt||t[e][0].timestamp;return (t[n][0].createdAt||t[n][0].timestamp)-o}).map(e=>({date:e,notes:t[e]}))}renderEmptyState(){return Te.getAllNotes().length>0?'\n        <div class="notes-empty-state">\n          <div class="notes-empty-icon">ğŸ”</div>\n          <div>æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„ç¬”è®°</div>\n          <div class="notes-empty-hint">è¯·è°ƒæ•´ä¸Šæ–¹çš„ç­›é€‰æ¡ä»¶</div>\n        </div>\n      ':'\n        <div class="notes-empty-state">\n          <div class="notes-empty-icon">ğŸ“</div>\n          <div>è¿˜æ²¡æœ‰ä¿å­˜ä»»ä½•ç¬”è®°</div>\n          <div class="notes-empty-hint">é€‰ä¸­æ–‡å­—åç‚¹å‡»ç²‰è‰²ç‚¹å³å¯ä¿å­˜<br>æˆ–ä½¿ç”¨ Cmd+E ä¿å­˜æˆªå›¾</div>\n        </div>\n      '}renderGroup(e){return `\n      <div class="note-group">\n        <div class="note-group-header">\n          <div class="note-group-title">\n            ${e.date} (${e.notes.length}æ¡)\n          </div>\n          <div class="note-group-actions">\n            <button class="note-group-copy-btn" data-date="${e.date}">\n              æ‰¹é‡å¤åˆ¶\n            </button>\n            <button class="note-group-delete-btn" data-date="${e.date}">\n              æ‰¹é‡åˆ é™¤\n            </button>\n          </div>\n        </div>\n        <div class="note-group-items">\n          ${e.notes.map(e=>this.renderNote(e)).join("")}\n        </div>\n      </div>\n    `}renderNote(e){const t=e.content.length>200?e.content.substring(0,200)+"...":e.content,n="screenshot"===e.type&&e.imageData?`\n        <div class="note-screenshot">\n          <img src="${e.imageData}" alt="è§†é¢‘æˆªå›¾" style="max-width: 100%; border-radius: 4px; margin-top: 8px;">\n        </div>\n        <div class="note-content">${this.escapeHtml(t)}</div>\n      `:`<div class="note-content">${this.escapeHtml(t)}</div>`;let o="",i="";return "screenshot"===e.type?(o=e.timeString||Te.formatTime(e.createdAt||e.timestamp),e.videoTitle&&"æœªçŸ¥è§†é¢‘"!==e.videoTitle?i=` Â· ${this.escapeHtml(e.videoTitle)}`:e.videoBvid&&(i=` Â· ${this.escapeHtml(e.videoBvid)}`)):(o=Te.formatTime(e.timestamp),e.videoTitle&&(i=` Â· ${this.escapeHtml(e.videoTitle)}`)),`\n      <div class="note-item ${"screenshot"===e.type?"note-item-screenshot":""}" data-note-id="${e.id}">\n        ${n}\n        <div class="note-footer">\n          <div class="note-time">\n            ${"screenshot"===e.type?"ğŸ“¸ ":""}${o}${i}\n          </div>\n          <div class="note-actions">\n            <button class="note-copy-btn" data-note-id="${e.id}">å¤åˆ¶</button>\n            <button class="note-delete-btn" data-note-id="${e.id}">åˆ é™¤</button>\n          </div>\n        </div>\n      </div>\n    `}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async copyToClipboard(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(e);else {const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t);}}catch(t){console.error("å¤åˆ¶å¤±è´¥:",t);}}bindPanelEvents(){const e=this.panel.querySelector(".notes-panel-close");e&&e.addEventListener("click",()=>this.hidePanel());const t=this.panel.querySelector("#filter-text-notes"),n=this.panel.querySelector("#filter-screenshot-notes");t&&t.addEventListener("change",e=>{this.filters.showText=e.target.checked,this.renderPanel();}),n&&n.addEventListener("change",e=>{this.filters.showScreenshot=e.target.checked,this.renderPanel();});const o=this.panel.querySelector(".notes-panel-body");o&&o.addEventListener("click",async e=>{const t=e.target.closest(".note-copy-btn");if(t){const e=t.getAttribute("data-note-id"),n=Te.getAllNotes().find(t=>t.id===e);if(n){await this.copyToClipboard(n.content);const e=t.textContent;t.textContent="âœ“",setTimeout(()=>{t.textContent=e;},1e3);}return}const n=e.target.closest(".note-delete-btn");if(n){const e=n.getAttribute("data-note-id");return Te.deleteNote(e),void this.renderPanel()}const o=e.target.closest(".note-group-copy-btn");if(o){const e=o.getAttribute("data-date"),t=Te.getGroupedNotes().find(t=>t.date===e);if(t){const e=t.notes.map(e=>e.content).join("\n\n");await this.copyToClipboard(e);const n=o.textContent;o.textContent="âœ“",setTimeout(()=>{o.textContent=n;},1e3);}return}const i=e.target.closest(".note-group-delete-btn");if(i){const e=i.getAttribute("data-date"),t=Te.getGroupedNotes().find(t=>t.date===e);if(t&&confirm(`ç¡®å®šè¦åˆ é™¤ ${e} çš„ ${t.notes.length} æ¡ç¬”è®°å—ï¼Ÿ`)){const e=t.notes.map(e=>e.id);Te.deleteNotes(e),this.renderPanel();}return}});}addSaveButton(e){if(e.querySelector(".save-subtitle-note-btn"))return;const t=e.querySelector(".subtitle-text")?.textContent;if(!t)return;const n=document.createElement("button");n.className="save-subtitle-note-btn",n.textContent="ä¿å­˜",n.title="ä¿å­˜æ­¤å­—å¹•ä¸ºç¬”è®°",n.addEventListener("click",e=>{e.stopPropagation(),Te.saveSubtitleNote(t),n.textContent="âœ“",setTimeout(()=>{n.textContent="ä¿å­˜";},1e3);});const o=e.querySelector(".subtitle-time");o&&o.appendChild(n);}addSaveButtonsToSubtitles(e){e.querySelectorAll(".subtitle-item").forEach(e=>this.addSaveButton(e));}};const Xe=new class{constructor(){this.index=new Map,this.items=[],this.minWordLength=1;}buildIndex(e){this.items=e,this.index.clear(),e.forEach((e,t)=>{this.tokenize(e.content).forEach(e=>{this.index.has(e)||this.index.set(e,[]);const n=this.index.get(e);n.includes(t)||n.push(t);});}),de.debug("SearchIndex",`ç´¢å¼•æ„å»ºå®Œæˆ: ${this.index.size} ä¸ªè¯, ${e.length} é¡¹æ•°æ®`);}tokenize(e){if(!e)return [];const t=[],n=e.toLowerCase();for(let o=0;o<n.length;o++){n[o].trim()&&t.push(n[o]);for(let e=2;e<=Math.min(4,n.length-o);e++){const i=n.substring(o,o+e);i.trim().length===e&&t.push(i);}}return t}search(e){if(!e||!e.trim())return [];const t=e.toLowerCase().trim();if(this.index.has(t))return this.index.get(t);const n=this.tokenize(t);if(0===n.length)return [];let o=this.index.get(n[0])||[];for(let i=1;i<n.length&&o.length>0;i++){const e=this.index.get(n[i])||[];o=o.filter(t=>e.includes(t));}return o}incrementalSearch(e,t,n){if(e.startsWith(t)&&n.length>0){const t=e.toLowerCase();return n.filter(e=>{const n=this.items[e];return n&&n.content.toLowerCase().includes(t)})}return this.search(e)}clear(){this.index.clear(),this.items=[];}getStats(){return {indexSize:this.index.size,itemsCount:this.items.length,avgIndicesPerWord:this.index.size>0?(Array.from(this.index.values()).reduce((e,t)=>e+t.length,0)/this.index.size).toFixed(2):0}}};const Ye=new class{constructor(){this.container=null,this.video=null,this.isFollowing=true,this.scrollTimer=null,this.followInterval=null,this.userScrollTimeout=null,this.lastScrollTime=0,this.lastHighlightedItem=null,this.config={followIntervalMs:200,userScrollDetectMs:300,scrollBehavior:"smooth",scrollPosition:"start",highlightClass:"current"},this.callbacks={onFollowStatusChange:null,onSubtitleHighlight:null};}init(e,t={}){e?(this.container=e,this.video=document.querySelector("video"),this.video?(this.config={...this.config,...t},this.setupScrollListener(),this.startAutoFollow()):console.warn("SubtitleScrollManager: æœªæ‰¾åˆ°è§†é¢‘å…ƒç´ ")):console.warn("SubtitleScrollManager: å®¹å™¨ä¸å­˜åœ¨");}setupScrollListener(){this.container&&this.container.addEventListener("scroll",()=>{this.handleUserScroll();},{passive:true});}handleUserScroll(){Date.now()-this.lastScrollTime<50||(this.userScrollTimeout&&clearTimeout(this.userScrollTimeout),this.isFollowing,this.userScrollTimeout=setTimeout(()=>{this.isFollowing&&(this.isFollowing=false,this.triggerFollowStatusChange(false));},this.config.userScrollDetectMs));}startAutoFollow(){this.stopAutoFollow(),this.isFollowing=true,this.triggerFollowStatusChange(true),this.updateScroll(),this.followInterval=setInterval(()=>{this.isFollowing&&this.updateScroll();},this.config.followIntervalMs);}stopAutoFollow(){this.followInterval&&(clearInterval(this.followInterval),this.followInterval=null),this.isFollowing=false,this.triggerFollowStatusChange(false);}resumeAutoFollow(){this.startAutoFollow(),this.scrollToCurrentSubtitle(true);}updateScroll(){if(!this.video||!this.container)return;const e=this.video.currentTime,t=this.container.querySelectorAll(".subtitle-item");if(0===t.length)return;let n=null;for(let o=0;o<t.length;o++){const i=t[o],s=parseFloat(i.dataset.startTime||0),r=parseFloat(i.dataset.endTime||0);if(e>=s&&e<=r){n=i;break}if(o<t.length-1){const r=parseFloat(t[o+1].dataset.startTime||0);if(e>=s&&e<r){n=i;break}}}if(!n){let o=1/0;for(const i of t){const t=parseFloat(i.dataset.startTime||0),s=Math.abs(e-t);s<o&&(o=s,n=i);}}n&&n!==this.lastHighlightedItem&&(this.updateHighlight(n),this.isFollowing&&this.scrollToElement(n));}updateHighlight(e){this.lastHighlightedItem&&this.lastHighlightedItem.classList.remove(this.config.highlightClass),e&&(e.classList.add(this.config.highlightClass),this.lastHighlightedItem=e,this.callbacks.onSubtitleHighlight&&this.callbacks.onSubtitleHighlight(e));}scrollToElement(e,t=false){if(!e||!this.container)return;const n=this.container.getBoundingClientRect(),o=e.getBoundingClientRect();let i;if(t||"center"===this.config.scrollPosition){const e=n.height/2,t=o.height/2;i=o.top-n.top+this.container.scrollTop-e+t;}else "start"===this.config.scrollPosition?(i=e.offsetTop-20,i=Math.max(0,i)):i=e.offsetTop-n.height+o.height;this.lastScrollTime=Date.now(),this.container.scrollTo({top:i,behavior:this.isFollowing?this.config.scrollBehavior:"auto"});}scrollToCurrentSubtitle(e=false){if(!this.video||!this.container)return;const t=this.video.currentTime,n=this.container.querySelectorAll(".subtitle-item");for(const o of n){const n=parseFloat(o.dataset.startTime||0),i=parseFloat(o.dataset.endTime||0);if(t>=n&&t<=i){this.updateHighlight(o),this.scrollToElement(o,e);break}}}triggerFollowStatusChange(e){this.callbacks.onFollowStatusChange&&this.callbacks.onFollowStatusChange(e);}on(e,t){this.callbacks.hasOwnProperty(e)&&(this.callbacks[e]=t);}updateConfig(e){this.config={...this.config,...e};}isAutoFollowing(){return this.isFollowing}destroy(){this.stopAutoFollow(),this.userScrollTimeout&&(clearTimeout(this.userScrollTimeout),this.userScrollTimeout=null),this.lastHighlightedItem&&(this.lastHighlightedItem.classList.remove(this.config.highlightClass),this.lastHighlightedItem=null),this.container=null,this.video=null,this.callbacks={onFollowStatusChange:null,onSubtitleHighlight:null};}};const We=new class{constructor(){this.isDragging=false,this.dragStartX=0,this.dragStartY=0,this.translateX=0,this.translateY=0,this.isResizing=false,this.resizeStartX=0,this.resizeStartY=0,this.resizeStartWidth=0,this.resizeStartHeight=0,this.searchMatches=[],this.currentMatchIndex=-1,this.searchTerm="",this.lastSearchTerm="",this.searchIndexBuilt=false,this.subtitleDataCache=null,this.currentHighlightedIndex=-1,this.debouncedSearch=null,this.throttledHighlight=null,this.aiConfigModalProxy={hide:()=>this.hideAIConfigModal()},this.notionConfigModalProxy={hide:()=>this.hideNotionConfigModal()},this.shortcutConfigModalProxy={hide:()=>this.hideShortcutConfigModal()};}initializeSearchIndex(e){e&&e.length>0&&(Xe.buildIndex(e),this.searchIndexBuilt=true);}bindSubtitlePanelEvents(e){this.restoreContainerState(e),this.bindDragEvents(e),this.bindResizeEvents(e),this.observeContainerResize(e);const t=e.querySelector(".subtitle-close");t&&t.addEventListener("click",()=>{ce.setPanelVisible(false),e.classList.remove("show"),Ye.destroy();});const n=e.querySelectorAll(".subtitle-tab"),o=e.querySelectorAll(".subtitle-panel");n.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");n.forEach(e=>e.classList.remove("active")),e.classList.add("active"),o.forEach(e=>{if(e.id===`${t}-panel`){if(e.style.display="block","subtitles"===t){const t=e.querySelector("#subtitle-list-container");t&&!Ye.container&&this.initSubtitleScroll(t);}}else e.style.display="none";});});});const i=e.querySelector(".ai-icon");i&&i.addEventListener("click",async t=>{t.stopPropagation();const n=ce.getSubtitleData();if(!n||0===n.length)return void He.error("æ²¡æœ‰å¯ç”¨çš„å­—å¹•æ•°æ®");if(pe.getSelectedAIConfig())try{await ke.summarize(n,!1);const t=e?.querySelector('.subtitle-tab[data-tab="summary"]');t&&t.click();}catch(o){He.handleError(o,"AIæ€»ç»“");}else He.warning("è¯·å…ˆåœ¨æ²¹çŒ´èœå•ä¸­AIé…ç½®ä¸­é€‰æ‹©æˆ–é…ç½®ä¸€ä¸ªAIæœåŠ¡");});const s=e.querySelector("#progress-switch");s&&s.addEventListener("click",()=>{s.classList.toggle("on");s.classList.contains("on")?this.addProgressBarMarkers(e):this.removeProgressBarMarkers();});const r=e.querySelector(".download-icon");r&&r.addEventListener("click",e=>{e.stopPropagation();try{we.downloadSubtitleFile(),He.success("å­—å¹•æ–‡ä»¶å·²ä¸‹è½½");}catch(t){He.handleError(t,"ä¸‹è½½å­—å¹•");}});const a=e.querySelector(".notion-icon");a&&a.addEventListener("click",async e=>{e.stopPropagation();const t=ce.getSubtitleData();if(t)try{await Se.sendSubtitle(t,!1);}catch(n){He.handleError(n,"Notionå‘é€");}});const l=e.querySelector("#subtitle-list-container");l&&this.initSubtitleScroll(l);const c=e.querySelector("#subtitle-search-input");c&&(this.debouncedSearch||(this.debouncedSearch=ve((e,t)=>{this.handleSearch(e,t);},300)),c.addEventListener("input",t=>{this.debouncedSearch(e,t.target.value);}),c.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),this.navigateSearch(e,1));}));const d=e.querySelector("#search-prev"),p=e.querySelector("#search-next");d&&d.addEventListener("click",()=>{this.navigateSearch(e,-1);}),p&&p.addEventListener("click",()=>{this.navigateSearch(e,1);}),e.addEventListener("click",t=>{const n=t.target.closest(".section-item");if(n){t.stopPropagation();const e=window.getSelection();e&&e.removeAllRanges(),de.info("EventHandlers","æ®µè½å…ƒç´ è¢«ç‚¹å‡»");const o=n.getAttribute("data-time");if(de.info("EventHandlers","æ—¶é—´æˆ³å­—ç¬¦ä¸²:",o),o){let e=0;const t=o.match(/\[?(\d{1,2}):(\d{2})(?::(\d{2}))?\]?/);if(t){const[i,s,r,a]=t;e=a?3600*parseInt(s)+60*parseInt(r)+parseInt(a):60*parseInt(s)+parseInt(r),de.info("EventHandlers","è§£æåçš„ç§’æ•°:",e);const l=document.querySelector(J);if(l){l.currentTime=e;const t=o.replace(/[\[\]]/g,"");He.show(`è·³è½¬åˆ° ${t}`,"info"),n.classList.add("clicked"),setTimeout(()=>{n.classList.remove("clicked");},300);}}}return}const o=t.target.closest(".save-subtitle-note-btn");if(o){t.stopPropagation();const e=o.getAttribute("data-content");return void(e&&(Te.saveSubtitleNote(e),o.textContent="âœ“",setTimeout(()=>{o.textContent="ä¿å­˜";},1e3)))}const i=t.target.closest(".subtitle-item");if(i){const t=document.querySelector(J);if(t){const n=parseFloat(i.dataset.from);e.querySelectorAll(".subtitle-item").forEach(e=>{e.classList.remove("current");}),i.classList.add("current"),t.currentTime=n;}}}),this.syncSubtitleHighlight(e);}setupDragging(e){const t=e.querySelector(".subtitle-header");t&&(t.addEventListener("mousedown",t=>{t.target.closest(".subtitle-close")||t.target.closest(".ai-icon")||t.target.closest(".download-icon")||t.target.closest(".notion-icon")||t.target.closest(".subtitle-search-container")||(this.isDragging=true,this.dragStartX=t.clientX,this.dragStartY=t.clientY,e.style.willChange="transform",t.preventDefault());}),document.addEventListener("mousemove",t=>{this.isDragging&&requestAnimationFrame(()=>{const n=t.clientX-this.dragStartX,o=t.clientY-this.dragStartY;this.translateX+=n,this.translateY+=o,this.dragStartX=t.clientX,this.dragStartY=t.clientY,e.style.transform=`translate(${this.translateX}px, ${this.translateY}px)`;});}),document.addEventListener("mouseup",()=>{this.isDragging&&(this.isDragging=false,e.style.willChange="auto",this.savePanelPosition(e));}));}setupResize(e){const t=e.querySelector(".subtitle-resize-handle");t&&(t.addEventListener("mousedown",t=>{this.isResizing=true,this.resizeStartX=t.clientX,this.resizeStartY=t.clientY,this.resizeStartWidth=e.offsetWidth,this.resizeStartHeight=e.offsetHeight,t.preventDefault(),t.stopPropagation();}),document.addEventListener("mousemove",t=>{this.isResizing&&requestAnimationFrame(()=>{const n=t.clientX-this.resizeStartX,o=t.clientY-this.resizeStartY,i=this.resizeStartWidth+n,s=this.resizeStartHeight+o,r=Math.max(300,Math.min(800,i)),a=.9*window.innerHeight,l=Math.max(400,Math.min(a,s));e.style.width=`${r}px`,e.style.maxHeight=`${l}px`;});}),document.addEventListener("mouseup",()=>{this.isResizing&&(this.isResizing=false,this.savePanelDimensions(e));}));}savePanelPosition(e){try{localStorage.setItem("subtitle_panel_position",JSON.stringify({translateX:this.translateX,translateY:this.translateY}));}catch(t){console.error("ä¿å­˜é¢æ¿ä½ç½®å¤±è´¥:",t);}}savePanelDimensions(e){try{localStorage.setItem("subtitle_panel_dimensions",JSON.stringify({width:e.offsetWidth,height:e.offsetHeight}));}catch(t){console.error("ä¿å­˜é¢æ¿å°ºå¯¸å¤±è´¥:",t);}}loadPanelDimensions(e){try{const t=localStorage.getItem("subtitle_panel_dimensions");if(t){const{width:n,height:o}=JSON.parse(t);e.style.width=`${n}px`,e.style.maxHeight=`${o}px`;}const n=localStorage.getItem("subtitle_panel_position");if(n){const{translateX:t,translateY:o}=JSON.parse(n);this.translateX=t,this.translateY=o,e.style.transform=`translate(${t}px, ${o}px)`;}}catch(t){console.error("åŠ è½½é¢æ¿è®¾ç½®å¤±è´¥:",t);}}syncSubtitleHighlight(e){const t=Le.get(J);if(!t)return;const n=Array.from(e.querySelectorAll(".subtitle-item"));this.subtitleDataCache=n.map(e=>({element:e,from:parseFloat(e.dataset.from),to:parseFloat(e.dataset.to)})),this.throttledHighlight||(this.throttledHighlight=function(e){let t=null;return function(...n){null===t&&(t=requestAnimationFrame(()=>{e.apply(this,n),t=null;}));}}(e=>{this.updateSubtitleHighlight(e);})),t.addEventListener("timeupdate",()=>{this.throttledHighlight(t.currentTime);});}updateSubtitleHighlight(e){if(!this.subtitleDataCache||0===this.subtitleDataCache.length)return;const t=function(e,t){if(!e||0===e.length)return  -1;if(e.length<50){for(let n=0;n<e.length;n++)if(t>=e[n].from&&t<=e[n].to)return n;return  -1}let n=0,o=e.length-1;for(;n<=o;){const i=Math.floor((n+o)/2),s=e[i];if(t>=s.from&&t<=s.to)return i;t<s.from?o=i-1:n=i+1;}return  -1}(this.subtitleDataCache,e);t!==this.currentHighlightedIndex&&(this.currentHighlightedIndex>=0&&this.currentHighlightedIndex<this.subtitleDataCache.length&&this.subtitleDataCache[this.currentHighlightedIndex].element.classList.remove("current"),t>=0&&this.subtitleDataCache[t].element.classList.add("current"),this.currentHighlightedIndex=t);}handleSearch(e,t){if(this.searchTerm=t.trim(),this.clearSearchHighlights(e),!this.searchTerm)return this.updateSearchCounter(0,0),void(this.lastSearchTerm="");if(!this.searchIndexBuilt){const e=ce.getSubtitleData();e&&(Xe.buildIndex(e),this.searchIndexBuilt=true);}this.searchMatches=[],this.highlightSearchInContainer(e),this.updateSearchCounter(this.searchMatches.length>0?1:0,this.searchMatches.length),this.searchMatches.length>0&&(this.currentMatchIndex=0,this.scrollToMatch(this.searchMatches[0])),this.lastSearchTerm=this.searchTerm;}highlightSearchInContainer(e){const t=e.querySelector(".subtitle-content");if(!t)return;const n=t.querySelector(".ai-summary-section");if(n){const e=n.querySelector(".ai-summary-content");e&&this.highlightInElement(e,this.searchTerm);}t.querySelectorAll(".subtitle-item").forEach(e=>{const t=e.querySelector(".subtitle-text");t&&this.highlightInElement(t,this.searchTerm);});}highlightInElement(e,t){const n=e.textContent,o=new RegExp(`(${this.escapeRegex(t)})`,"gi");if(n.match(o)){let t=n.replace(o,e=>`<mark class="search-highlight" data-search-match>${e}</mark>`);e.innerHTML=t;e.querySelectorAll("mark[data-search-match]").forEach(e=>{this.searchMatches.push(e);});}}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}clearSearchHighlights(e){e.querySelectorAll("mark[data-search-match]").forEach(e=>{const t=e.textContent,n=document.createTextNode(t);e.parentNode.replaceChild(n,e);}),this.searchMatches=[],this.currentMatchIndex=-1;}navigateSearch(e,t){if(0===this.searchMatches.length)return;this.currentMatchIndex>=0&&this.currentMatchIndex<this.searchMatches.length&&(this.searchMatches[this.currentMatchIndex].classList.remove("search-highlight-current"),this.searchMatches[this.currentMatchIndex].classList.add("search-highlight")),this.currentMatchIndex+=t,this.currentMatchIndex>=this.searchMatches.length?this.currentMatchIndex=0:this.currentMatchIndex<0&&(this.currentMatchIndex=this.searchMatches.length-1);const n=this.searchMatches[this.currentMatchIndex];n.classList.remove("search-highlight"),n.classList.add("search-highlight-current"),this.scrollToMatch(n),this.updateSearchCounter(this.currentMatchIndex+1,this.searchMatches.length);}scrollToMatch(e){e.classList.add("search-highlight-current"),e.scrollIntoView({behavior:"smooth",block:"center"});}updateSearchCounter(e,t){const n=document.getElementById("search-counter");n&&(n.textContent=`${e}/${t}`);const o=document.getElementById("search-controls");o&&(o.style.display=t>0?"flex":"none");const i=document.getElementById("search-prev"),s=document.getElementById("search-next");i&&(i.disabled=0===t),s&&(s.disabled=0===t);}showAIConfigModal(){const e=document.getElementById("ai-config-modal");if(!e)return;const t=document.getElementById("ai-config-list");t&&Ue.renderAIConfigList(t),this.clearAIConfigForm();const n=e.querySelector(".ai-config-form");n&&n.classList.add("hidden"),document.getElementById("ai-auto-summary-enabled").checked=pe.getAIAutoSummaryEnabled(),e.classList.add("show"),Ge.push(this.aiConfigModalProxy);}hideAIConfigModal(){const e=document.getElementById("ai-config-modal");if(!e)return;const t=document.getElementById("ai-auto-summary-enabled").checked;pe.setAIAutoSummaryEnabled(t),e.classList.remove("show"),this.clearAIConfigForm(),Ge.pop(this.aiConfigModalProxy);}clearAIConfigForm(){const e=document.getElementById("ai-config-name"),t=document.getElementById("ai-config-url"),n=document.getElementById("ai-config-apikey"),o=document.getElementById("ai-config-model"),i=document.getElementById("ai-config-prompt1"),s=document.getElementById("ai-config-prompt2"),r=document.getElementById("ai-config-is-openrouter"),a=document.getElementById("ai-save-new-btn"),l=document.getElementById("ai-update-btn"),c=document.getElementById("model-select-wrapper"),d=document.getElementById("api-key-help-link");e&&(e.value=""),t&&(t.value="https://openrouter.ai/api/v1/chat/completions"),n&&(n.value=""),o&&(o.value="alibaba/tongyi-deepresearch-30b-a3b:free"),i&&(i.value=""),s&&(s.value=""),r&&(r.checked=true),a&&(a.style.display=""),l&&(l.style.display="none"),c&&(c.style.display="none"),d&&(d.innerHTML="");}showNotionConfigModal(){const e=document.getElementById("notion-config-modal");if(!e)return;const t=pe.getNotionConfig();document.getElementById("notion-api-key").value=t.apiKey,document.getElementById("notion-parent-page-id").value=t.parentPageId,document.getElementById("notion-auto-send-enabled").checked=pe.getNotionAutoSendEnabled();const n=document.getElementById("notion-status-message");n&&(n.innerHTML=""),e.classList.add("show"),Ge.push(this.notionConfigModalProxy);}hideNotionConfigModal(){const e=document.getElementById("notion-config-modal");e&&e.classList.remove("show"),Ge.pop(this.notionConfigModalProxy);}showShortcutConfigModal(){try{de.debug("EventHandlers","æ˜¾ç¤ºå¿«æ·é”®é…ç½®æ¨¡æ€æ¡†");const e=document.getElementById("shortcut-config-modal");if(e)return e.classList.add("show"),void Ge.push(this.shortcutConfigModalProxy);const t=Ue.renderShortcutConfigModal();if(!t)return console.error("[EventHandlers] æ— æ³•ç”Ÿæˆå¿«æ·é”®é…ç½®æ¨¡æ€æ¡†HTML"),void He.error("æ— æ³•æ‰“å¼€å¿«æ·é”®è®¾ç½®");const n=document.createElement("div");n.innerHTML=t;const o=n.firstElementChild;if(!o)return console.error("[EventHandlers] æ— æ³•åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ "),void He.error("æ— æ³•åˆ›å»ºå¿«æ·é”®è®¾ç½®ç•Œé¢");document.body.appendChild(o),requestAnimationFrame(()=>{o.classList.add("show"),Ge.push(this.shortcutConfigModalProxy);}),this.bindShortcutConfigModalEvents(o),de.debug("EventHandlers","å¿«æ·é”®é…ç½®æ¨¡æ€æ¡†å·²æ˜¾ç¤º");}catch(e){console.error("[EventHandlers] æ˜¾ç¤ºå¿«æ·é”®é…ç½®æ¨¡æ€æ¡†å¤±è´¥:",e),He.error("æ‰“å¼€å¿«æ·é”®è®¾ç½®å¤±è´¥: "+e.message);}}hideShortcutConfigModal(){const e=document.getElementById("shortcut-config-modal");e&&(e.classList.remove("show"),Ge.pop(this.shortcutConfigModalProxy),setTimeout(()=>{e&&e.parentNode&&e.parentNode.removeChild(e);},300));}bindShortcutConfigModalEvents(e){const t=e.querySelector(".config-modal-close");t&&t.addEventListener("click",()=>{this.hideShortcutConfigModal();}),e.addEventListener("click",t=>{t.target===e&&this.hideShortcutConfigModal();});e.querySelectorAll(".shortcut-input").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),this.startShortcutCapture(e);});});e.querySelectorAll(".shortcut-reset-btn").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.key,o=ge.constructor.DEFAULT_SHORTCUTS||{};if(o[n]){ge.updateShortcut(n,o[n]);const t=e.querySelector(`.shortcut-input[data-key="${n}"]`);t&&(t.value=ge.formatShortcut(o[n])),He.success("å·²é‡ç½®åˆ°é»˜è®¤å€¼");}});});const n=e.querySelector("#reset-all-shortcuts");n&&n.addEventListener("click",()=>{confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰å¿«æ·é”®åˆ°é»˜è®¤å€¼å—ï¼Ÿ")&&(ge.resetToDefaults(),He.success("å¿«æ·é”®å·²é‡ç½®åˆ°é»˜è®¤å€¼"),this.hideShortcutConfigModal(),this.showShortcutConfigModal());});}startShortcutCapture(e){const t=e.dataset.key;e.classList.add("recording"),e.value="æŒ‰ä¸‹å¿«æ·é”®...";let n=null,o="";const i=s=>{if(s.preventDefault(),s.stopPropagation(),"Escape"===s.key)return e.classList.remove("recording"),e.value=ge.formatShortcut(ge.getAllShortcuts()[t]),void document.removeEventListener("keydown",i);if("takeScreenshot"===t&&"Slash"===s.code){if("Slash"===o&&n){clearTimeout(n);const o={key:"Slash",ctrl:false,alt:false,shift:false,doubleClick:true};ge.updateShortcut(t,o).success&&(e.value=ge.formatShortcut(o),He.success("å¿«æ·é”®å·²æ›´æ–°")),e.classList.remove("recording"),document.removeEventListener("keydown",i);}else o="Slash",n=setTimeout(()=>{n=null,o="";},300);return}const r={key:s.code||s.key,ctrl:s.ctrlKey||s.metaKey,alt:s.altKey,shift:s.shiftKey,doubleClick:false},a=ge.checkConflict(t,r);if(a)He.warning(`ä¸"${a}"å†²çªï¼Œè¯·é‡æ–°è®¾ç½®`),e.value=ge.formatShortcut(ge.getAllShortcuts()[t]);else {const n=ge.updateShortcut(t,r);n.success?(e.value=ge.formatShortcut(r),He.success("å¿«æ·é”®å·²æ›´æ–°")):(He.error(n.error),e.value=ge.formatShortcut(ge.getAllShortcuts()[t]));}e.classList.remove("recording"),document.removeEventListener("keydown",i);};document.addEventListener("keydown",i);}bindAIConfigModalEvents(e){e.addEventListener("click",t=>{t.target===e&&this.hideAIConfigModal();});const t=document.getElementById("ai-config-list");t&&t.addEventListener("click",n=>{const o=n.target.closest(".ai-config-item"),i=n.target.closest(".ai-edit-btn");if(i){const t=i.dataset.id,n=e.querySelector(".ai-config-form");n&&n.classList.remove("hidden"),this.loadConfigToForm(t);}else if(o&&!i){const n=o.dataset.id;pe.setSelectedAIConfigId(n),Ue.renderAIConfigList(t);const i=pe.getAIConfigs().find(e=>e.id===n);He.success(`å·²é€‰æ‹©é…ç½®: ${i.name}`);const s=e.querySelector(".ai-config-form");s&&s.classList.remove("hidden"),this.loadConfigToForm(n);}});const n=document.getElementById("ai-start-summary-btn");n&&n.addEventListener("click",async()=>{const e=ce.getSubtitleData();if(!e||0===e.length)return void He.error("æ²¡æœ‰å¯ç”¨çš„å­—å¹•æ•°æ®");if(pe.getSelectedAIConfig()){this.hideAIConfigModal();try{await ke.summarize(e,!1);const t=document.getElementById("subtitle-container"),n=t?.querySelector('.subtitle-tab[data-tab="summary"]');n&&n.click();}catch(t){He.handleError(t,"AIæ€»ç»“");}}else He.warning("è¯·å…ˆé€‰æ‹©æˆ–é…ç½®ä¸€ä¸ªAIæœåŠ¡");}),document.getElementById("ai-new-config-btn").addEventListener("click",()=>{this.clearAIConfigForm();const t=e.querySelector(".ai-config-form");t&&(t.classList.remove("hidden"),setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"nearest"});},100)),He.info("è¯·å¡«å†™æ–°é…ç½®ä¿¡æ¯");}),document.getElementById("ai-save-new-btn").addEventListener("click",()=>{this.saveNewAIConfig();}),document.getElementById("ai-update-btn").addEventListener("click",()=>{this.updateAIConfig();}),document.getElementById("ai-cancel-btn").addEventListener("click",()=>{this.hideAIConfigModal();}),document.getElementById("ai-delete-current-btn").addEventListener("click",()=>{const e=document.getElementById("ai-delete-current-btn"),t=e?.dataset.deleteId;if(t&&He.confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ")){const n=pe.deleteAIConfig(t);if(n.success){He.success("é…ç½®å·²åˆ é™¤");const t=document.getElementById("ai-config-list");t&&Ue.renderAIConfigList(t);const n=document.querySelector(".ai-config-form");n&&n.classList.add("hidden"),e.style.display="none";}else He.error(n.error);}}),document.getElementById("fetch-models-btn").addEventListener("click",async()=>{await this.fetchModels();});}loadConfigToForm(e){const t=pe.getAIConfigs().find(t=>t.id===e);if(!t)return;const n=document.getElementById("ai-config-name"),o=document.getElementById("ai-config-url"),i=document.getElementById("ai-config-apikey"),s=document.getElementById("ai-config-model"),r=document.getElementById("ai-config-prompt1"),a=document.getElementById("ai-config-prompt2"),l=document.getElementById("ai-config-is-openrouter"),c=document.getElementById("ai-save-new-btn"),d=document.getElementById("ai-update-btn"),p=document.getElementById("model-select-wrapper");n&&(n.value=t.name),o&&(o.value=t.url),i&&(i.value=t.apiKey),s&&(s.value=t.model),r&&(r.value=t.prompt1||""),a&&(a.value=t.prompt2||""),l&&(l.checked=t.isOpenRouter||false);const u=document.getElementById("api-key-help-link");u&&N[t.id]?u.innerHTML=`<a href="${N[t.id]}" target="_blank" style="color: #60a5fa; text-decoration: none;">ğŸ“– å¦‚ä½•è·å–API Key?</a>`:u&&(u.innerHTML=""),c&&(c.style.display="none"),d&&(d.style.display="",d.dataset.editId=e),p&&(p.style.display="none");const h=document.getElementById("ai-delete-current-btn");h&&("openrouter"===e||"openai"===e||"siliconflow"===e||"deepseek"===e||"moonshot"===e||"zhipu"===e||"yi"===e||"dashscope"===e||"gemini"===e?h.style.display="none":(h.style.display="",h.dataset.deleteId=e)),setTimeout(()=>{const e=document.querySelector(".ai-config-form");e&&e.scrollIntoView({behavior:"smooth",block:"nearest"});},100);}editAIConfig(e){this.loadConfigToForm(e);}saveNewAIConfig(){const e={name:document.getElementById("ai-config-name").value.trim(),url:document.getElementById("ai-config-url").value.trim(),apiKey:document.getElementById("ai-config-apikey").value.trim(),model:document.getElementById("ai-config-model").value.trim(),prompt1:document.getElementById("ai-config-prompt1").value,prompt2:document.getElementById("ai-config-prompt2").value,isOpenRouter:document.getElementById("ai-config-is-openrouter").checked},t=pe.addAIConfig(e);if(t.success){He.success(`é…ç½®"${e.name}"å·²æ·»åŠ `);const t=document.getElementById("ai-config-list");t&&Ue.renderAIConfigList(t),this.clearAIConfigForm();}else He.error(t.error);}updateAIConfig(){const e=document.getElementById("ai-update-btn").dataset.editId;if(!e)return;const t={name:document.getElementById("ai-config-name").value.trim(),url:document.getElementById("ai-config-url").value.trim(),apiKey:document.getElementById("ai-config-apikey").value.trim(),model:document.getElementById("ai-config-model").value.trim(),prompt1:document.getElementById("ai-config-prompt1").value,prompt2:document.getElementById("ai-config-prompt2").value,isOpenRouter:document.getElementById("ai-config-is-openrouter").checked},n=pe.updateAIConfig(e,t);if(n.success){He.success(`é…ç½®"${t.name}"å·²æ›´æ–°`);const e=document.getElementById("ai-config-list");e&&Ue.renderAIConfigList(e),this.clearAIConfigForm();}else He.error(n.error);}async fetchModels(){const e=document.getElementById("ai-config-apikey").value.trim(),t=document.getElementById("ai-config-url").value.trim(),n=document.getElementById("ai-config-is-openrouter").checked;if(!e)return void He.error("è¯·å…ˆå¡«å†™ API Key");if(!n)return void He.error("ä»…OpenRouteræ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");const o=document.getElementById("fetch-models-btn");o.disabled=true,o.textContent="è·å–ä¸­...";try{const n=await ke.fetchOpenRouterModels(e,t),o=document.getElementById("model-select-wrapper"),i=document.getElementById("model-select"),s=document.getElementById("model-search-input");if(!i)return void He.error("æ¨¡å‹é€‰æ‹©å™¨æœªæ‰¾åˆ°");this.allModels=n,i.innerHTML="",n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.name||e.id} (${e.context_length||"N/A"} tokens)`,t.title=e.id,i.appendChild(t);}),o&&(o.style.display="block"),i.onchange=()=>{document.getElementById("ai-config-model").value=i.value;},i.ondblclick=()=>{document.getElementById("ai-config-model").value=i.value,He.success("å·²é€‰æ‹©æ¨¡å‹");},s&&(s.value="",s.oninput=e=>{this.filterModels(e.target.value);},s.onkeydown=e=>{"Enter"===e.key&&i.options.length>0&&(i.selectedIndex=0,document.getElementById("ai-config-model").value=i.options[0].value,He.success("å·²é€‰æ‹©: "+i.options[0].text));}),He.success(`å·²è·å– ${n.length} ä¸ªæ¨¡å‹`);}catch(i){He.error(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${i.message}`);}finally{o.disabled=false,o.textContent="è·å–æ¨¡å‹";}}filterModels(e){if(!this.allModels)return;const t=document.getElementById("model-select");if(!t)return;const n=e.toLowerCase().trim();if(!n)return t.innerHTML="",void this.allModels.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=`${e.name||e.id} (${e.context_length||"N/A"} tokens)`,n.title=e.id,t.appendChild(n);});const o=this.allModels.filter(e=>{const t=(e.id||"").toLowerCase(),o=(e.name||"").toLowerCase();return t.includes(n)||o.includes(n)});t.innerHTML="",o.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=`${e.name||e.id} (${e.context_length||"N/A"} tokens)`,n.title=e.id,t.appendChild(n);});const i=document.getElementById("model-search-input");i&&(i.placeholder=o.length>0?`æ‰¾åˆ° ${o.length} ä¸ªæ¨¡å‹`:"æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹");}addProgressBarMarkers(e){const t=e.querySelectorAll(".section-item[data-time]"),n=document.querySelector("video"),o=document.querySelector(".bpx-player-progress-wrap");if(!n||!o)return;const i=n.duration;if(!i)return;let s=o.querySelector(".ai-points-container");s||(s=document.createElement("div"),s.className="ai-points-container",o.appendChild(s)),s.innerHTML="",t.forEach(e=>{const t=e.getAttribute("data-time");if(!t)return;const o=t.match(/\[(\d{1,2}):(\d{2})\]/);if(!o)return;const r=60*parseInt(o[1])+parseInt(o[2]),a=r/i*100,l=document.createElement("span");l.className="bpx-player-progress-point bpx-player-progress-point-aipoint",l.style.cssText=`left: ${a}%;`,l.setAttribute("data-time",r),l.addEventListener("click",()=>{n.currentTime=r;}),s.appendChild(l);}),this._addProgressBarStyles();}removeProgressBarMarkers(){const e=document.querySelector(".ai-points-container");e&&e.remove();}_addProgressBarStyles(){if(document.querySelector("#ai-progress-styles"))return;const e=document.createElement("style");e.id="ai-progress-styles",e.textContent="\n      .ai-points-container {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        pointer-events: none;\n        z-index: 5;\n      }\n      \n      .bpx-player-progress-point-aipoint {\n        position: absolute;\n        top: 50%;\n        transform: translate(-50%, -50%);\n        width: 8px;\n        height: 8px;\n        background: #ff69b4;\n        border: 2px solid rgba(255, 255, 255, 0.9);\n        border-radius: 50%;\n        opacity: 0.9;\n        pointer-events: auto;\n        cursor: pointer;\n        transition: all 0.2s;\n        box-shadow: 0 0 4px rgba(255, 105, 180, 0.6);\n      }\n      \n      .bpx-player-progress-point-aipoint:hover {\n        opacity: 1;\n        transform: translate(-50%, -50%) scale(1.5);\n        box-shadow: 0 0 8px rgba(255, 105, 180, 0.9);\n      }\n    ",document.head.appendChild(e);}initSubtitleScroll(e){if(!e)return void de.warn("EventHandlers","å­—å¹•å®¹å™¨ä¸å­˜åœ¨ï¼Œæ— æ³•åˆå§‹åŒ–æ»šåŠ¨");const t=document.querySelector("#subtitle-follow-btn");Ye.init(e,{followIntervalMs:200,userScrollDetectMs:300,scrollBehavior:"smooth",scrollPosition:"center",highlightClass:"current"}),Ye.on("onFollowStatusChange",e=>{t&&(t.style.display=e?"none":"block"),de.debug("å­—å¹•æ»šåŠ¨",`è·ŸéšçŠ¶æ€æ”¹å˜: ${e}`);}),t&&t.addEventListener("click",()=>{de.debug("å­—å¹•æ»šåŠ¨","ç‚¹å‡»æ¢å¤æ»šåŠ¨"),Ye.resumeAutoFollow();}),de.info("EventHandlers","å­—å¹•æ»šåŠ¨ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ");}bindNotionConfigModalEvents(e){e.addEventListener("click",t=>{t.target===e&&this.hideNotionConfigModal();}),document.getElementById("notion-save-btn").addEventListener("click",()=>{const e=document.getElementById("notion-api-key").value.trim(),t=document.getElementById("notion-parent-page-id").value.trim(),n=document.getElementById("notion-auto-send-enabled").checked;if(!e)return void Ue.showNotionStatus("è¯·è¾“å…¥ API Key",true);if(!t)return void Ue.showNotionStatus("è¯·è¾“å…¥ç›®æ ‡ä½ç½®ï¼ˆPage ID æˆ– Database IDï¼‰",true);const o=pe.saveNotionConfig({apiKey:e,parentPageId:t});o.success?(pe.setNotionAutoSendEnabled(n),Ue.showNotionStatus("é…ç½®å·²ä¿å­˜"),setTimeout(()=>{this.hideNotionConfigModal();},1500)):Ue.showNotionStatus(o.error,true);}),document.getElementById("notion-cancel-btn").addEventListener("click",()=>{this.hideNotionConfigModal();});}restoreContainerState(e){const t=localStorage.getItem("subtitle-container-state");if(t)try{const n=JSON.parse(t);n.width&&(e.style.width=n.width),n.height&&(e.style.height=n.height),n.top&&(e.style.top=n.top),n.left&&(e.style.left=n.left);}catch(n){de.warn("EventHandlers","æ¢å¤å®¹å™¨çŠ¶æ€å¤±è´¥:",n);}}parsePositionValue(e,t){return e?e.endsWith("px")?parseInt(e):e.endsWith("%")?parseInt(e)/100*t:parseInt(e)||0:0}resetContainerPosition(e){localStorage.removeItem("subtitle-container-state"),e.style.width="500px",e.style.height="600px",e.style.top="10%",e.style.left="100%",e.style.marginLeft="10px",He.success("å­—å¹•é¢æ¿ä½ç½®å·²é‡ç½®");}saveContainerState(e){const t={width:e.style.width||e.offsetWidth+"px",height:e.style.height||e.offsetHeight+"px",top:e.style.top||"10%",left:e.style.left||"100%"};localStorage.setItem("subtitle-container-state",JSON.stringify(t));}bindDragEvents(e){const t=e.querySelector(".subtitle-header");if(!t)return;let n=false,o=0,i=0,s=0,r=0;const a=a=>{if(a.target.closest("button")||a.target.closest("input")||a.target.closest(".subtitle-search-container")||a.target.closest(".ai-icon")||a.target.closest(".notion-icon")||a.target.closest(".subtitle-close"))return;n=true,o=a.clientX,i=a.clientY;const l=e.getBoundingClientRect(),c=document.querySelector(".bpx-player-primary-area"),d=c?.getBoundingClientRect()||{left:0,top:0};s=l.left-d.left,r=l.top-d.top,t.style.cursor="grabbing",a.preventDefault();},l=t=>{if(!n)return;const a=t.clientX-o,l=t.clientY-i,c=s+a,d=r+l;e.style.left=c+"px",e.style.top=d+"px",e.style.marginLeft="0";},c=()=>{n&&(n=false,t.style.cursor="move",this.saveContainerState(e));};t.addEventListener("mousedown",a),document.addEventListener("mousemove",l),document.addEventListener("mouseup",c),e._dragCleanup=()=>{t.removeEventListener("mousedown",a),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",c);};}bindResizeEvents(e){let t=false,n="",o=0,i=0,s=0,r=0,a=0,l=0;const c=(e,t)=>{const n=e.clientX-t.left,o=e.clientY-t.top,i=t.width,s=t.height;let r="";return o<8?r+="n":o>s-8&&(r+="s"),n<8?r+="w":n>i-8&&(r+="e"),r},d=n=>{if(t)return;const o=e.getBoundingClientRect(),i=c(n,o);e.className=e.className.replace(/\bresize-\w+\b/g,""),i&&e.classList.add(`resize-${i}`);},p=d=>{const p=e.getBoundingClientRect();n=c(d,p),n&&(d.target.closest(".subtitle-header")||(t=true,o=d.clientX,i=d.clientY,s=e.offsetWidth,r=e.offsetHeight,a=e.offsetLeft,l=e.offsetTop,d.preventDefault(),d.stopPropagation()));},u=c=>{if(!t)return;const d=c.clientX-o,p=c.clientY-i;let u=s,h=r,g=a,m=l;if(n.includes("e")&&(u=Math.max(400,Math.min(800,s+d))),n.includes("w")){const e=s-d;u=Math.max(400,Math.min(800,e)),g=a+(s-u);}if(n.includes("s")&&(h=Math.max(400,Math.min(.9*window.innerHeight,r+p))),n.includes("n")){const e=r-p;h=Math.max(400,Math.min(.9*window.innerHeight,e)),m=l+(r-h);}e.style.width=u+"px",e.style.height=h+"px",e.style.left=g+"px",e.style.top=m+"px";},h=()=>{t&&(t=false,n="",this.saveContainerState(e));};e.addEventListener("mousemove",d),e.addEventListener("mousedown",p),document.addEventListener("mousemove",u),document.addEventListener("mouseup",h),e._resizeCleanup=()=>{e.removeEventListener("mousemove",d),e.removeEventListener("mousedown",p),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",h);};}observeContainerResize(e){const t=new ResizeObserver(ve(()=>{this.saveContainerState(e);},500));t.observe(e),e._resizeObserver=t;}};const Qe=new class{constructor(){this.modal=null;}createModal(){return this.modal||(this.modal=document.createElement("div"),this.modal.id="help-modal",this.modal.className="config-modal",document.body.appendChild(this.modal)),this.modal}show(){const e=this.createModal();this.renderModal(),e.classList.add("show"),Ge.push(this);}hide(){this.modal&&this.modal.classList.remove("show"),Ge.pop(this);}renderModal(){this.modal.innerHTML='\n      <div class="config-modal-content">\n        <div class="config-modal-header">\n          <span>ä½¿ç”¨å¸®åŠ©</span>\n        </div>\n        <div class="config-modal-body">\n          <div style="margin-bottom: 20px;">\n            <h3 style="color: #fff; margin-bottom: 10px; font-size: 16px;">åŠŸèƒ½ç‰¹æ€§</h3>\n            <ul style="line-height: 1.8; color: #e5e7eb;">\n              <li><strong>å­—å¹•æå–</strong> - è‡ªåŠ¨æ£€æµ‹å¹¶æå–Bç«™AIå­—å¹•å’Œäººå·¥å­—å¹•</li>\n              <li><strong>AIæ™ºèƒ½æ€»ç»“</strong> - æ”¯æŒOpenAIã€OpenRouterç­‰å¤šç§AIæœåŠ¡</li>\n              <li><strong>Notioné›†æˆ</strong> - ä¸€é”®å‘é€å­—å¹•å’Œæ€»ç»“åˆ°Notionæ•°æ®åº“</li>\n              <li><strong>ç¬”è®°ä¿å­˜</strong> - é€‰ä¸­ä»»æ„æ–‡å­—æ˜¾ç¤ºç²‰è‰²é’¢ç¬”å›¾æ ‡ä¿å­˜ç¬”è®°</li>\n              <li><strong>æ’­æ”¾é€Ÿåº¦æ§åˆ¶</strong> - é”®ç›˜å¿«æ·é”®æ§åˆ¶é€Ÿåº¦</li>\n            </ul>\n          </div>\n\n          <div style="margin-bottom: 20px;">\n            <h3 style="color: #fff; margin-bottom: 10px; font-size: 16px;">å¿«æ·é”®</h3>\n            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">\n              <thead>\n                <tr style="background: rgba(255, 255, 255, 0.1); border-bottom: 1px solid rgba(254, 235, 234, 0.2);">\n                  <th style="padding: 8px; text-align: left; font-weight: 600; color: #fff;">åŠŸèƒ½</th>\n                  <th style="padding: 8px; text-align: left; font-weight: 600; color: #fff;">å¿«æ·é”®</th>\n                  <th style="padding: 8px; text-align: left; font-weight: 600; color: #fff;">è¯´æ˜</th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">åˆ‡æ¢å­—å¹•é¢æ¿</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">Cmd/Ctrl + B</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">æ˜¾ç¤º/éšè—å­—å¹•é¢æ¿</td>\n                </tr>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">è§†é¢‘æˆªå›¾</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">Cmd/Ctrl + S</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">æˆªå›¾å¹¶ä¿å­˜åˆ°ç¬”è®°</td>\n                </tr>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">å¢åŠ é€Ÿåº¦</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">.</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">æ¯æ¬¡å¢åŠ 0.1x</td>\n                </tr>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">å‡å°‘é€Ÿåº¦</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">,</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">æ¯æ¬¡å‡å°‘0.1x</td>\n                </tr>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">2å€é€Ÿ</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">.. (åŒå‡»)</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">ç›´æ¥è®¾ä¸º2å€é€Ÿ</td>\n                </tr>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">é‡ç½®é€Ÿåº¦</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">,, (åŒå‡»)</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">é‡ç½®ä¸º1å€é€Ÿ</td>\n                </tr>\n                <tr style="border-bottom: 1px solid rgba(254, 235, 234, 0.1);">\n                  <td style="padding: 8px; color: #e5e7eb;">ä¸´æ—¶åŠ é€Ÿ</td>\n                  <td style="padding: 8px;"><code style="background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px; color: #feebea;">å³Optioné”®</code></td>\n                  <td style="padding: 8px; color: rgba(255, 255, 255, 0.7);">æŒ‰ä½æ—¶1.5xåŠ é€Ÿ</td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n\n          <div style="margin-bottom: 20px;">\n            <h3 style="color: #fff; margin-bottom: 10px; font-size: 16px;">ä½¿ç”¨è¯´æ˜</h3>\n            <div style="line-height: 1.8; color: #e5e7eb;">\n              <p style="margin: 8px 0;"><strong>å­—å¹•æå–ï¼š</strong>æ‰“å¼€Bç«™è§†é¢‘ï¼Œç­‰å¾…å‡ ç§’ï¼Œå­—å¹•é¢æ¿è‡ªåŠ¨å‡ºç°åœ¨å³ä¾§</p>\n              <p style="margin: 8px 0;"><strong>AIæ€»ç»“ï¼š</strong>é…ç½®AIæœåŠ¡ï¼ˆèœå• â†’ AIé…ç½®ï¼‰ï¼Œç‚¹å‡»é­”æ³•æ£’å›¾æ ‡ âœ¨</p>\n              <p style="margin: 8px 0;"><strong>ç¬”è®°ä¿å­˜ï¼š</strong>é€‰ä¸­ä»»æ„æ–‡å­—ï¼Œç‚¹å‡»ç²‰è‰²é’¢ç¬”å›¾æ ‡</p>\n              <p style="margin: 8px 0;"><strong>è§†é¢‘æˆªå›¾ï¼š</strong>æŒ‰ Ctrl/Cmd + S æˆªå–å½“å‰å¸§ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°ç¬”è®°ï¼ŒBç«™è§†é¢‘å¯åŒæ­¥åˆ°Notion</p>\n              <p style="margin: 8px 0;"><strong>é€Ÿåº¦æ§åˆ¶ï¼š</strong>ä½¿ç”¨ , å’Œ . é”®è°ƒæ•´é€Ÿåº¦</p>\n            </div>\n          </div>\n\n          <div style="padding: 15px; background: rgba(254, 235, 234, 0.1); border-radius: 10px; border-left: 4px solid #feebea;">\n            <div style="font-size: 13px; color: #fff; font-weight: 600; margin-bottom: 4px;">æç¤º</div>\n            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); line-height: 1.5;">\n              â€¢ AIé…ç½®æ”¯æŒå¤šä¸ªæä¾›å•†ï¼Œå¯è‡ªç”±åˆ‡æ¢<br>\n              â€¢ ç¬”è®°ä¿å­˜åœ¨æœ¬åœ°ï¼ŒæŒ‰æ—¥æœŸè‡ªåŠ¨åˆ†ç»„<br>\n              â€¢ SponsorBlockæ”¯æŒè‡ªåŠ¨è·³è¿‡å¹¿å‘Šå’ŒèµåŠ©ç‰‡æ®µ\n            </div>\n          </div>\n        </div>\n        <div class="config-footer">\n          <button class="config-btn config-btn-primary" id="help-close-btn">çŸ¥é“äº†</button>\n        </div>\n      </div>\n    ',this.bindEvents();}bindEvents(){this.modal.addEventListener("click",e=>{e.target===this.modal&&this.hide();});const e=document.getElementById("help-close-btn");e&&e.addEventListener("click",()=>this.hide());}};const Ze=new class{constructor(){this.modal=null;}createModal(){return this.modal||(this.modal=document.createElement("div"),this.modal.id="sponsorblock-modal",this.modal.className="config-modal",document.body.appendChild(this.modal)),this.modal}show(){const e=this.createModal();this.renderModal(),e.classList.add("show"),Ge.push(this);}hide(){this.modal&&this.modal.classList.remove("show"),Ge.pop(this);}renderModal(){const e=qe.getAll();this.modal.innerHTML=`\n      <div class="config-modal-content">\n        <div class="config-modal-header">\n          <span>SponsorBlock è®¾ç½®</span>\n        </div>\n        <div class="config-modal-body">\n          <div style="margin-bottom: 20px; padding: 15px; background: rgba(254, 235, 234, 0.1); border-radius: 10px; border-left: 4px solid #feebea;">\n            <div style="font-size: 13px; color: #fff; font-weight: 600; margin-bottom: 4px;">ä½¿ç”¨è¯´æ˜</div>\n            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); line-height: 1.5;">\n              <strong>å‹¾é€‰çš„ç±»åˆ«</strong> â†’ è‡ªåŠ¨è·³è¿‡<br>\n              <strong>æœªå‹¾é€‰çš„ç±»åˆ«</strong> â†’ æ˜¾ç¤ºæ‰‹åŠ¨æç¤ºï¼ˆ5ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰<br>\n              åœ¨è¿›åº¦æ¡ä¸Šä¼šæ˜¾ç¤ºå½©è‰²æ ‡è®°ï¼Œç‚¹å‡»å¯æŸ¥çœ‹è¯¦æƒ…\n            </div>\n          </div>\n\n          <div class="sponsor-settings-section">\n            <h3>ç‰‡æ®µç±»åˆ«ï¼ˆå‹¾é€‰=è‡ªåŠ¨è·³è¿‡ï¼Œæœªå‹¾é€‰=æ‰‹åŠ¨æç¤ºï¼‰</h3>\n            <div class="sponsor-checkbox-group">\n              ${Object.entries(Z.CATEGORIES).map(([t,n])=>`\n                <div class="sponsor-checkbox-item">\n                  <input type="checkbox" \n                         id="category-${t}" \n                         value="${t}"\n                         ${e.skipCategories.includes(t)?"checked":""}>\n                  <label for="category-${t}">\n                    <span class="category-color-dot" style="background: ${n.color}"></span>\n                    <span>${n.name}</span>\n                  </label>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n\n          <div class="sponsor-settings-section">\n            <h3>æ˜¾ç¤ºé€‰é¡¹</h3>\n            <div class="sponsor-switch-item">\n              <span>æ˜¾ç¤ºç‰‡æ®µæ ‡ç­¾ï¼ˆè§†é¢‘å¡ç‰‡ï¼‰</span>\n              <label class="sponsor-switch">\n                <input type="checkbox" id="showAdBadge" \n                       ${e.showAdBadge?"checked":""}>\n                <span class="sponsor-switch-slider"></span>\n              </label>\n            </div>\n            <div class="sponsor-switch-item">\n              <span>æ˜¾ç¤ºä¼˜è´¨è§†é¢‘æ ‡ç­¾</span>\n              <label class="sponsor-switch">\n                <input type="checkbox" id="showQualityBadge" \n                       ${e.showQualityBadge?"checked":""}>\n                <span class="sponsor-switch-slider"></span>\n              </label>\n            </div>\n            <div class="sponsor-switch-item">\n              <span>è¿›åº¦æ¡æ˜¾ç¤ºç‰‡æ®µæ ‡è®°</span>\n              <label class="sponsor-switch">\n                <input type="checkbox" id="showProgressMarkers" \n                       ${e.showProgressMarkers?"checked":""}>\n                <span class="sponsor-switch-slider"></span>\n              </label>\n            </div>\n          </div>\n        </div>\n        <div class="config-footer">\n          <button class="config-btn config-btn-secondary" id="sponsorblock-cancel-btn">å–æ¶ˆ</button>\n          <button class="config-btn config-btn-primary" id="sponsorblock-save-btn">ä¿å­˜</button>\n        </div>\n      </div>\n    `,this.bindEvents();}bindEvents(){this.modal.addEventListener("click",e=>{e.target===this.modal&&this.hide();});const e=document.getElementById("sponsorblock-save-btn");e&&e.addEventListener("click",()=>this.saveSettings());const t=document.getElementById("sponsorblock-cancel-btn");t&&t.addEventListener("click",()=>this.hide());}saveSettings(){const e={skipCategories:Array.from(this.modal.querySelectorAll('.sponsor-checkbox-item input[type="checkbox"]:checked')).map(e=>e.value),showAdBadge:this.modal.querySelector("#showAdBadge").checked,showQualityBadge:this.modal.querySelector("#showQualityBadge").checked,showProgressMarkers:this.modal.querySelector("#showProgressMarkers").checked};qe.setAll(e),this.hide(),He.info("è®¾ç½®å·²ä¿å­˜ï¼\n\nâœ… å‹¾é€‰çš„ç±»åˆ« â†’ è‡ªåŠ¨è·³è¿‡\nâ¸ï¸ æœªå‹¾é€‰çš„ç±»åˆ« â†’ æ‰‹åŠ¨æç¤ºï¼ˆ5ç§’ï¼‰\n\né¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ–°è®¾ç½®ã€‚"),setTimeout(()=>{location.reload();},2e3);}};const et=new class{constructor(){this.resources={eventBusSubscriptions:new Map,domListeners:new Map,mutationObservers:new Set,intervals:new Map,timeouts:new Set,rafIds:new Set,audioContexts:new Set,customCleanups:new Set},this.isDestroyed=false,this.maxIntervalDuration=3e5,this.startAutoCleanup();}trackEventBusSubscription(e,t,n="default"){this.resources.eventBusSubscriptions.has(n)||this.resources.eventBusSubscriptions.set(n,[]),this.resources.eventBusSubscriptions.get(n).push({event:e,unsubscribe:t});}trackDOMListener(e,t,n,o){const i=Symbol("listener");return this.resources.domListeners.set(i,{element:e,event:t,handler:n,options:o}),e.addEventListener(t,n,o),i}removeDOMListener(e){const t=this.resources.domListeners.get(e);t&&(t.element.removeEventListener(t.event,t.handler,t.options),this.resources.domListeners.delete(e));}trackMutationObserver(e){return this.resources.mutationObservers.add(e),e}trackInterval(e,t,n=this.maxIntervalDuration){const o=Date.now(),i=setInterval(()=>{if(Date.now()-o>n)return de.warn("ResourceManager",`å®šæ—¶å™¨${i}è¿è¡Œè¶…è¿‡${n}msï¼Œè‡ªåŠ¨æ¸…ç†`),void this.clearTrackedInterval(i);e();},t);return this.resources.intervals.set(i,{startTime:o,maxDuration:n,delay:t}),i}clearTrackedInterval(e){clearInterval(e),this.resources.intervals.delete(e);}trackTimeout(e,t){const n=setTimeout(()=>{e(),this.resources.timeouts.delete(n);},t);return this.resources.timeouts.add(n),n}clearTrackedTimeout(e){clearTimeout(e),this.resources.timeouts.delete(e);}trackRAF(e){const t=requestAnimationFrame(e);return this.resources.rafIds.add(t),t}cancelTrackedRAF(e){cancelAnimationFrame(e),this.resources.rafIds.delete(e);}trackAudioContext(e){return this.resources.audioContexts.add(e),e}addCleanup(e){this.resources.customCleanups.add(e);}startAutoCleanup(){this.autoCleanupInterval=setInterval(()=>{this.cleanupExpiredIntervals();},3e4);}cleanupExpiredIntervals(){const e=Date.now(),t=[];this.resources.intervals.forEach((n,o)=>{e-n.startTime>n.maxDuration&&(de.warn("ResourceManager",`æ¸…ç†è¶…æ—¶interval: ${o}, è¿è¡Œäº†${((e-n.startTime)/1e3).toFixed(1)}ç§’`),clearInterval(o),t.push(o));}),t.forEach(e=>this.resources.intervals.delete(e)),t.length>0&&de.debug("ResourceManager",`å·²æ¸…ç†${t.length}ä¸ªè¶…æ—¶å®šæ—¶å™¨`);}getStats(){return {intervals:this.resources.intervals.size,timeouts:this.resources.timeouts.size,rafIds:this.resources.rafIds.size,audioContexts:this.resources.audioContexts.size,domListeners:this.resources.domListeners.size,mutationObservers:this.resources.mutationObservers.size,eventBusSubscriptions:Array.from(this.resources.eventBusSubscriptions.values()).reduce((e,t)=>e+t.length,0)}}cleanupModule(e){const t=this.resources.eventBusSubscriptions.get(e);t&&(t.forEach(({unsubscribe:t})=>{try{t();}catch(n){console.error(`[ResourceManager] æ¸…ç†æ¨¡å— "${e}" è®¢é˜…å¤±è´¥:`,n);}}),this.resources.eventBusSubscriptions.delete(e));}cleanup(){this.isDestroyed?de.warn("ResourceManager","å·²ç»é”€æ¯ï¼Œè·³è¿‡æ¸…ç†"):(de.debug("ResourceManager","å¼€å§‹æ¸…ç†èµ„æº..."),this.resources.eventBusSubscriptions.forEach((e,t)=>{e.forEach(({event:e,unsubscribe:n})=>{try{n();}catch(o){console.error(`[ResourceManager] æ¸…ç† EventBus è®¢é˜…å¤±è´¥ (${t}.${e}):`,o);}});}),this.resources.eventBusSubscriptions.clear(),this.resources.domListeners.forEach(({element:e,event:t,handler:n,options:o})=>{try{e.removeEventListener(t,n,o);}catch(i){console.error("[ResourceManager] æ¸…ç† DOM ç›‘å¬å™¨å¤±è´¥:",i);}}),this.resources.domListeners.clear(),this.resources.mutationObservers.forEach(e=>{try{e.disconnect();}catch(t){console.error("[ResourceManager] æ¸…ç† MutationObserver å¤±è´¥:",t);}}),this.resources.mutationObservers.clear(),this.resources.intervals.forEach((e,t)=>{try{clearInterval(t);}catch(n){console.error("[ResourceManager] æ¸…ç† interval å¤±è´¥:",n);}}),this.resources.intervals.clear(),this.autoCleanupInterval&&(clearInterval(this.autoCleanupInterval),this.autoCleanupInterval=null),this.resources.timeouts.forEach(e=>{try{clearTimeout(e);}catch(t){console.error("[ResourceManager] æ¸…ç† timeout å¤±è´¥:",t);}}),this.resources.timeouts.clear(),this.resources.rafIds.forEach(e=>{try{cancelAnimationFrame(e);}catch(t){console.error("[ResourceManager] æ¸…ç† RAF å¤±è´¥:",t);}}),this.resources.rafIds.clear(),this.resources.audioContexts.forEach(e=>{try{"closed"!==e.state&&e.close();}catch(t){console.error("[ResourceManager] å…³é—­ AudioContext å¤±è´¥:",t);}}),this.resources.audioContexts.clear(),this.resources.customCleanups.forEach(e=>{try{e();}catch(t){console.error("[ResourceManager] æ‰§è¡Œè‡ªå®šä¹‰æ¸…ç†å¤±è´¥:",t);}}),this.resources.customCleanups.clear(),this.isDestroyed=true,de.debug("ResourceManager","èµ„æºæ¸…ç†å®Œæˆ"));}getStats(){return {eventBusSubscriptions:Array.from(this.resources.eventBusSubscriptions.entries()).reduce((e,[t,n])=>(e[t]=n.length,e),{}),domListeners:this.resources.domListeners.size,mutationObservers:this.resources.mutationObservers.size,intervals:this.resources.intervals.size,timeouts:this.resources.timeouts.size,rafIds:this.resources.rafIds.size,audioContexts:this.resources.audioContexts.size,customCleanups:this.resources.customCleanups.size}}},tt=location.hostname.endsWith("bilibili.com");const nt=new class{constructor(){this.initialized=false,this.ball=null,this.container=null,this.videoQualityService=null,this.isBilibili=tt;}setupErrorHandler(){const e=window.onerror;window.onerror=(t,n,o,i,s)=>n&&(n.includes("extension://")||n.includes("content.js"))?(de.debug("Main","å¿½ç•¥æ¥è‡ªå…¶ä»–æ‰©å±•çš„é”™è¯¯:",t),true):t&&t.includes("Extension context invalidated")?(de.debug("Main","å¿½ç•¥æ‰©å±•ä¸Šä¸‹æ–‡å¤±æ•ˆé”™è¯¯"),true):!!e&&e(t,n,o,i,s),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&e.reason.message.includes("Extension context invalidated")&&(e.preventDefault(),de.debug("Main","å¿½ç•¥Promiseä¸­çš„æ‰©å±•ä¸Šä¸‹æ–‡å¤±æ•ˆé”™è¯¯"));}),de.info("Main","å…¨å±€é”™è¯¯å¤„ç†å™¨å·²è®¾ç½®");}async init(){var e;this.initialized||(this.setupErrorHandler(),function(){const e=document.createElement("style");e.textContent=ee,document.head.appendChild(e);}(),await this.waitForPageReady(),pe.fixExistingConfigPrompts(),Te.init(),De.init(),this.isBilibili&&(await Fe.init(),this.videoQualityService=(e=Fe.getAPI(),Ve||(Ve=new Ke(e)),Ve),this.videoQualityService.start()),this.isBilibili&&this.createUI(),this.bindEvents(),this.isBilibili&&this.setupAutomation(),this.registerMenuCommands(),this.registerShortcuts(),this.isBilibili&&(we.checkSubtitleButton(),this.observeVideoChange()),this.initialized=true);}registerShortcuts(){ge.register("toggleSubtitlePanel",()=>{ce.togglePanel();}),ge.register("toggleNotesPanel",()=>{Je.togglePanel();}),ge.register("takeScreenshot",async()=>{try{const e=ce.getVideoInfo(),t=e?.bvid,n=pe.getNotionConfig().apiKey&&t&&ce.getNotionPageId(t);if(await je.captureAndSave(n)){He.success(n?"æˆªå›¾å·²ä¿å­˜åˆ°ç¬”è®°å’ŒNotion":"æˆªå›¾å·²ä¿å­˜åˆ°ç¬”è®°");const e=document.querySelector(".notes-panel");e&&"none"!==e.style.display&&window.notesPanel?.render();}}catch(e){console.error("[Main] æˆªå›¾å¤±è´¥:",e),He.error("æˆªå›¾å¤±è´¥: "+e.message);}}),ge.startListening();}registerMenuCommands(){"undefined"!=typeof GM_registerMenuCommand&&(this.isBilibili&&(GM_registerMenuCommand("AIé…ç½®",()=>{We.showAIConfigModal();}),GM_registerMenuCommand("Notioné…ç½®",()=>{We.showNotionConfigModal();})),GM_registerMenuCommand("ç¬”è®°ç®¡ç†",()=>{Je.togglePanel();}),GM_registerMenuCommand("âŒ¨ï¸ å¿«æ·é”®è®¾ç½®",()=>{if(de.debug("Main","å¿«æ·é”®è®¾ç½®èœå•è¢«ç‚¹å‡»"),de.debug("Main","eventHandlers æ˜¯å¦å­˜åœ¨:",!!We),de.debug("Main","showShortcutConfigModal æ˜¯å¦å­˜åœ¨:",!!We?.showShortcutConfigModal),!We||!We.showShortcutConfigModal)return console.error("[Main] eventHandlers æˆ–å…¶æ–¹æ³•æœªæ­£ç¡®åŠ è½½"),void He.error("å¿«æ·é”®è®¾ç½®åŠŸèƒ½æœªæ­£ç¡®åŠ è½½");We.showShortcutConfigModal();}),this.isBilibili&&(GM_registerMenuCommand("ğŸ”„ é‡ç½®å­—å¹•é¢æ¿ä½ç½®",()=>{const e=document.getElementById("subtitle-container");e?We.resetContainerPosition(e):He.warning("å­—å¹•é¢æ¿æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåŠ è½½è§†é¢‘");}),GM_registerMenuCommand("SponsorBlock è®¾ç½®",()=>{Ze.show();})),GM_registerMenuCommand("ä½¿ç”¨å¸®åŠ©",()=>{Qe.show();}),GM_registerMenuCommand(`ğŸ”§ è°ƒè¯•æ¨¡å¼ (${de.isDebugMode()?"å¼€å¯":"å…³é—­"})`,()=>{const e=de.toggleDebugMode();He.info("è°ƒè¯•æ¨¡å¼å·²"+(e?"å¼€å¯":"å…³é—­")),e&&He.info("è°ƒè¯•æ¨¡å¼å·²å¼€å¯ï¼Œæ§åˆ¶å°å°†è¾“å‡ºè¯¦ç»†æ—¥å¿—");}));}async waitForPageReady(){return this.isBilibili?new Promise(t=>{const n=setInterval(()=>{document.querySelector(X)&&(clearInterval(n),t());},e);}):new Promise(e=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>e(),{once:true}):e();})}createUI(){this.ball=document.createElement("div"),this.ball.id="subtitle-ball",this.ball.title="å­—å¹•æå–å™¨";const e=document.querySelector(X);e&&("relative"!==e.style.position&&"absolute"!==e.style.position&&(e.style.position="relative"),e.appendChild(this.ball)),this.createEmbeddedContainer();const t=Ue.createNotionConfigModal();document.body.appendChild(t),We.bindNotionConfigModalEvents(t);const n=Ue.createAIConfigModal();document.body.appendChild(n),We.bindAIConfigModalEvents(n);}createEmbeddedContainer(){this.container=document.createElement("div"),this.container.id="subtitle-container";const e=document.querySelector(X);e?("relative"!==e.style.position&&"absolute"!==e.style.position&&(e.style.position="relative"),e.appendChild(this.container)):document.body.appendChild(this.container);}bindEvents(){le.on(y,(e,t)=>{this.renderSubtitles(e),We.initializeSearchIndex(e);}),le.on(w,()=>{de.debug("App","AIæ€»ç»“å¼€å§‹ï¼Œå°çƒè¿›å…¥AIæ€»ç»“çŠ¶æ€"),this.ball&&(this.ball.classList.remove("loading","active","no-subtitle","error"),this.ball.classList.add("ai-summarizing"),this.ball.title="æ­£åœ¨AIæ€»ç»“...");const e=this.container?.querySelector(".ai-icon");e&&e.classList.add("loading");}),le.on(I,e=>{this.container&&Ue.updateAISummary(this.container,e);}),le.on(S,(e,t)=>{de.debug("App","AIæ€»ç»“å®Œæˆï¼Œæ¢å¤å°çƒæ­£å¸¸çŠ¶æ€"),He.success("AIæ€»ç»“å®Œæˆ"),this.container&&Ue.updateAISummary(this.container,e),this.ball&&(this.ball.classList.remove("ai-summarizing","loading"),this.ball.classList.add("active"),this.ball.title="å­—å¹•æå–å™¨ - ç‚¹å‡»æŸ¥çœ‹å­—å¹•");const n=this.container?.querySelector(".ai-icon");n&&n.classList.remove("loading");}),le.on(C,()=>{He.success("å­—å¹•å·²æˆåŠŸå‘é€åˆ° Notion");const e=this.container?.querySelector(".notion-icon");e&&e.classList.remove("loading");}),le.on(x,e=>{He.handleError(e,"å­—å¹•è·å–");}),le.on(k,e=>{de.debug("App","AIæ€»ç»“å¤±è´¥ï¼Œæ¢å¤å°çƒæ­£å¸¸çŠ¶æ€"),He.handleError(e,"AIæ€»ç»“"),this.ball&&(this.ball.classList.remove("ai-summarizing","loading"),this.ball.classList.add("active"),this.ball.title="å­—å¹•æå–å™¨ - ç‚¹å‡»æŸ¥çœ‹å­—å¹•");const t=this.container?.querySelector(".ai-icon");t&&t.classList.remove("loading");}),le.on(A,e=>{He.handleError(e,"Notionå‘é€");}),le.on(T,e=>{this.updateBallStatus(e);}),le.on(M,e=>{this.container&&(e?this.container.classList.add("show"):this.container.classList.remove("show"));}),document.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey)&&"b"===e.key&&(e.preventDefault(),ce.togglePanel());});}renderSubtitles(e){if(!this.container||!e)return;this.container.innerHTML=Ue.renderSubtitlePanel(e);const t=ce.getVideoKey(),n=t?ce.getAISummary(t):null;n&&Ue.updateAISummary(this.container,n),We.bindSubtitlePanelEvents(this.container),de.debug("App","å­—å¹•é¢æ¿å·²æ¸²æŸ“");}setupAutomation(){le.on(y,async e=>{await xe(a);const t=pe.getAIAutoSummaryEnabled(),n=pe.getSelectedAIConfig(),o=ce.getVideoKey(),i=o?ce.getAISummary(o):null;if(t&&n&&n.apiKey&&!i)try{await ke.summarize(e,!0);}catch(s){console.error("[App] è‡ªåŠ¨æ€»ç»“å¤±è´¥:",s);}}),le.on(S,async()=>{const e=pe.getNotionAutoSendEnabled(),t=pe.getNotionConfig();if(e&&t.apiKey){const e=ce.getSubtitleData();if(e)try{await Se.sendSubtitle(e,!0);}catch(n){console.error("[App] è‡ªåŠ¨å‘é€å¤±è´¥:",n);}}}),le.on(y,async e=>{await xe(a);const t=pe.getAIAutoSummaryEnabled(),n=pe.getNotionAutoSendEnabled(),o=pe.getNotionConfig();if(!t&&n&&o.apiKey)try{await Se.sendSubtitle(e,!0);}catch(i){console.error("[App] è‡ªåŠ¨å‘é€å¤±è´¥:",i);}});}updateBallStatus(e){if(this.ball)switch(this.ball.classList.remove("loading","active","no-subtitle","error"),e){case m:this.ball.classList.add("active"),this.ball.style.cursor="pointer",this.ball.onclick=()=>ce.togglePanel(),this.ball.title="å­—å¹•æå–å™¨ - ç‚¹å‡»æŸ¥çœ‹å­—å¹•";break;case b:this.ball.classList.add("no-subtitle"),this.ball.style.cursor="default",this.ball.onclick=null,this.ball.title="è¯¥è§†é¢‘æ— å­—å¹•";break;case f:this.ball.classList.add("error"),this.ball.style.cursor="default",this.ball.onclick=null,this.ball.title="å­—å¹•åŠ è½½å¤±è´¥";break;case g:this.ball.classList.add("loading"),this.ball.style.cursor="default",this.ball.onclick=null,this.ball.title="æ­£åœ¨åŠ è½½å­—å¹•...";}}observeVideoChange(){let e=location.href,t=location.href.match(/BV[1-9A-Za-z]{10}/)?.[0],n=null;const o=()=>{try{const e=unsafeWindow.__INITIAL_STATE__;return e?.videoData?.cid||e?.videoData?.pages?.[0]?.cid}catch(e){return null}};n=o();const i=()=>{const i=location.href,s=i.match(/BV[1-9A-Za-z]{10}/)?.[0],a=o();i===e||s===t&&a===n||(de.debug("App","æ£€æµ‹åˆ°è§†é¢‘åˆ‡æ¢:",{from:t,to:s}),e=i,t=s,n=a,ce.reset(),we.reset(),le.emit(L,{bvid:s,cid:a}),setTimeout(()=>{const e=fe();ce.setVideoInfo(e),we.checkSubtitleButton();},r));},s=history.pushState,a=history.replaceState;history.pushState=function(...e){s.apply(this,e),i();},history.replaceState=function(...e){a.apply(this,e),i();},window.addEventListener("popstate",i);const l=setInterval(i,1e3);this.urlChangeCleanup=()=>{history.pushState=s,history.replaceState=a,window.removeEventListener("popstate",i),clearInterval(l);},de.debug("App","è§†é¢‘åˆ‡æ¢ç›‘å¬å·²å¯åŠ¨ï¼ˆä½¿ç”¨ History API åŠ«æŒï¼‰");}cleanup(){de.debug("App","å¼€å§‹æ¸…ç†åº”ç”¨èµ„æº"),this.urlChangeCleanup&&this.urlChangeCleanup(),this.videoQualityService&&this.videoQualityService.stop(),Fe.playerController&&Fe.playerController.destroy(),De.destroy(),searchIndex.clear(),me.destroy(),et.cleanup(),de.debug("App","åº”ç”¨èµ„æºæ¸…ç†å®Œæˆ");}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>nt.init()):nt.init();

})();