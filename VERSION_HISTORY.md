## v1.3.7 (2025-11-26 18:20)
- 更新时间: 2025-11-26 18:20
- 更新类型: patch
- 更新说明: 修复笔记存储问题并优化UI显示
  - **全局笔记存储**: 将笔记存储从 `localStorage` 切换到 `GM.setValue` / `GM.getValue`，实现跨站点全局笔记记录与查看。
  - **UI层级修复**: 修正了笔记面板的 `z-index`，确保其在所有页面元素之上正确显示，避免被遮挡。

---

## v1.3.6 (2025-11-26 18:20)
- 更新时间: 2025-11-26 18:20
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.3.5 (2025-11-26 18:20)
- 更新时间: 2025-11-26 18:20
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.3.4 (2025-11-03 21:55)
- 更新时间: 2025-11-03 21:55
- 更新类型: patch
- 更新说明: 🎯 统一快捷键管理架构，所有快捷键功能集中到 ShortcutManager
  
  **架构重构：**
  - 将 SpeedControlService 的 Option 键处理迁移到 ShortcutManager 统一管理
  - 新增 `speedBoost` 快捷键（右侧 Option 键）：长按临时加速、双击永久加速
  - 增强 ShortcutManager 的长按模式，支持 press/release/doubleClick 多种回调
  - 支持特殊键检测（如 AltRight + location === 2）
  
  **代码解耦：**
  - SpeedControlService 移除所有键盘事件监听代码（~70 行）
  - 清理不再使用的状态变量（isRightOptionPressed、lastKeyPressTime 等）
  - 所有快捷键逻辑现在统一在 ShortcutManager 中维护
  
  **复用性提升：**
  - 长按模式现在支持对象形式的处理器：`{ press, release, doubleClick }`
  - 更容易扩展新的长按/双击快捷键功能
  - 代码结构更清晰，职责分离明确
  
  **功能保持：**
  - Option 键的所有原有功能完全保持不变
  - 长按 Option 键：临时 1.5 倍加速
  - 双击 Option 键：永久 1.5 倍加速
  - 松开 Option 键：取消临时加速

---

## v1.3.3 (2025-11-03 21:47)
- 更新时间: 2025-11-03 21:47
- 更新类型: patch
- 更新说明: 🧹 移除向后兼容代码，进一步简化快捷键管理架构
  
  **代码精简：**
  - 移除 `normalizeShortcut` 中将旧 `doubleClick` 转换为 `doubleClickMode` 的兼容逻辑
  - 精简 `loadShortcuts` 方法，移除冗余的向后兼容检查和日志
  - 优化错误处理逻辑，使用 logger 统一输出
  
  **架构改进：**
  - `normalizeShortcut` 现在只负责规范化和填充默认值，逻辑更清晰
  - `loadShortcuts` 更简洁，损坏的配置直接跳过使用默认值
  - 减少约 15 行代码，提升代码可读性
  
  **⚠️ 注意：**
  - 此版本不再支持旧的 `doubleClick` 属性
  - 用户需重新设置双击快捷键（如遇到问题）

---

## v1.3.2 (2025-11-03 21:45)
- 更新时间: 2025-11-03 21:45
- 更新类型: patch
- 更新说明: ♻️ 重构快捷键配置架构，简化代码、提升可维护性
  
  **代码优化：**
  - 创建 `createShortcut` 辅助函数，统一管理快捷键配置生成
  - 简化默认快捷键配置，从冗长的属性声明改为简洁的函数调用
  - 示例：`{ key: 'KeyB', meta: true, ctrl: true, alt: false, shift: false, description: '...' }` 
    → `createShortcut('KeyB', { cmd: true, description: '...' })`
  
  **架构改进：**
  - 新增 `normalizeShortcut` 方法，统一处理配置规范化和向后兼容
  - 确保所有布尔属性都有明确的默认值（false）
  - 自动填充缺失的属性，防止配置错误
  
  **代码质量提升：**
  - 减少重复代码，提高配置可读性
  - 统一管理跨平台修饰键（cmd 参数自动映射到 meta/ctrl）
  - 更容易添加和维护新的快捷键

---

## v1.3.1 (2025-11-03 21:42)
- 更新时间: 2025-11-03 21:42
- 更新类型: patch
- 更新说明: 🐛 修复默认双击快捷键（`,`,`.`）失效问题，统一快捷键管理架构
  
  **问题修复：**
  - 修复 `,`（双击重置速度）和 `.`（双击2倍速）默认快捷键失效的问题
  - 问题原因：默认配置使用了旧的 `doubleClick` 属性，但新代码期望 `doubleClickMode` 属性
  
  **架构改进：**
  - 统一使用 `doubleClickMode` 管理所有双击快捷键
  - 移除冗余的 `doubleClick` 属性及其特殊处理逻辑
  - 简化 ShortcutManager 的 handleKeyDown 方法，所有双击快捷键统一由 handleDoubleClick 处理
  - 优化冲突检测逻辑，同时检查 `doubleClickMode` 和 `holdMode`
  
  **向后兼容：**
  - 自动将旧配置中的 `doubleClick` 转换为 `doubleClickMode`
  - 已有用户的自定义快捷键配置可无缝升级

---

## v1.3.0 (2025-11-03 02:22)
- 更新时间: 2025-11-03 02:22
- 更新类型: minor
- 更新说明: ✨ 合并 1.2.x 全部未发布改动为一个小版本（1.3.0），聚焦性能、稳定性与跨平台体验全面提升

  **概览：**
  - LRU 缓存与智能重试、初始化与并发防护、Notion 分批发送、YouTube 标签与进度条标记修复、UI 精简与交互优化

  **性能与稳定性：**
  - 引入 LRU 缓存（字幕/AI 总结/Notion 页面 ID 独立缓存），命中即跳过网络请求
  - 自动模式对所有错误启用指数退避重试（1s/2s/4s，最多 3 次），更抗网络抖动
  - 添加 iframe 检测、服务单例与并发初始化保护，修复重复初始化与事件重复触发

  **AI 总结与广告检测：**
  - 将广告检测合并进段落总结，统一返回 segments JSON（含广告段落，title 固定为「广告」）
  - 新增计时日志，分别统计 Prompt1（Markdown）/Prompt2（段落+广告）与总耗时
  - 手动触发时提供是否重新生成的确认；自动模式智能重试并按需补齐缺失部分

  **Notion 集成：**
  - 彻底解决 100 blocks 限制：创建/追加时 >95 自动分批发送，确保内容完整
  - 字幕作为子页面存储，主页面结构优化（时间戳段落 → AI 总结 → 子页面引用）
  - 统一发送路径，增加多级缓存恢复与重复发送检测（静默跳过/交互确认）

  **字幕与多 P 视频：**
  - 统一分 P 键（bvid-cid-p），修复竞态与重复触发导致的异常
  - 拦截器直接使用响应数据，减少无效按钮点击与请求失败

  **UI 与交互：**
  - 油猴菜单与面板精简：移除搜索功能；截图仅发送到 Notion
  - 新增通用确认对话框，避免重复操作与误触

  **YouTube 支持与广告标记：**
  - 修复进度条广告标记显示与层级问题，支持新版布局标签显示
  - 兼容 Trusted Types/CSP；增强页面类型检测与布局适配
  - 标签视觉与性能优化：并发/限速/缓存/自动清理

  **其他修复：**
  - 修复 AI 总结开始/完成事件重复触发导致的状态不一致
  - 改进日志系统与调试输出，问题排查更高效

---

## v1.2.42 (2025-11-03 02:03)
- 更新时间: 2025-11-03 02:03
- 更新类型: patch
- 更新说明: 🔁 自动AI总结对所有错误启用指数退避重试（不仅限429）

  **修复与优化：**
  - 自动模式（非手动）下，Prompt1/Prompt2只要对应缓存缺失，遇到任何错误均会重试
  - 重试策略：指数退避（1s, 2s, 4s），最多3次
  - 继续保留429限流的详细日志输出
  - 兼容网络抖动/响应不完整导致的 JSON 解析错误（Unexpected end of JSON input）

  **实现细节：**
  - 新增参数`retryOnAllErrors`，自动模式启用，手动模式保持仅限429重试
  - 在执行任务阶段按需对Markdown与Segments分别重试，互不影响

---

## v1.2.38 (2025-11-02 22:42)
- 更新时间: 2025-11-02 22:42
- 更新类型: patch
- 更新说明: 🚀 实现LRU缓存机制，大幅优化性能和用户体验

  **核心改进：**
  - 实现LRU缓存管理器，默认缓存10个视频数据
  - 字幕/AI总结/Notion页面ID分别独立缓存
  - 已缓存数据自动跳过网络请求，节省资源
  - 添加用户确认对话框，避免意外重复操作
  
  **字幕服务优化：**
  - ✅ 已获取的字幕不再重复点击按钮和拦截
  - ✅ 手动请求时弹出确认对话框供用户选择
  - ✅ 分P视频独立缓存（使用bvid-cid-p格式）
  
  **AI服务优化：**
  - ✅ 分部分缓存：Markdown和段落总结独立缓存
  - ✅ 智能请求：只请求缺失的部分，避免重复
  - ✅ 429限流自动重试：指数退避（1s, 2s, 4s）
  - ✅ 手动请求时询问用户是否重新生成
  
  **Notion服务优化：**
  - ✅ 多级缓存恢复：LRU → State → sessionStorage → 远端查询
  - ✅ 手动发送重复检测：弹出确认对话框
  - ✅ 自动发送重复检测：静默跳过，避免重复发送
  - ✅ 页面刷新后自动恢复pageId缓存

---

## v1.2.37 (2025-11-02 17:10)
- 更新时间: 2025-11-02 17:10
- 更新类型: patch
- 更新说明: ✨ 优化AI广告检测功能，简化Prompt2格式

  **改进内容：**
  - 修改 Prompt2 提示词，将广告检测集成到段落总结中
  - 广告段落作为普通segment返回，title固定为"广告"
  - AI自动识别商业推广内容并标记为广告段落
  - 自动将广告段落添加到进度条标记，支持跳过功能
  
  **新的Prompt2格式：**
  - 分析带时间戳字幕，提取关键段落
  - 如发现广告推广，添加title为"广告"的段落
  - 返回纯JSON格式（segments数组）
  - 示例：`{"segments":[{"timestamp":"02:30","title":"广告","summary":"推广某品牌手机"}]}`
  
  **优点：**
  - 简化了AI请求逻辑（从3个请求减少到2个）
  - 广告检测更加准确和灵活
  - 自动跳过广告，提升观看体验
  - 与SponsorBlock进度条标记系统无缝集成

---

## v1.2.36 (2025-11-02 17:03)
- 更新时间: 2025-11-02 17:03
- 更新类型: patch
- 更新说明: ✨ 优化AI总结日志，区分Prompt1和Prompt2的耗时

  **改进内容：**
  - 为 Prompt1（Markdown格式总结）和 Prompt2（段落总结+广告分析）添加独立的计时日志
  - 添加总耗时统计，方便性能分析
  
  **日志格式：**
  ```
  🐛 [计时] AI总结 - Prompt1 (Markdown格式): 23644.80ms
  🐛 [计时] AI总结 - Prompt2 (段落+广告): 12345.50ms
  🐛 [计时] AI总结 - 总耗时: 25989.30ms
  ```
  
  **优点：**
  - 清晰显示每个AI请求的独立耗时
  - 方便排查性能瓶颈（哪个请求更慢）
  - 总耗时可以看到并行执行的效果（略大于最慢的单个请求）

---

## v1.2.35 (2025-11-02 17:01)
- 更新时间: 2025-11-02 17:01
- 更新类型: patch
- 更新说明: 🐛 修复AI总结计时日志重复输出的问题

  **问题现象：**
  - 浏览器控制台出现多条相同的 "🐛 [计时] AI总结: XXXXXms" 日志（通常是2条或更多）

  **原因分析：**
  - `SUBTITLE_LOADED` 事件被重复触发：
    1. `SubtitleService` 调用 `state.setSubtitleData()` → StateManager 内部触发一次事件
    2. `SubtitleService` 自己又触发一次事件
  - 导致 `setupAutomation()` 中的事件监听器被多次执行，AI总结函数被多次调用
  - 虽然有去重机制阻止了真正的重复请求，但每次进入 `aiService.summarize()` 都会输出一次计时日志

  **修复方案：**
  - 移除 `StateManager.setSubtitleData()` 中的事件触发
  - 统一由 `SubtitleService` 和 `YouTubeSubtitleService` 在处理完成后触发事件
  - 确保每个字幕数据只触发一次 `SUBTITLE_LOADED` 事件

  **预期效果：**
  - AI总结计时日志只输出一次
  - 避免不必要的函数调用和性能开销

---

## v1.2.34 (2025-11-02 16:49)
- 更新时间: 2025-11-02 16:49
- 更新类型: patch
- 更新说明: 🐛 修复截图发送到Notion提示"请先发送字幕和AI总结"误报的问题

  **问题现象：**
  - 已成功在Notion创建主页面与字幕子页面，但截图发送仍报"请先发送字幕和AI总结到Notion，以创建视频页面"

  **原因分析：**
  - `ScreenshotService` 使用 `bvid` 作为页面缓存键，而 `NotionService/StateManager` 使用包含分P的 `videoKey`（如 `BVxxx-cid-p1`），导致缓存未命中

  **修复方案：**
  - 统一使用 `videoKey` 存取 Notion 页面ID
  - 数据库回查时同时传入分P参数，确保查询到对应分P的页面

  **预期效果：**
  - 已创建的页面可被正确识别，截图能直接追加到对应页面，无需重复发送字幕/总结

---

## v1.2.33 (2025-11-02 16:10)
- 更新时间: 2025-11-02 16:10
- 更新类型: patch
- 更新说明: 🐛 修复AI总结开始事件重复触发导致日志看似多次总结

  **问题现象：**
  - 控制台多次出现"AI总结开始，小球进入AI总结状态"与"AI总结开始"相关日志
  - 实际只有一个总结任务在运行，其余触发进入"等待完成"分支

  **原因分析：**
  - `AIService.summarize` 在发现已有运行中任务时，未设置 `state.ai.isSummarizing`，导致后续并发触发重复发送 `AI_SUMMARY_START`

  **修复方案：**
  - 在两处触发开始事件前引入原子护栏：调用 `state.startAISummary()`，仅当首次返回 true 时才 `emit(EVENTS.AI_SUMMARY_START)`
  - 补充 `BALL_STATUS` 导入，避免潜在引用异常

  **预期效果：**
  - 同一视频在同一次总结期间仅触发一次"开始总结"事件
  - 日志不再重复，小球进入AI总结状态一次且在完成或失败时正确恢复

---

## v1.2.32 (2025-11-02 15:52)
- 更新时间: 2025-11-02 15:52
- 更新类型: patch
- 更新说明: ✏️ 调整AI第一个提示词（Markdown总结）文本，去除"时间戳"要求

  **变更内容：**
  - ✅ 更新 `AIService._getDefaultPrompt1()` 提示词：采用"总分结构，分段表示哪部分讲什么内容"，不再提到"时间戳"
  - ✅ 同步更新 `constants.js` 中的 `DEFAULT_PROMPT_1`，与实际生效的默认提示保持一致
  - ℹ️ 原因：第一个请求使用的是纯字幕文本（不含时间戳），应避免提示词中出现"时间戳"的表述

  **预期效果：**
  - 模型按照总分结构生成Markdown总结
  - 开头提供 ≤50字的 TL;DR 核心摘要
  - 使用标题与列表组织要点，无"时间戳"表述的歧义

---

## v1.2.31 (2025-11-02 15:44)
- 更新时间: 2025-11-02 15:44
- 更新类型: patch
- 更新说明: 🐛 修复字幕获取的竞态条件问题

  **问题修复：**
  - 🐛 修复拦截器已捕获字幕后，仍然触发按钮点击导致的错误
  - ✅ 在多个关键位置添加字幕数据检查，避免重复操作
  - ✅ 延迟后检查：在`tryActivateSubtitle`延迟后检查拦截器是否已捕获
  - ✅ 点击前检查：在`triggerSubtitleSelection`执行前检查拦截器是否已捕获
  - ✅ 点击后检查：点击按钮后立即检查拦截器是否已捕获
  - ✅ 等待后检查：等待字幕URL时也检查拦截器是否已捕获数据

  **预期效果：**
  - 不再出现"字幕激活失败：未捕获到字幕URL"的错误（当拦截器已捕获时）
  - 避免不必要的按钮点击操作
  - 字幕获取更稳定可靠

---

## v1.2.30 (2025-11-02 15:43)
- 更新时间: 2025-11-02 15:43
- 更新类型: patch
- 更新说明: 🔄 修改截图功能：不再保存到本地笔记，仅发送到Notion

  **功能调整：**
  - 🗑️ 移除截图保存到本地笔记的功能
  - 🗑️ 移除截图添加到AI总结笔记的功能
  - ✅ 截图功能仅用于发送到Notion
  - ✅ 如果Notion未配置，会提示用户先配置Notion

  **代码优化：**
  - 🗑️ 移除`notesService`依赖和`blobToBase64`方法
  - 📝 更新方法注释，明确说明不再保存到本地笔记
  - 🎨 简化代码逻辑，减少不必要的处理步骤

  **预期效果：**
  - 截图只会发送到Notion，不会在本地笔记中记录
  - 必须配置Notion才能使用截图功能
  - 代码更简洁，文件大小减少（336.42 kB → 336.29 kB）

---

## v1.2.29 (2025-11-02 15:42)
- 更新时间: 2025-11-02 15:42
- 更新类型: patch
- 更新说明: 🗑️ 删除油猴面板的截图菜单项，仅保留快捷键触发

  **功能优化：**
  - 🗑️ 删除油猴菜单中的"📸 截图"菜单项
  - ✅ 保留快捷键触发截图功能（可通过快捷键设置自定义）
  - 🎨 简化油猴菜单，减少不必要的菜单项

  **预期效果：**
  - 截图功能只能通过快捷键触发，更符合快速操作的需求
  - 油猴菜单更简洁，避免重复功能

---

## v1.2.28 (2025-11-02 15:40)
- 更新时间: 2025-11-02 15:40
- 更新类型: patch
- 更新说明: 🗑️ 删除搜索功能，修复Notion发送blocks限制问题

  **功能移除：**
  - 🗑️ 删除字幕面板的搜索功能（搜索输入框、导航按钮、相关方法）
  - 🗑️ 移除SearchIndex工具类相关引用
  - 🎨 界面更简洁，减少不必要的功能

  **Notion修复：**
  - ✅ 修复Notion发送时blocks数量超过100的限制问题
  - ✅ 实现分批发送：创建页面时如果超过95个blocks，自动分批发送
  - ✅ 修复`_createPage`、`_createChildPage`、`_createSubtitlePage`方法，都支持分批发送
  - ✅ 超过限制的blocks会自动追加到页面，确保内容完整

  **预期效果：**
  - Notion发送不再出现"body.children.length should be ≤ 100"错误
  - 即使内容很多（如大量时间戳段落或长字幕），也能正常发送到Notion
  - 界面更简洁，专注于核心功能

---

## v1.2.27 (2025-11-02 15:31)
- 更新时间: 2025-11-02 15:31
- 更新类型: patch
- 更新说明: 🚀 优化缓存机制和AI总结逻辑，移除字幕列表渲染

  **缓存优化：**
  - ✅ 添加字幕缓存检查，已有缓存时跳过按钮触发和拦截操作
  - ✅ 添加AI总结缓存检查，自动总结时直接使用缓存，避免重复请求
  - ✅ 字幕和AI总结均支持短时间内缓存，提升响应速度

  **AI总结重构：**
  - 🔄 将段落总结和广告分析合并为一次请求（减少API调用）
  - 📝 添加详细日志：总结、段落总结、广告分析三个部分的处理过程
  - 📋 清晰说明返回格式，确保正确提取广告信息
  - 🎯 第一部分：视频总结（Markdown格式）单独获取
  - 🎯 第二部分：段落总结 + 广告分析合并获取

  **UI优化：**
  - 🗑️ 移除前端字幕列表渲染和"字幕列表"标签页
  - 🎨 界面更简洁，专注于AI总结显示
  - 🔍 保留搜索功能（用于搜索AI总结内容）

  **预期效果：**
  - 相同视频的字幕和AI总结不会重复请求
  - AI总结请求从3次减少到2次（总结 + 段落+广告合并）
  - 界面更简洁，加载更快
  - 日志更详细，便于调试和排查问题

---

## v1.2.26 (2025-10-27 01:39)
- 更新时间: 2025-10-27 01:39
- 更新类型: patch
- 更新说明: 🔧 修复多次初始化和状态管理问题（重大修复）
  
  **核心修复：**
  - ✅ 添加iframe检测，防止脚本在iframe中重复初始化（解决多次初始化根本原因）
  - ✅ 修复小球状态混乱问题，统一使用BALL_STATUS常量
  - ✅ 添加ERROR状态3秒自动恢复机制，防止小球一直显示红色
  - ✅ 添加拦截器重复设置保护，避免性能开销
  - ✅ 添加并发初始化保护，防止同时多次初始化
  
  **架构优化：**
  - 🎯 重构为分层初始化架构：
    - Layer 0: iframe检测（最优先）
    - Layer 1: 通用服务（速度控制、笔记、截图）- 所有网站可用
    - Layer 2: 平台专属服务（字幕、AI、Notion）- 仅B站/YouTube
  - 📋 拆分菜单注册：registerUniversalMenuCommands + registerPlatformMenuCommands
  - ⌨️ 优化快捷键注册：registerUniversalShortcuts
  - 🏗️ 新增辅助方法：initPlatformServices、createAdSkipConfig
  
  **代码清理：**
  - 🗑️ 删除未使用文件：SubtitleServiceV2.js、main-refactored.js
  - 🔍 添加EventBus监听器泄漏检测（超过10个监听器时警告）
  - 📝 添加环境检查日志，便于调试
  
  **预期效果：**
  - 控制台只显示1次"初始化脚本实例"
  - 无"未知平台"警告
  - 字幕失败后3秒内小球自动恢复
  - 任意网站都能使用速度控制、笔记、截图功能
  - 页面加载更流畅，无卡顿

---

## v1.2.25 (2025-10-27 00:58)
- 更新时间: 2025-10-27 00:58
- 更新类型: patch
- 更新说明: 修复"我的笔记"显示AI总结的问题
  - 删除AI总结自动添加到笔记的逻辑
  - "我的笔记"现在只显示用户主动选中并点击钢笔添加的内容
  - AI总结仍然会显示在字幕面板和发送到Notion，但不会出现在笔记列表中

---

## v1.2.24 (2025-10-27 00:52)
- 更新时间: 2025-10-27 00:52
- 更新类型: patch
- 更新说明: 新增笔记自动同步到Notion功能
  - 添加独立的笔记数据库，与视频总结/字幕数据库分离
  - 在Notion配置中新增"自动同步笔记"选项
  - 开启后，选中文字点击钢笔保存的笔记会自动同步到Notion
  - 笔记数据库包含：内容、来源、网址、类型、视频标题、BV号、时间戳等字段
  - 支持文字笔记、截图笔记、AI总结等多种笔记类型
  - 首次使用时会自动在Notion中创建"📝 笔记收藏"数据库

---

## v1.2.23 (2025-10-27 00:41)
- 更新时间: 2025-10-27 00:41
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.2.22 (2025-10-26 22:00)
- 更新时间: 2025-10-26 22:00
- 更新类型: patch
- 更新说明: 彻底修复DOM事件重复触发导致的多次初始化
  - 修复DOMContentLoaded事件多次触发的问题
  - 使用once选项确保事件监听器只触发一次
  - 添加initStarted标志作为额外保护
  - 修复了"DOM加载完成，开始初始化"多次显示的问题
  - 确保每个页面只有一次初始化流程

---

## v1.2.21 (2025-10-26 21:56)
- 更新时间: 2025-10-26 21:56
- 更新类型: patch
- 更新说明: 加强服务单例模式防止重复初始化
  - NotesService、SpeedControlService、PlatformService改为单例模式
  - 各服务添加initialized标记，防止重复init
  - 改进立即执行函数(IIFE)包装，使用更唯一的标记名称
  - 添加实例计数器用于调试重复初始化问题
  - TaskManager的防重复机制已生效，成功阻止重复任务创建

---

## v1.2.20 (2025-10-26 21:48)
- 更新时间: 2025-10-26 21:48
- 更新类型: patch
- 更新说明: 修复脚本重复初始化问题
  - 修复脚本被重复执行导致双重AI总结任务的问题
  - 添加全局防重复执行标记（使用unsafeWindow确保跨环境共享）
  - TaskManager添加防重复任务创建机制，防止同一视频创建多个相同类型的任务
  - 应用init方法添加双重检查，防止重复初始化

---

## v1.2.19 (2025-10-26 21:29)
- 更新时间: 2025-10-26 21:29
- 更新类型: patch
- 更新说明: 核心服务架构优化和字幕处理改进
  - 重构字幕服务的网络请求捕获和初始化逻辑，提升稳定性
  - 优化TaskManager的视频键处理，正确识别多P视频
  - 改进Notion服务的页面管理和内容发送逻辑
  - 增强AI服务的错误处理和任务管理机制
  - 统一视频键生成规则，确保缓存和任务管理一致性
  - 修复视频信息获取的兼容性问题
  - 优化工具函数和验证器，提高代码健壮性

---

## v1.2.18 (2025-10-26 21:17)
- 更新时间: 2025-10-26 21:17
- 更新类型: patch
- 更新说明: 修复粉色小球状态显示错误问题
  - 新增AI_SUMMARIZING状态常量，正确反映AI总结进行中状态
  - 统一使用state.setBallStatus()管理小球状态变化
  - 修复AI总结时小球应显示粉色呼吸效果而非红色错误的问题
  - 确保字幕获取后显示粉色呼吸，AI总结时保持粉色呼吸，完成后恢复粉色

---

## v1.2.17 (2025-10-26 21:01)
- 更新时间: 2025-10-26 21:01
- 更新类型: patch
- 更新说明: 修复字幕拦截成功但UI状态反馈错误的问题
  - 修复了字幕成功捕获后小球显示错误的问题
  - 添加缺失的SUBTITLE_LOADED事件触发
  - 确保字幕面板正确显示捕获的字幕内容

---

## v1.2.15 (2025-10-26 20:31)
- 更新时间: 2025-10-26 20:31
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.2.14 (2025-10-26 20:20)
- 更新时间: 2025-10-26 20:20
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.2.13 (2025-10-26 20:13)
- 更新时间: 2025-10-26 20:13
- 更新类型: patch
- 更新说明: **重写Markdown到Notion blocks转换，完整支持所有Markdown格式**

### 🎯 核心改进
- **完整的Markdown格式支持**：
  - 正确识别所有级别标题（# 到 ######），转换为对应的heading块
  - 支持无序列表（-, *, +）、有序列表、任务列表
  - 支持引用块（>）、代码块（```）、分隔线（---, ***, ___）
  - 支持行内格式：粗体、斜体、删除线、行内代码、链接

### 🔧 技术优化  
- **智能段落合并**：连续的普通文本行合并为一个段落
- **代码块语言识别**：自动识别代码语言并标准化
- **rich_text解析增强**：支持嵌套格式（如粗体+斜体）
- **分批发送机制**：自动处理超过100个blocks的情况

### 🐛 问题修复
- 修复低级别标题（####）不能正确渲染的问题
- 修复最后一段内容可能丢失的问题
- 确保所有Markdown元素都能正确转换为Notion格式

---

## v1.2.12 (2025-10-26 20:00)
- 更新时间: 2025-10-26 20:00
- 更新类型: patch
- 更新说明: **调整AI总结提示词要求**

### ✨ 功能调整
- **Markdown总结提示词优化**：
  - TL;DR限制为不超过50字的核心摘要
  - 添加时间戳要求，表示哪部分讲什么内容
  - 移除扩展阅读要求，聚焦视频内容本身
  - 更适合生成结构化的视频内容总结

---

## v1.2.11 (2025-10-26 19:53)
- 更新时间: 2025-10-26 19:53
- 更新类型: patch
- 更新说明: **完善字幕发送配置控制**

### 🔧 优化改进
1. **字幕发送配置化**
   - 第一次发送时根据用户配置（contentOptions.subtitles）决定是否发送字幕
   - 避免用户未勾选字幕选项时仍然发送字幕数据
   - 配置控制更加精确，完全尊重用户选择

---

## v1.2.10 (2025-10-26 19:51)
- 更新时间: 2025-10-26 19:51
- 更新类型: patch
- 更新说明: **优化Notion字幕处理逻辑，避免重复处理**

### 🔧 优化改进
1. **AI总结发送优化**
   - AI总结完成时不再重复发送字幕数据
   - 字幕只在第一次加载完成时发送，避免无用功
   
2. **页面更新逻辑改进**
   - 更新页面时保留现有的字幕内容块
   - 只更新AI总结和时间戳段落部分
   - 确保内容顺序正确：时间戳段落 → AI总结 → 字幕内容

---

## v1.2.9 (2025-10-26 19:45)
- 更新时间: 2025-10-26 19:45
- 更新类型: patch
- 更新说明: **多P视频自动处理优化**

### 🐛 问题修复
1. **多P视频切换处理**
   - 修复切换分P时AI总结被跳过的问题
   - TaskManager现在使用包含分P信息的完整视频键（如BV123-cid-p2）
   - 不同分P现在被正确识别为独立视频
   - 每个分P可以独立进行自动总结和Notion记录
   
### 🔧 优化改进
1. **任务管理器升级**
   - 优化已处理视频的记录逻辑，确保分P信息被正确保存
   - 视频缓存键现在包含完整的分P信息
   - 支持同一视频不同分P的独立任务管理

---

## v1.2.8 (2025-10-26 19:37)
- 更新时间: 2025-10-26 19:37
- 更新类型: patch
- 更新说明: **修复字幕服务重复请求问题**

### 🔧 性能优化
1. **字幕拦截器优化**
   - 改进拦截器逻辑，直接捕获并使用响应数据而不是重新发送请求
   - 避免网络请求失败的错误："Error: 网络请求失败"
   - 显著提升字幕获取的稳定性和加载速度
   - 减少不必要的网络请求，节省带宽资源

---

## v1.2.7 (2025-10-26 19:33)
- 更新时间: 2025-10-26 19:33
- 更新类型: patch
- 更新说明: **修复Notion笔记中字幕内容重复显示的问题**

### 🐛 Bug修复
1. **字幕重复问题修复**
   - 修复了每次调用sendToNotion都会创建新的字幕子页面并追加字幕引用的问题
   - 优化字幕子页面创建逻辑，只在首次创建主页面时创建字幕子页面
   - 避免AI总结完成后重复创建字幕内容，保持页面结构整洁

---

## v1.2.6 (2025-10-26 19:30)
- 更新时间: 2025-10-26 19:30
- 更新类型: patch
- 更新说明: **修复多P视频切换时字幕和AI总结不重新获取的问题**

### 🐛 Bug修复
1. **分P切换检测改进**
   - main.js: 添加分P参数(p)的变化检测，确保切换分P时触发视频切换事件
   - 监听VIDEO_CHANGED事件，切换分P时自动重新获取字幕
   - 清空旧的字幕和AI总结内容，避免混乱

2. **UniversalAdSkipService同步**
   - 现在UniversalAdSkipService和其他服务在分P切换时能保持同步
   - 确保所有服务都能正确响应视频切换（包括分P切换）

### 技术细节
- handleUrlChange现在检测: BV号变化、CID变化、分P(p参数)变化
- VIDEO_CHANGED事件包含分P信息: {bvid, cid, p, oldP}
- 分P切换后延迟2秒重新获取字幕，确保页面加载完成

---

## v1.2.5 (2025-10-26 19:30)
- 更新时间: 2025-10-26 19:30
- 更新类型: patch
- 更新说明: **优化AI总结默认提示词**

### ✨ 功能改进
- 修改Markdown总结提示词，移除TL;DR字数限制
- 删除时间戳相关要求，让总结更专注于内容
- 新增扩展阅读要求，要求AI在总结末尾提供专业名词概念解释

---

## v1.2.4 (2025-10-26 19:10)
- 更新时间: 2025-10-26 19:10
- 更新类型: patch
- 更新说明: **修复多P视频切换和Notion字幕重复问题**

### 🐛 Bug修复
- **多P视频切换识别**：
  - 修改BilibiliAdapter的getVideoId方法，返回包含分P信息的ID（如`BV123_p6`）
  - 确保UniversalAdSkipService正确识别分P切换为新视频
  - 切换分P时正常触发字幕获取和AI总结

- **Notion字幕优化**：
  - 删除主页面中的字幕内容代码块
  - 字幕内容仅保存在子页面中
  - 主页面只显示"📝 字幕内容"标题和子页面链接
  - 移除未使用的`_buildPageContent`方法

---

## v1.2.3 (2025-10-26 19:05)
- 更新时间: 2025-10-26 19:05
- 更新类型: patch
- 更新说明: **简化油猴菜单，删除速度控制选项**

### 🎯 菜单精简
- **删除速度控制项**：移除速度+0.1、速度-0.1、重置速度菜单项
- **保留核心功能**：
  - 📝 笔记管理（全局可用）
  - 📸 截图（有视频时显示）
  - ⌨️ 快捷键设置（全局可用）

### 🔧 使用建议
- 速度控制功能仍可通过快捷键使用
- 快捷键可在"⌨️ 快捷键设置"中自定义

---

## v1.2.2 (2025-10-26 19:01)
- 更新时间: 2025-10-26 19:01
- 更新类型: patch
- 更新说明: **移除所有网站的浮动UI，统一通过油猴菜单访问**

### 🎯 UI简化
- **移除浮动按钮**：不再在网页右下角显示控制按钮
- **移除快捷菜单**：不再显示弹出式快捷菜单

### 📊 油猴菜单增强
- **笔记管理**：📝 随时打开笔记面板
- **速度控制**（有视频时显示）：
  - ⏩ 速度 +0.1：增加播放速度
  - ⏪ 速度 -0.1：减少播放速度
  - ⏯ 重置速度：恢复正常速度
- **截图功能**：📸 视频截图并保存到笔记（有视频时显示）
- **快捷键设置**：⌨️ 自定义所有快捷键

### 🔧 用户体验
- 更清爽的浏览体验，不干扰网页内容
- 所有功能统一通过油猴菜单访问
- B站和YouTube保留完整的专属UI

---

## v1.2.1 (2025-10-26 18:59)
- 更新时间: 2025-10-26 18:59
- 更新类型: patch
- 更新说明: **支持B站多P（合集）视频的完整处理**

### 🎯 新增功能
- **多P视频识别**：正确识别和处理B站合集视频的每个分P
  - 自动获取URL中的p参数（如 `?p=6` 表示第6集）
  - 不同分P被当作独立视频处理
  - 每个分P独立获取对应的字幕内容

### 📊 Notion集成改进
- **分P信息记录**：
  - 标题自动添加分P信息（如 "视频标题 - P6"）
  - BV号字段包含分P标识（如 "BV1Q7WczAEtd P6"）
  - 支持独立的分P字段（数字或文本类型）
  - 自动创建缺失的属性字段

### 🔧 技术改进
- **缓存键优化**：缓存键包含分P信息，避免不同分P内容混淆
- **状态管理增强**：StateManager支持分P切换检测
- **视频信息完善**：getVideoInfo返回包含p字段的完整信息

---

## v1.2.0 (2025-10-26)
- 更新时间: 2025-10-26 01:28
- 更新类型: **major** 🚀
- 更新说明: **跨平台架构升级 - YouTube全面支持**

### 🎯 核心架构升级
- **平台适配器模式**：全新的跨平台架构设计
  - `VideoPlayerAdapter`：统一视频播放器接口
  - `BilibiliAdapter`：B站专用适配器
  - `YouTubeAdapter`：YouTube专用适配器
  - `PlatformService`：智能平台检测与管理

### 🌐 YouTube平台支持
- **YouTube字幕服务** (`YouTubeSubtitleService`)
  - 自动提取YouTube字幕
  - 支持多语言字幕选择
  - 智能字幕同步
- **YouTube视频标签** (`YouTubeVideoTagger`)
  - 视频列表页显示广告标签
  - 支持所有YouTube页面类型
  - 彩色标签区分不同广告类型
- **DeArrow API集成**
  - 去除标题党和缩略图诱饵
  - 社区驱动的内容改进

### 🛡️ 通用广告跳过
- **UniversalAdSkipService**：跨平台广告跳过服务
  - 支持B站和YouTube
  - SponsorBlock深度集成
  - 智能广告检测与跳过
  - 进度条广告段标记
  - 多种广告类型识别

### ⚡ 性能与稳定性
- **TaskManager任务管理器**
  - 任务上下文隔离
  - 视频切换时自动取消旧任务
  - 防止数据混乱和重复处理
- **LogDecorator日志装饰器**
  - 统一的日志格式
  - 性能监控集成
  - 调试信息增强
- **请求工厂优化** (`RequestFactory`)
  - 统一的API请求配置
  - 重试机制改进
  - 速率限制保护

### 🔧 其他改进
- 全站支持：所有网站可用基础功能
- 改进的错误处理和用户提示
- 更完善的平台检测逻辑
- 优化的资源加载策略

---

## v1.1.34 (2025-10-26 01:23)
- 更新时间: 2025-10-26 01:23
- 更新类型: patch
- 更新说明: 🌍 全站支持
  - 扩展脚本匹配范围到所有网站（*://*/*）
  - 通用功能现在在任何网站都可用：
    - 📸 视频截图功能
    - 🎬 播放速度控制
    - 📝 选中文字保存笔记
    - ⚙️ 快捷键设置
  - 非B站/YouTube网站显示浮动控制按钮
  - B站和YouTube保留完整功能，其他网站使用基础功能

---

## v1.1.33 (2025-10-26 01:15)
- 更新时间: 2025-10-26 01:15
- 更新类型: patch
- 更新说明: 🐛 **修复粉色小球呼吸效果问题**
  - 问题：AI总结开始时小球就停止呼吸效果，应该在总结结束后才停止
  - 原因：TaskManager执行任务时没有触发 AI_SUMMARY_START 事件
  - 修复：在创建AI总结任务后立即触发该事件，确保小球呼吸效果正常显示

---

## v1.1.32 (2025-10-26 01:09)
- 更新时间: 2025-10-26 01:09
- 更新类型: patch
- 更新说明: 🎨 **优化 Notion 页面结构**
  - 🗑️ **移除视频信息部分**：页面更简洁，直接展示核心内容
  - 🔄 **调整内容顺序**：时间戳段落移到视频总结前面，符合逻辑顺序
  - 🐛 **修复字幕重复标题**：移除子页面中多余的 heading_1 标题块
  - 📐 **改进分隔线逻辑**：只在有前置内容时添加分隔线，避免页面顶部出现分隔线

---

## v1.1.31 (2025-10-26 00:54)
- 更新时间: 2025-10-26 00:54
- 更新类型: patch
- 更新说明: 🎯 **统一自动和手动发送功能**
  - ✨ **内容完全一致**：自动和手动发送现在使用相同的内容，只是触发时机不同
  - 🔄 **统一发送方法**：创建 sendToNotion 核心方法，所有发送路径都调用它
  - 📋 **遵循用户配置**：根据内容选项（视频信息、视频总结、时间戳段落、字幕内容）发送勾选的内容
  - 📝 **字幕子页面优化**：字幕作为子页面存储，主页面显示美化的块引用链接
  - 🗑️ **移除冗余代码**：删除旧的 sendSubtitle 方法，避免混淆
  - 🔧 **修复自动发送逻辑**：
    - AI总结完成后自动发送所有配置内容
    - 没有AI总结时，字幕加载完成后也能自动发送
  - 💅 **改进块引用样式**：子页面链接使用蓝色粗体，更清晰地标识为引用

---

## v1.1.30 (2025-10-26 00:37)
- 更新时间: 2025-10-26 00:37
- 更新类型: patch
- 更新说明: 🚀 **重构 Notion 集成功能**
  - ✨ **修复 AI 总结自动发送**：移除 pageId 检查，允许创建新页面并发送
  - ✨ **手动发送包含完整内容**：点击 Notion 按钮现在会发送 AI 总结和字幕
  - 📝 **字幕改为子页面**：字幕不再分块写入主页面，而是创建独立的子页面
  - 🔗 **主页面添加子页面链接**：在主页面中添加指向字幕子页面的链接
  - 🎯 **新增 sendComplete 方法**：统一处理手动发送的完整内容
  - 📦 **优化存储结构**：主页面包含视频信息、AI总结和时间戳段落，字幕独立存储

---

## v1.1.29 (2025-10-26 00:24)
- 更新时间: 2025-10-26 00:24
- 更新类型: patch
- 更新说明: 🔧 **修复 AI 段落总结 JSON 解析错误**
  - 🐛 修复 AI 返回的 JSON 格式错误（数组元素之间缺少逗号）
  - ✨ 添加自动修复机制，在 }{ 之间自动插入逗号
  - 📝 改进 JSON 提示词，明确要求元素之间用逗号分隔
  - 🔄 统一 ConfigManager 和 AIService 中的提示词格式
  - 💡 增加格式示例，引导 AI 返回正确的 JSON 格式

---

## v1.1.28 (2025-10-26 00:23)
- 更新时间: 2025-10-26 00:23
- 更新类型: patch
- 更新说明: 🐛 **修复通用广告跳过服务初始化错误**
  - 🔧 修复 "e.get is not a function" 错误
  - ✅ 为Bilibili平台添加配置包装器，提供get/set方法
  - ✅ 统一YouTube和Bilibili的配置接口，使用localStorage存储
  - 📦 确保UniversalAdSkipService在两个平台都能正常初始化

---

## v1.1.27 (2025-10-26 00:15)
- 更新时间: 2025-10-26 00:15
- 更新类型: patch
- 更新说明: 🎬 **修复 YouTube 播放页面 UI 显示问题**
  - 🔴 修复粉色小球在YouTube播放器上不显示（调整定位从right: -30px改为right: 10px）
  - 📺 修复字幕面板在YouTube侧边栏不显示（重置position和left/top样式）
  - 🎯 为YouTube播放器内的小球添加特定样式和z-index确保显示
  - 🖱️ 添加小球点击事件处理，支持切换字幕面板和手动获取字幕
  - 🎛️ 修复小球状态更新冲突，移除onclick覆盖，统一使用addEventListener
  - 📱 支持YouTube全屏时自动调整小球位置避开控制栏

---

## v1.1.26 (2025-10-26 00:11)
- 更新时间: 2025-10-26 00:11
- 更新类型: patch
- 更新说明: 🚀 **大幅改进 SponsorBlock API 可靠性和性能**
  - 🔄 实现完整的重试机制，支持指数退避和智能延迟
  - ⚡ 添加请求队列管理和并发控制，防止流量速率限制
  - 🎯 针对429（请求频繁）错误特殊处理，允许更多重试次数
  - ⏱️ 增加超时时间到15秒，适应网络波动
  - 🔀 添加随机抖动避免大量请求同时重试
  - 📊 详细的调试日志，方便排查网络问题

---

## v1.1.25 (2025-10-26 00:04)
- 更新时间: 2025-10-26 00:04
- 更新类型: patch
- 更新说明: 🐛 **修复 AI 服务调用错误**
  - 🔧 修复 AIService 调用不存在的 `_withErrorHandling` 方法导致的错误
  - ✅ 删除多余的错误处理包装，代码本身已有 try-catch 处理
  - ✅ 修复了影响 Bilibili 和其他网站的 AI 总结功能

---

## v1.1.24 (2025-10-26 00:02)
- 更新时间: 2025-10-26 00:02
- 更新类型: patch
- 更新说明: 🐛 **修复 YouTube 字幕服务启动错误**
  - 🔧 修复 MutationObserver 在 document.body 不存在时导致的 TypeError
  - ✅ 添加 DOM 加载状态检查，确保页面元素就绪后再设置观察器
  - ✅ 增加错误处理，防止观察器设置失败影响其他功能

---

## v1.1.23 (2025-10-25 23:50)
- 更新时间: 2025-10-25 23:50
- 更新类型: patch
- 更新说明: 🎯 **优化YouTube页面检测和UI布局**
  - ✨ 字幕拦截仅在YouTube播放页面(/watch)生效
  - ✨ UI元素仅在视频播放页面创建，避免在其他页面显示
  - 🔧 智能页面检测，监听YouTube的SPA导航变化
  - 🔧 离开播放页面时自动清理已捕获的数据
  - 📍 YouTube上字幕面板显示在侧边栏，与B站布局保持一致
  - 📍 优先在相关视频上方显示，保持良好的视觉层级

---

## v1.1.22 (2025-10-25 23:38)
- 更新时间: 2025-10-25 23:38
- 更新类型: patch
- 更新说明: 🎉 **重大更新：全面支持YouTube平台**
  - ✨ 新增YouTube字幕提取功能（支持JSON3格式）
  - ✨ 新增跨平台服务架构（PlatformService）
  - ✨ YouTube字幕自动拦截和解析
  - ✨ AI总结支持YouTube视频
  - ✨ Notion集成支持YouTube内容
  - ✨ 段落总结和时间戳跳转功能
  - 🔧 优化字幕解析算法，智能过滤音效标记
  - 🔧 改进请求拦截机制，直接捕获响应数据
  - 📝 更新脚本名称为"Bilibili & YouTube Tools"

---

## v1.1.21 (2025-10-25 23:20)
- 更新时间: 2025-10-25 23:20
- 更新类型: patch
- 更新说明: 🔐 **修复YouTube Trusted Types安全策略错误**
  - 移除innerHTML的使用，改用DOM操作方法
  - 新增createTagContent方法，使用createElement构建标签内容
  - 解决"Failed to set innerHTML: requires TrustedHTML"错误
  - 保持原有的视觉效果和功能不变
  - 兼容YouTube的内容安全策略（CSP）

---

## v1.1.20 (2025-10-25 23:10)
- 更新时间: 2025-10-25 23:10
- 更新类型: patch
- 更新说明: 🏷️ **支持YouTube新版布局的广告标签显示**
  - 添加对yt-thumbnail-view-model新元素的支持
  - 支持yt-lockup-view-model新布局结构
  - 更新时长获取逻辑，支持新的.yt-badge-shape__text元素
  - 改进缩略图容器查找，兼容新旧两种布局
  - 确保广告标签在新版YouTube界面正确显示在左上角

---

## v1.1.19 (2025-10-25 23:03)
- 更新时间: 2025-10-25 23:03
- 更新类型: patch
- 更新说明: 🎯 **修复YouTube进度条广告标记无法显示问题**
  - 重写addProgressMarkers方法，正确处理YouTube进度条结构
  - 提高z-index至40，避免被YouTube元素覆盖
  - 优化标记插入位置，确保在正确的DOM层级
  - 添加视频时长有效性检查，避免无效渲染
  - 为不同广告类型使用专属颜色（sponsor绿色、intro青色等）
  - 改进鼠标悬停效果和交互体验
  - 添加中文类别名称显示
  - 修复标记容器定位问题

---

## v1.1.18 (2025-10-25 22:53)
- 更新时间: 2025-10-25 22:53
- 更新类型: patch
- 更新说明: 🔧 **修复UniversalAdSkipService频繁调用和缓存问题**
  - 添加完整的缓存机制（30分钟有效期）
  - 优化原生广告检测，添加防抖和频率限制（5秒间隔）
  - 避免重复日志输出，只在有实际变化时记录
  - 优化URL变化处理，同一视频不重新初始化
  - 添加自动缓存清理（每10分钟）
  - 修复进度条标记重复渲染问题
  - 使用WeakSet避免内存泄漏

---

## v1.1.17 (2025-10-25 22:51)
- 更新时间: 2025-10-25 22:51
- 更新类型: patch
- 更新说明: 🎨 **YouTube标签B站风格美化**
  - 采用B站风格的渐变背景和圆角设计
  - 为每种广告类型添加对应的emoji图标（💰赞助、📢推广、🎬片头等）
  - 优化标签排版，emoji和文字完美对齐
  - 添加炫酷的动画效果（滑入缩放、悬停高亮）
  - 支持多类别标签显示（显示+N标记）
  - 添加shimmer光泽动效，更具视觉吸引力
  - 使用更精致的阴影和模糊效果
  - 字体优化支持中文（PingFang SC、Microsoft YaHei）

---

## v1.1.16 (2025-10-25 22:40)
- 更新时间: 2025-10-25 22:44
- 更新类型: patch
- 更新说明: ⚡ **优化YouTube视频标签性能与检测**
  - 改用WeakSet追踪处理过的元素，避免内存泄漏
  - 实现真正的异步并发处理（最多3个同时请求）
  - 添加智能速率限制（100ms请求间隔）
  - 增强DOM变化检测（监听属性变化、YouTube特定事件）
  - 缓存添加TTL机制（30分钟过期）
  - 自动清理过期缓存（每5分钟）
  - 改进防抖处理（200ms延迟合并）
  - 添加定期扫描作为备用方案（10秒间隔）

---

## v1.1.16 (2025-10-25 22:40)
- 更新时间: 2025-10-25 22:40
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.1.15 (2025-10-25 22:22)
- 更新时间: 2025-10-25 22:22
- 更新类型: patch
- 更新说明: 🏷️ **YouTube视频广告标签功能**
  - 新增YouTubeVideoTagger服务，自动检测并标记含广告的视频
  - 支持YouTube首页、频道页、搜索结果等所有视频列表
  - 通过SponsorBlock API获取社区提交的广告段落信息
  - 在视频缩略图左上角显示彩色标签（赞助、推广、片头等）
  - 智能缓存机制，避免重复请求
  - 支持YouTube SPA导航，动态加载的视频也能被标记

---

## v1.1.14 (2025-10-25 22:04)
- 更新时间: 2025-10-25 22:04
- 更新类型: patch
- 更新说明: 🔧 **修复SponsorBlock API使用问题**
  - 修正categories参数格式错误（从嵌套数组改为多个category参数）
  - DeArrowAPI现在正确传递多个category参数
  - UniversalAdSkipService添加categories参数支持
  - RequestFactory更新支持自定义广告类别
  - 确保能获取所有类型的广告段落（sponsor、intro、outro等）

---

## v1.1.13 (2025-10-25 21:48)
- 更新时间: 2025-10-25 21:48
- 更新类型: patch
- 更新说明: 🌐 **增强多平台视频信息识别**
  - 新增YouTube视频信息识别（视频ID、标题、创作者）
  - 支持通用视频网站的基础信息获取（通过meta标签）
  - getVideoInfo增加platform字段，标识当前平台
  - 新增通用视频辅助函数（getVideoElement、hasVideo、getVideoDuration等）
  - 为跨平台功能扩展奠定基础

---

## v1.1.12 (2025-10-25 21:29)
- 更新时间: 2025-10-25 21:29
- 更新类型: patch
- 更新说明: [待填写更新说明]

---

## v1.1.11 (2025-10-25 21:13)
- 更新时间: 2025-10-25 21:13
- 更新类型: patch
- 更新说明: 🚫 **YouTube广告识别和跳过功能**
  - 新增通用广告跳过服务，支持YouTube和Bilibili双平台
  - 集成DeArrow API，获取社区提交的广告段落
  - 自动检测YouTube进度条原生广告标记（黄色标记）
  - 可配置自动跳过、静音、延迟跳过等多种模式
  - 支持多种广告类别：赞助商、自我推广、互动提醒、开场、片尾等
  - 采用平台适配器模式，解耦不同平台的实现细节
  - 进度条显示广告段落标记，点击可快速跳过
  - 油猴菜单新增YouTube广告设置选项

---

## v1.1.10 (2025-10-25 20:52)
- 更新时间: 2025-10-25 20:52
- 更新类型: patch
- 更新说明: 🔒 **视频切换数据隔离和任务管理**
  - 修复视频切换时AI总结/字幕错误绑定的严重bug
  - 新增TaskManager任务管理器，确保数据正确绑定到对应视频
  - 视频切换时自动取消旧视频的运行中任务
  - AI总结完成后后台发送到Notion，使用固定的视频信息
  - 添加已处理视频记录，避免重复自动处理（30天过期）
  - 手动触发会清除处理记录，允许重新处理

---

## v1.1.9 (2025-10-25 20:45)
- 更新时间: 2025-10-25 20:45
- 更新类型: patch
- 更新说明: 🐛 **修复Notion API 100个块限制问题**
  - 修复发送字幕时超过100个块导致API验证失败的问题
  - 实现智能分批发送功能，每批最多95个块
  - 字幕数量上限从100条提升到500条
  - 优化`appendToPage`方法，支持自动分批处理
  - 添加批次发送进度日志，便于调试

---

## v1.1.8 (2025-10-25 20:34)
- 更新时间: 2025-10-25 20:34
- 更新类型: patch
- 更新说明: 优化日志系统，在调试模式下输出详细日志，普通模式只显示错误信息。新增日志装饰器工具，支持模块化日志管理

---

## v1.1.7 (2025-10-25 20:05)
- 更新时间: 2025-10-25 20:05
- 更新类型: patch
- 更新说明: 🔧 **修复超时错误**
  - 增加 SponsorBlock 和 VideoQuality API 请求超时时间从 5秒 到 10秒
  - 增强 SponsorBlock 错误处理，防止未捕获的 Promise rejection
  - SponsorBlock 初始化失败不再影响主流程
  - 减少控制台 Timeout 错误输出

---

## v1.1.6 (2025-10-25 19:57)
- 更新时间: 2025-10-25 19:57
- 更新类型: patch
- 更新说明: 修复段落点击跳转时的 notification.show 错误，改为使用 notification.info 方法

---

## v1.1.5 (2025-10-25 19:43)
- 更新时间: 2025-10-25 19:43
- 更新类型: patch
- 更新说明: 🎯 **AI总结优化**
  - 更明确prompt1不包含时间戳，专注内容总结
  - prompt2专门用于生成带时间戳的段落总结
  - 两个AI请求保持并行异步发送，提高效率
  - 只有两个AI总结都成功才创建Notion笔记，确保数据完整性

---

## v1.1.4 (2025-10-25 19:43)
- 更新时间: 2025-10-25 19:43
- 更新类型: patch
- 更新说明: 🎨 **交互体验优化**
  - AI总结生成中时点击AI按钮会提示"正在生成中"，避免重复请求
  - 已有AI总结时点击AI按钮会弹窗确认是否重新生成
  - 选择"取消"会切换到总结标签页查看现有总结
  - 选择"确定"会清除缓存并重新生成总结
  - AI总结生成中时点击Notion按钮会提示"请稍后"，避免发送不完整数据

---

## v1.1.3 (2025-10-25 19:39)
- 更新时间: 2025-10-25 19:39
- 更新类型: patch
- 更新说明: 🐛 **修复Notion API blocks数量超限问题**
  - 将Markdown内容合并为更少的blocks（每块最多10行或1500字符）
  - 限制时间戳段落最多显示20个，避免blocks过多
  - 添加总blocks数量限制，超过100个时自动截断并添加提示
  - 解决"body.children.length should be ≤ 100"错误

---

## v1.1.2 (2025-10-25 19:26)
- 更新时间: 2025-10-25 19:26
- 更新类型: patch
- 更新说明: 🐛 **Bug修复**
  - 修复NotionService缺少formatTime函数导入的问题
  - 修复发送字幕到Notion时的"formatTime is not defined"报错
  - 确保AI请求超时处理正常工作

---

## v1.1.1 (2025-10-25 19:14)
- 更新时间: 2025-10-25 19:14
- 更新类型: patch
- 更新说明: ✨ **新增AI广告检测功能**
  - 对超过5分钟的视频自动进行广告检测
  - 使用第三个异步AI请求，与总结和段落并行处理
  - 检测到的广告自动添加到进度条标记
  - 支持自动跳过检测到的广告段落
- 🎯 **性能优化**
  - 三个AI请求完全异步并行执行，节省处理时间
  - 只对长视频（>5分钟）启用广告检测，避免不必要的API调用
- 🔧 **技术改进**
  - 重构_makeAIRequest方法支持多种响应类型
  - 添加广告段落与SponsorBlock系统的集成
  - 广告段落使用sponsor类别，优先级设为100

---

## v1.1.6 (2025-10-25)
- 更新时间: 2025-10-25
- 更新类型: minor
- 更新说明: Notion集成功能重大改进和修复

### 🎯 主要功能改进
  - **Notion内容结构重构**：改进页面组织结构，所有内容直接添加到主页面
  - **AI总结自动发送**：AI总结完成后自动发送到Notion
  - **内容选项配置**：支持独立选择发送视频信息、AI总结、时间戳段落、字幕内容

### 🐛 修复的问题
  - **完全修复Notion API错误**：
    - 修复rich_text格式问题，为所有元素添加必需的`type: 'text'`属性
    - 移除无效的child_page块类型
    - 增强block结构验证，确保所有类型属性正确
    - 改进数据类型验证，确保文本内容为有效字符串
  
### 📝 优化改进
  - 限制字幕显示数量（最多100条）避免页面过长
  - 使用分隔线和标题更好地组织内容结构
  - 添加详细的错误日志，便于问题排查
  - 改进_parseRichText方法，支持粗体、代码等格式

### 📋 笔记功能增强
  - 支持AI总结笔记的保存和管理
  - 截图可按时间戳自动嵌入到对应段落
  - 改进笔记面板UI，更好地展示AI总结结构

---

## v1.0.15 (2025-10-25 01:48)
- 更新类型: patch
- 更新说明: 重构Notion笔记结构，使用子页面架构
  - **子页面架构**: AI总结和字幕不再直接添加到主笔记，改为创建子页面并引用
  - **新增方法**: _createChildPage创建子页面（父页面是普通页面，不是数据库）
  - **主笔记结构优化**: 视频信息 → 时间戳段落 → AI总结引用 → 字幕引用
  - **子页面创建**: 
    - AI总结子页面：包含完整的Markdown格式总结
    - 字幕内容子页面：包含所有字幕文本
  - **不填充总结字段**: _buildProperties方法新增summary参数，传入null时不填充"总结"字段
  - **减少blocks**: 主笔记只包含核心信息，详细内容在子页面中
  - **提升性能**: 减少主笔记blocks数量，截图查找速度更快
  - **清晰结构**: 主笔记简洁，子页面详细，信息组织更合理

---

## v1.0.15 (2025-10-25 01:44)
- 更新时间: 2025-10-25 01:44
- 更新类型: patch
- 更新说明: 修复全局错误处理器的类型安全问题
  - **修复TypeError**: 修复`t.includes is not a function`错误，使用`String()`安全转换message和source
  - **过滤第三方错误**: 添加nc-loader（阿里云验证码）和addIceCandidate错误过滤
  - **增强Promise错误处理**: 安全获取reason信息，避免类型错误
  - **更健壮的错误处理**: 所有字符串检查前先确保变量是字符串类型
  - **调试日志**: 为被过滤的错误添加调试日志，便于排查问题

---

## v1.0.14 (2025-10-25 01:42)
- 更新时间: 2025-10-25 01:42
- 更新类型: patch
- 更新说明: 优化Markdown解析器，修复标题识别和减少blocks数量
  - **修复标题识别bug**: 使用正则`/^(#{1,3})\s+(.+)$/`匹配标题，正确识别`### **关键总结**`
  - **减少blocks数量**: 合并连续的普通段落为一个paragraph，显著减少blocks（提升截图查找速度）
  - **简化rich text解析**: 移除斜体支持，只保留粗体`**text**`和代码`` `code` ``格式
  - **换行支持增强**: 正确处理多行文本的换行，在paragraph内部保留换行
  - **性能优化**: flushParagraphs机制批量处理段落，减少API请求体积
  - **调试日志**: 显示"blocks（优化后）"，便于监控优化效果

---

## v1.0.13 (2025-10-25 01:38)
- 更新时间: 2025-10-25 01:38
- 更新类型: patch
- 更新说明: 优化AGENTS.md开发指南，突出版本管理流程
  - **核心原则重组**: 将版本管理提升到核心原则第2位，强调重要性
  - **版本管理详解**: 详细说明`npm run bump`命令的作用和后续步骤
  - **开发流程简化**: 精简为4步：修改代码 → 更新版本 → 填写说明 → 提交代码
  - **结构优化**: 使用表格展示核心功能模块，更直观清晰
  - **检查清单**: 添加AI助手修改前后的检查清单，确保流程规范
  - **精简内容**: 删除冗余示例代码，保留最实用的开发提示
  - **标题优化**: 改为"AI开发助手指南"，明确文档定位

---

## v1.0.12 (2025-10-25 01:35)
- 更新时间: 2025-10-25 01:35
- 更新类型: patch
- 更新说明: AI总结在Notion中以Markdown格式显示
  - **新增Markdown解析器**: _convertMarkdownToNotionBlocks方法，完整支持Markdown语法
  - **支持的格式**:
    - 标题: `#` (heading_1), `##` (heading_2), `###` (heading_3)
    - 列表: `-` 或 `*` (bulleted_list), `1.` (numbered_list)
    - 文本样式: `**粗体**`, `*斜体*`, `` `代码` ``
    - 其他: `---` (分隔线), `> 引用`, ` ```代码块``` `
  - **Rich Text解析**: _parseRichText方法支持行内格式（粗体、斜体、代码）
  - **视频总结优化**: AI总结现在完美保留Markdown格式，在Notion中呈现更美观
  - **调试日志**: 添加详细的转换日志，记录blocks生成过程

---

## v1.0.11 (2025-10-25 01:32)
- 更新时间: 2025-10-25 01:32
- 更新类型: patch
- 更新说明: 删除字幕面板左上角的AI助手图标
  - 移除了subtitle-header-left中的AI助手图标元素
  - 删除了.subtitle-status-icon相关的CSS样式
  - 删除了ICONS.AI_ASSISTANT图标定义
  - 界面更简洁清爽

---

## v1.0.10 (2025-10-25 01:29)
- 更新时间: 2025-10-25 01:29
- 更新类型: patch
- 更新说明: 重构Notion截图智能插入功能，优化段落结构
  - **NotionService.sendAISummary**: 使用toggle block创建段落，支持添加children
  - **ScreenshotService.insertScreenshotAtTimestamp**: 改进查找逻辑，根据时间戳精准定位toggle block
  - **智能匹配算法**: 找到最接近且不大于截图时间的段落进行插入
  - **详细调试日志**: 完整记录段落构建、时间戳解析、block查找和插入过程
  - **兼容性**: 同时支持toggle和bulleted_list_item两种格式
  - **结构优化**: 每个段落现在是独立的toggle block，可以折叠展开，截图作为children嵌入其中

---

## v1.0.9 (2025-10-25 01:25)
- 更新时间: 2025-10-25 01:25
- 更新类型: patch
- 更新说明: 修复AI总结完成后自动发送Notion功能
  - 修复了main.js中AI_SUMMARY_COMPLETE事件监听器调用错误的方法
  - 从调用sendSubtitle改为正确调用sendAISummary
  - 现在AI总结完成后会根据Notion内容选项正确发送AI总结内容到Notion
  - 添加了成功和失败的通知提示

---

## v1.0.8 (2025-10-22 21:18)
- 更新时间: 2025-10-22 21:18
- 更新类型: patch
- 更新说明: 修复Notion发送字幕时的TypeError错误
  - 修复了发送字幕到Notion时`substring is not a function`错误
  - 正确处理AI总结可能是对象（含markdown和segments）或字符串的情况
  - 兼容新旧版本的AI总结数据格式

---

## v1.0.7 (2025-10-22 18:04)
- 更新时间: 2025-10-22 18:04
- 更新类型: patch
- 更新说明: 减少NotesService中鼠标事件日志输出，避免控制台日志过多
  - 注释掉mouseup/mousedown基础事件日志和鼠标位置日志
  - 只保留重要的操作日志（如检测到文本选择、保存笔记等）

---

## v1.0.6 (2025-10-22 17:54)
- 更新时间: 2025-10-22 17:54
- 更新类型: patch
- 更新说明: 优化字幕和AI段落交互体验
  - 字幕列表滚动位置改为顶部对齐：当前播放字幕显示在列表顶部而非中心
  - AI段落元素完全支持点击跳转：整个段落区域都可点击，不仅限于时间按钮
  - 添加点击反馈动画：点击AI段落时显示视觉反馈效果
  - 增强当前播放字幕高亮：添加发光动画使其更明显
  - 优化滚动边距：顶部保留20px边距以改善视觉效果

---

## v1.0.5 (2025-10-22 17:44)
- 更新时间: 2025-10-22 17:44
- 更新类型: patch
- 更新说明: 移除AI总结加载中效果
  - 修复"正在生成总结..."一直显示的问题
  - 移除UIRenderer.js中的AI总结加载状态显示
  - 移除main.js中的加载状态插入逻辑
  - 移除AI图标的loading动画状态

---

## v1.0.4 (2025-10-22 17:33)
- 更新时间: 2025-10-22 17:33
- 更新类型: patch
- 更新说明: 字幕自动滚动功能完全重构
  - 创建独立的 SubtitleScrollManager 模块，解耦滚动管理逻辑
  - 删除 EventHandlers.js 和 SubtitleEventHandler.js 中的旧滚动代码
  - 实现更精准的自动跟随：始终将当前播放字幕居中显示
  - 改进用户滚动检测机制，避免误判
  - 优化滚动性能：200ms更新频率，更流畅的体验
  - 支持配置化：滚动行为、位置、检测延迟等均可配置

---

## v1.0.3 (2025-10-22 17:27)
- 更新时间: 2025-10-22 17:27
- 更新类型: patch
- 更新说明: 
  - 修复AIService.js缺少logger导入导致的ReferenceError错误
  - 修复UIRenderer.js缺少logger导入问题  
  - 修复markdown解析空代码块显示问题，自动清理空的```代码块
  - 改进parseMarkdown方法，正确处理代码块内容

---

## v1.0.2 (2025-10-22 17:21)
- 更新时间: 2025-10-22 17:21
- 更新类型: patch
- 更新说明: 修复字幕切换过快导致关闭失败的问题，将切换延迟从1秒增加到2秒

---

## v1.0.1 (2025-10-22 17:18)
- 更新时间: 2025-10-22 17:18
- 更新类型: patch
- 更新说明: 添加自动版本管理系统，实现版本号自动更新和历史记录

---
